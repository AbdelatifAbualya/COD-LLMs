<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Research Assistant</title>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Marked.js for Markdown parsing -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <!-- Highlight.js for code highlighting -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: {
              50: '#eef2ff',
              100: '#e0e7ff',
              200: '#c7d2fe',
              300: '#a5b4fc',
              400: '#818cf8',
              500: '#5686f5', // Primary accent color
              600: '#4f46e5',
              700: '#4338ca',
              800: '#3730a3',
              900: '#312e81',
              950: '#1e1b4b',
            },
            dark: {
              100: '#d1d5db',
              200: '#9ca3af',
              300: '#6b7280',
              400: '#4b5563',
              500: '#374151',
              600: '#1f2937',
              700: '#111827',
              800: '#0d1117',
              900: '#030712',
            }
          },
          fontFamily: {
            sans: ['Inter', 'ui-sans-serif', 'system-ui', 'sans-serif'],
            mono: ['JetBrains Mono', 'ui-monospace', 'monospace'],
          },
        }
      }
    };
  </script>

  <style>
    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    
    ::-webkit-scrollbar-track {
      background: rgb(20, 24, 33);
      border-radius: 8px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: rgba(86, 134, 245, 0.6);
      border-radius: 8px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: rgba(86, 134, 245, 0.8);
    }

    /* Streaming Indicator Animation */
    @keyframes typingAnimation {
      0% { border-right-color: rgba(86, 134, 245, 0.7); }
      100% { border-right-color: transparent; }
    }
    
    .streaming {
      border-right: 3px solid rgba(86, 134, 245, 0.7);
      animation: typingAnimation 0.8s infinite ease;
    }
    
    @keyframes ellipsisAnimation {
      0% { content: "."; }
      33% { content: ".."; }
      66% { content: "..."; }
      100% { content: "."; }
    }
    
    .streaming-indicator::after {
      content: "...";
      animation: ellipsisAnimation 1.5s infinite;
    }
  </style>
</head>
<body class="bg-dark-800 text-gray-100 font-sans min-h-screen">
  <div class="flex flex-col h-screen overflow-hidden">
    <!-- Header -->
    <header class="bg-dark-700 border-b border-dark-600 py-4 px-6">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-primary-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
          </svg>
          <h1 class="text-xl font-semibold">AI Research Assistant</h1>
        </div>
        
        <div class="flex items-center gap-3">
          <div id="currentModelDisplay" class="bg-dark-600 text-sm px-3 py-1.5 rounded-lg flex items-center">
            <span>DeepSeek V3</span>
            <span class="bg-green-900/60 text-green-400 text-xs ml-2 px-2 py-0.5 rounded-full">CoD-10</span>
          </div>
          <button id="settingsBtn" class="flex items-center gap-1.5 bg-dark-600 hover:bg-dark-500 text-gray-300 px-3 py-1.5 rounded-lg transition">
            <span>Settings</span>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
          </button>
          <button id="clearChatBtn" class="bg-red-600/20 hover:bg-red-600/30 text-red-400 px-3 py-1.5 rounded-lg transition">
            Clear Chat
          </button>
        </div>
      </div>
    </header>

    <!-- Chat Messages Area -->
    <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-6"></div>

    <!-- Input Area -->
    <div class="p-4 border-t border-dark-600 bg-dark-700">
      <div class="flex items-start gap-3 rounded-xl bg-dark-600 p-3 shadow-lg border border-dark-500 focus-within:border-primary-500 transition">
        <div class="flex-1">
          <textarea id="userInput" rows="1" class="w-full bg-dark-700 text-gray-100 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-primary-500 resize-none text-base" placeholder="Type your message..."></textarea>
        </div>
        <div class="flex flex-col gap-2 mt-1">
          <button id="sendBtn" class="bg-primary-500 hover:bg-primary-600 text-white p-3 rounded-lg transition">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd"></path>
            </svg>
          </button>
          <button id="researchBtn" class="bg-dark-500 hover:bg-dark-400 text-gray-300 p-2 rounded-lg transition" title="Research papers on this topic">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Research Modal -->
  <div id="researchModal" class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 hidden">
    <div class="bg-dark-700 rounded-xl shadow-2xl max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="p-5 border-b border-dark-600 flex justify-between items-center">
        <h2 class="text-xl font-semibold">Research Papers</h2>
        <button id="closeResearchModal" class="text-gray-400 hover:text-white">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <div class="p-5">
        <label for="researchSubject" class="block text-sm font-medium text-gray-300 mb-2">Research Topic:</label>
        <input type="text" id="researchSubject" class="w-full bg-dark-600 border border-dark-500 text-white rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-primary-500 mb-4" placeholder="Enter research subject (e.g., quantum computing)">
        
        <div id="researchStatus" class="hidden mb-4 p-3 bg-dark-600 rounded-lg text-center">
          <div class="flex justify-center items-center">
            <svg class="animate-spin h-5 w-5 text-primary-500 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span>Searching for research papers...</span>
          </div>
        </div>
        
        <button id="executeResearchBtn" class="w-full bg-primary-500 hover:bg-primary-600 text-white py-3 px-4 rounded-lg transition mt-2">
          Search for Papers
        </button>
        
        <button id="addToConversationBtn" class="w-full bg-dark-500 hover:bg-dark-400 text-gray-300 py-3 px-4 rounded-lg transition mt-2 hidden">
          Add Research to Conversation
        </button>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 hidden">
    <div class="bg-dark-700 rounded-xl shadow-2xl max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="p-5 border-b border-dark-600 flex justify-between items-center">
        <h2 class="text-xl font-semibold">Settings</h2>
        <button id="closeSettingsModal" class="text-gray-400 hover:text-white">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <div class="p-5">
        <h3 class="text-lg font-medium mb-4">Model & Reasoning</h3>
        
        <div class="space-y-4 mb-6">
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">LLM Model</label>
            <select id="modelSelect" class="w-full bg-dark-600 border border-dark-500 text-white rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-primary-500">
              <option value="accounts/fireworks/models/deepseek-v3" selected>DeepSeek V3</option>
              <option value="accounts/fireworks/models/deepseek-r1">DeepSeek R1 (Reasoner)</option>
            </select>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">Reasoning Method</label>
            <div class="space-y-2">
              <div class="flex items-center">
                <input type="radio" id="standardReasoning" name="reasoningMethod" value="standard" class="mr-2">
                <label for="standardReasoning">Standard</label>
              </div>
              <div class="flex items-center">
                <input type="radio" id="cotReasoning" name="reasoningMethod" value="cot" class="mr-2">
                <label for="cotReasoning">Chain of Thought (CoT)</label>
              </div>
              <div class="flex items-center">
                <input type="radio" id="codReasoning" name="reasoningMethod" value="cod" checked class="mr-2">
                <label for="codReasoning">Chain of Draft (CoD)</label>
              </div>
            </div>
          </div>
          
          <div id="codOptions">
            <label class="block text-sm font-medium text-gray-300 mb-2">Word Limit per Step</label>
            <div class="grid grid-cols-2 gap-2">
              <div class="bg-dark-600 border border-primary-500 p-2 rounded-lg text-center cursor-pointer" data-value="10">10 words</div>
              <div class="bg-dark-600 border border-dark-500 p-2 rounded-lg text-center cursor-pointer" data-value="15">15 words</div>
              <div class="bg-dark-600 border border-dark-500 p-2 rounded-lg text-center cursor-pointer" data-value="17">17 words</div>
              <div class="bg-dark-600 border border-dark-500 p-2 rounded-lg text-center cursor-pointer" data-value="20">20 words</div>
            </div>
          </div>
        </div>
        
        <h3 class="text-lg font-medium mb-4">Generation Parameters</h3>
        
        <div class="space-y-4 mb-6">
          <div>
            <div class="flex justify-between mb-1">
              <label for="temp" class="text-sm font-medium text-gray-300">Temperature</label>
              <span id="tempValue" class="text-sm text-gray-400">0.6</span>
            </div>
            <input type="range" id="temp" min="0" max="1" step="0.01" value="0.6" class="w-full">
          </div>
          
          <div>
            <div class="flex justify-between mb-1">
              <label for="maxTokens" class="text-sm font-medium text-gray-300">Max Tokens</label>
              <span id="maxTokensValue" class="text-sm text-gray-400">4008</span>
            </div>
            <input type="range" id="maxTokens" min="1" max="8192" step="128" value="4008" class="w-full">
          </div>
          
          <div class="flex items-center justify-between">
            <label for="streamingToggle" class="flex items-center cursor-pointer">
              <div class="font-medium text-sm">Enable Streaming Responses</div>
            </label>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="checkbox" id="streamingToggle" class="sr-only peer" checked>
              <div class="w-11 h-6 bg-dark-500 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary-600"></div>
            </label>
          </div>
        </div>
        
        <div class="flex justify-end gap-3 pt-4 mt-4 border-t border-dark-600">
          <button id="cancelSettings" class="px-4 py-2 bg-dark-600 hover:bg-dark-500 text-gray-300 rounded-lg transition">
            Cancel
          </button>
          <button id="saveSettings" class="px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg transition">
            Save Settings
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Status Notification -->
  <div id="statusNotification" class="fixed bottom-4 right-4 bg-dark-600 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 z-50"></div>

  <script>
    /***********************
     * Global Configuration
     ***********************/
    let MODEL_NAME = "accounts/fireworks/models/deepseek-v3";
    let MODEL_NAME_DISPLAY = "DeepSeek V3";
    let enableResearch = false;
    let currentResearchResults = null;
    
    // API endpoints
    const API_PROXY_URL = "/api/proxy";
    const RESEARCH_API_URL = "/api/abacus-research";
    
    // Reasoning Method
    let REASONING_METHOD = "cod"; // Options: "standard", "cot", "cod"
    
    // COD Word Limit
    let COD_WORD_LIMIT = 10;
    
    // Prompts for different reasoning methods
    let PROMPTS = {
      standard: "",
      
      cot: `Think step by step to solve this problem. Explain your reasoning at each step, then provide your final answer.`,
      
      cod: `Think step by step, but produce only minimal notes for each step (${COD_WORD_LIMIT} words maximum per step). Use mathematical notation where possible. Keep only essential information needed to solve the problem. Focus on key calculations and intermediate results without narrative explanation.

IMPORTANT: The word limit applies only to the reasoning steps. The final answer (including code or explanations) should be as detailed as needed and is NOT limited by the step word constraint.

Separate your steps with periods. Write your final answer after the #### separator.

Examples:
Q: Jason had 20 lollipops. He gave Denny some lollipops. Now Jason has 12 lollipops. How many lollipops did Jason give to Denny?
A: 20 initial. 12 remaining. 20 - 12 = 8. #### 8 lollipops

Q: A square has a perimeter of 20 cm. What is its area?
A: Perimeter = 20 cm. Side length = 20/4 = 5 cm. Area = 5Â² = 25 cmÂ². #### 25 square centimeters`
    };
    
    // Default generation parameters
    let TEMPERATURE = 0.6;
    let MAX_TOKENS = 4008;
    
    // Add streaming flag
    let ENABLE_STREAMING = true;
    
    /***********************
     * Message Management
     ***********************/
    let messages = [];
    
    function addMessage(content, sender, isPlaceholder = false) {
      messages.push({
        content,
        sender,
        isPlaceholder,
        timestamp: new Date()
      });
      
      renderMessages();
    }
    
    /***********************
     * Message Rendering
     ***********************/
    function transformMessage(content) {
      if (!content) return '';
      
      // Process markdown with marked.js if available
      if (typeof marked !== 'undefined') {
        return marked.parse(content);
      } else {
        // Simple markdown-like transformation for code blocks if marked is not available
        const transformed = content.replace(/```([\s\S]*?)```/g, (match, codeContent) => {
          let language = '';
          const lines = codeContent.split('\n');
          if (lines.length > 0 && !lines[0].includes(' ')) {
            language = lines[0].trim();
            lines.shift();
          }
          return `<pre><code class="${language}">${lines.join('\n')}</code></pre>`;
        });
        
        return transformed;
      }
    }
    
    function renderMessages() {
      const chatMessagesDiv = document.getElementById("chatMessages");
      if (!chatMessagesDiv) return;
      
      chatMessagesDiv.innerHTML = "";
      
      messages.forEach(msg => {
        // Create message container
        const messageDiv = document.createElement("div");
        
        // Apply different styling based on sender
        if (msg.sender === "user") {
          messageDiv.className = "flex justify-end";
          
          const msgContent = document.createElement("div");
          msgContent.className = "max-w-[90%] bg-primary-600 text-white p-4 rounded-2xl rounded-tr-sm shadow-md";
          
          // Format and set content
          msgContent.innerHTML = transformMessage(msg.content);
          messageDiv.appendChild(msgContent);
        } else {
          // Bot message
          messageDiv.className = "flex justify-start";
          
          const msgContent = document.createElement("div");
          msgContent.className = "max-w-[90%] bg-dark-700 border border-dark-500 p-4 rounded-2xl rounded-tl-sm shadow-md";
          
          // Handle placeholder messages
          if (msg.isPlaceholder) {
            msgContent.classList.add("opacity-70");
            msgContent.innerHTML = `<div class="flex items-center gap-2">
              <svg class="animate-spin h-4 w-4 text-primary-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              ${msg.content}
            </div>`;
          } else {
            // Regular message content
            msgContent.innerHTML = transformMessage(msg.content);
          }
          
          messageDiv.appendChild(msgContent);
        }
        
        chatMessagesDiv.appendChild(messageDiv);
      });
      
      // Scroll to the bottom
      chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
      
      // Add syntax highlighting to code blocks
      if (typeof hljs !== 'undefined') {
        document.querySelectorAll('pre code').forEach((block) => {
          hljs.highlightElement(block);
        });
      }
      
      // Add copy buttons to code blocks
      addCodeCopyButtons();
    }
    
    /***********************
     * Code Copy Feature
     ***********************/
    function addCodeCopyButtons() {
      const codeBlocks = document.querySelectorAll('pre code');
      codeBlocks.forEach(code => {
        // Skip if already has a copy button container
        if (code.parentElement.classList.contains('relative')) {
          return;
        }
        
        const pre = code.parentElement;
        
        // Create container div
        const container = document.createElement('div');
        container.className = 'relative mb-4 rounded-lg overflow-hidden';
        pre.parentNode.insertBefore(container, pre);
        container.appendChild(pre);
        
        // Add language badge if specified
        const codeClass = code.className;
        const language = codeClass.match(/language-([^\s]+)/)?.[1];
        if (language && language !== 'plaintext') {
          const langBadge = document.createElement('div');
          langBadge.className = 'absolute top-2 left-2 bg-dark-900/80 text-xs py-1 px-2 rounded text-gray-400';
          langBadge.textContent = language;
          container.appendChild(langBadge);
        }
        
        // Add styles to the pre element
        pre.className = 'bg-dark-900 rounded-lg p-4 overflow-x-auto text-sm';
        
        // Add copy button
        const copyBtn = document.createElement('button');
        copyBtn.className = 'absolute top-2 right-2 bg-dark-900/80 text-gray-400 hover:text-white text-xs py-1 px-2 rounded transition-colors';
        copyBtn.textContent = 'Copy';
        copyBtn.addEventListener('click', () => {
          navigator.clipboard.writeText(code.textContent || '')
            .then(() => {
              copyBtn.textContent = 'Copied!';
              copyBtn.classList.add('text-green-400');
              setTimeout(() => {
                copyBtn.textContent = 'Copy';
                copyBtn.classList.remove('text-green-400');
              }, 2000);
            })
            .catch(() => {
              copyBtn.textContent = 'Failed';
              copyBtn.classList.add('text-red-400');
              setTimeout(() => {
                copyBtn.textContent = 'Copy';
                copyBtn.classList.remove('text-red-400');
              }, 2000);
            });
        });
        
        container.appendChild(copyBtn);
      });
    }
    
    /***********************
     * API Communication
     ***********************/
    function buildMessagesForChat() {
      const messageArray = [];
      
      // Add system prompt based on reasoning method
      if (REASONING_METHOD !== "standard") {
        messageArray.push({
          role: "system",
          content: PROMPTS[REASONING_METHOD]
        });
      }
      
      // Add conversation history
      messages.filter(msg => !msg.isPlaceholder).forEach(msg => {
        messageArray.push({
          role: msg.sender === "user" ? "user" : "assistant",
          content: msg.content
        });
      });
      
      return messageArray;
    }
    
    async function sendMessage(message) {
      if (!message.trim()) return;
      
      // Add user message to chat
      addMessage(message, "user");
      
      // Add placeholder message showing we're thinking
      addMessage("Thinking...", "bot", true);
      
      try {
        // Build messages array with current settings
        const messagesForApi = buildMessagesForChat();
        
        // Create payload for API request
        const payload = {
          model: MODEL_NAME,
          messages: messagesForApi,
          temperature: TEMPERATURE,
          max_tokens: MAX_TOKENS,
          stream: ENABLE_STREAMING
        };
        
        // Add timestamp to URL to prevent caching
        const timestamp = new Date().getTime();
        const cacheBuster = `?t=${timestamp}`;
        
        const response = await fetch(`${API_PROXY_URL}${cacheBuster}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        
        if (!response.ok) {
          throw new Error(`API Error: ${response.status}`);
        }
        
        const data = await response.json();
        const botReply = data.choices && 
                        data.choices[0] && 
                        data.choices[0].message && 
                        data.choices[0].message.content;
        
        if (botReply) {
          // Replace the placeholder with the actual response
          messages[messages.length - 1] = {
            content: botReply.trim(),
            sender: "bot",
            isPlaceholder: false,
            timestamp: new Date()
          };
          
          renderMessages();
        } else {
          throw new Error("No valid response from API");
        }
      } catch (error) {
        console.error("Error:", error);
        
        // Update placeholder with error message
        messages[messages.length - 1] = {
          content: `Error: ${error.message}`,
          sender: "bot",
          isPlaceholder: false,
          timestamp: new Date()
        };
        
        renderMessages();
      }
    }
    
    /***********************
     * Research Functions
     ***********************/
    function toggleResearch() {
      enableResearch = !enableResearch;
      
      const researchBtn = document.getElementById('researchBtn');
      if (researchBtn) {
        if (enableResearch) {
          researchBtn.classList.add('bg-primary-500', 'text-white');
          researchBtn.classList.remove('bg-dark-500', 'text-gray-300');
          
          // Open research modal
          openResearchModal();
        } else {
          researchBtn.classList.remove('bg-primary-500', 'text-white');
          researchBtn.classList.add('bg-dark-500', 'text-gray-300');
        }
      }
      
      showNotification(enableResearch ? 'Research mode enabled' : 'Research mode disabled');
    }

    function openResearchModal() {
      const researchModal = document.getElementById('researchModal');
      if (researchModal) {
        researchModal.style.display = 'flex';
        
        // Focus on the input field
        setTimeout(() => {
          const researchInput = document.getElementById('researchSubject');
          if (researchInput) {
            researchInput.focus();
          }
        }, 100);
      }
    }
    
    function closeResearchModal() {
      const researchModal = document.getElementById('researchModal');
      if (researchModal) {
        researchModal.style.display = 'none';
      }
    }
    
    async function executeResearch() {
      const subjectInput = document.getElementById('researchSubject');
      const statusDiv = document.getElementById('researchStatus');
      const executeBtn = document.getElementById('executeResearchBtn');
      const addToConversationBtn = document.getElementById('addToConversationBtn');
      
      if (!subjectInput || !statusDiv || !executeBtn) return;
      
      const subject = subjectInput.value.trim();
      
      if (!subject) {
        showNotification('Please enter a research subject');
        return;
      }
      
      try {
        // Show status and disable button
        statusDiv.classList.remove('hidden');
        executeBtn.disabled = true;
        executeBtn.textContent = 'Searching...';
        
        // Hide the add to conversation button while searching
        if (addToConversationBtn) {
          addToConversationBtn.classList.add('hidden');
        }
        
        // Call the Abacus.AI API through our serverless function
        const response = await fetch(RESEARCH_API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            query: subject
          })
        });
        
        if (!response.ok) {
          let errorText = 'Error fetching research papers';
          try {
            const errorData = await response.json();
            errorText = errorData.error || errorText;
          } catch (e) {
            console.error('Could not parse error response:', e);
          }
          throw new Error(errorText);
        }
        
        const data = await response.json();
        currentResearchResults = data.research_papers;
        
        // Show the add to conversation button
        if (addToConversationBtn) {
          addToConversationBtn.classList.remove('hidden');
        }
        
        showNotification('Research completed successfully');
      } catch (error) {
        console.error('Research error:', error);
        showNotification('Error: ' + error.message);
        currentResearchResults = null;
      } finally {
        // Hide status and re-enable button
        statusDiv.classList.add('hidden');
        executeBtn.disabled = false;
        executeBtn.textContent = 'Search for Papers';
      }
    }
    
    function addResearchToConversation() {
      if (!currentResearchResults) {
        showNotification('No research results to add');
        return;
      }
      
      const subject = document.getElementById('researchSubject')?.value.trim() || 'the requested topic';
      
      // Add a user message indicating the research request
      addMessage(`Please provide research papers on ${subject}`, "user");
      
      // Add the research results as a bot message
      addMessage(currentResearchResults, "bot");
      
      // Close the modal
      closeResearchModal();
      
      // Reset research mode
      enableResearch = false;
      const researchBtn = document.getElementById('researchBtn');
      if (researchBtn) {
        researchBtn.classList.remove('bg-primary-500', 'text-white');
        researchBtn.classList.add('bg-dark-500', 'text-gray-300');
      }
    }
    
    /***********************
     * Settings Functions
     ***********************/
    function openSettingsModal() {
      // Update settings UI with current values
      const modelSelect = document.getElementById('modelSelect');
      if (modelSelect) modelSelect.value = MODEL_NAME;
      
      const reasoningRadio = document.getElementById(`${REASONING_METHOD}Reasoning`);
      if (reasoningRadio) reasoningRadio.checked = true;
      
      const tempSlider = document.getElementById('temp');
      const tempValue = document.getElementById('tempValue');
      if (tempSlider) tempSlider.value = TEMPERATURE;
      if (tempValue) tempValue.textContent = TEMPERATURE;
      
      const maxTokensSlider = document.getElementById('maxTokens');
      const maxTokensValue = document.getElementById('maxTokensValue');
      if (maxTokensSlider) maxTokensSlider.value = MAX_TOKENS;
      if (maxTokensValue) maxTokensValue.textContent = MAX_TOKENS;
      
      const streamingToggle = document.getElementById('streamingToggle');
      if (streamingToggle) streamingToggle.checked = ENABLE_STREAMING;
      
      // Show CoD options if CoD is selected
      updateCodOptionsVisibility();
      
      // Show modal
      const modal = document.getElementById("settingsModal");
      if (modal) modal.style.display = "flex";
    }
    
    function closeSettingsModal() {
      const modal = document.getElementById("settingsModal");
      if (modal) modal.style.display = "none";
    }
    
    function updateCodOptionsVisibility() {
      const codOptions = document.getElementById('codOptions');
      const codReasoning = document.getElementById('codReasoning');
      
      if (codOptions && codReasoning) {
        if (codReasoning.checked) {
          codOptions.style.display = 'block';
        } else {
          codOptions.style.display = 'none';
        }
      }
    }
    
    function saveSettings() {
      // Get model
      const modelSelect = document.getElementById('modelSelect');
      if (modelSelect) {
        MODEL_NAME = modelSelect.value;
        MODEL_NAME_DISPLAY = modelSelect.options[modelSelect.selectedIndex].text;
      }
      
      // Get reasoning method
      const reasoningRadios = document.getElementsByName('reasoningMethod');
      for (const radio of reasoningRadios) {
        if (radio.checked) {
          REASONING_METHOD = radio.value;
          break;
        }
      }
      
      // Get CoD word limit if applicable
      if (REASONING_METHOD === 'cod') {
        const selectedOption = document.querySelector('#codOptions [data-value].border-primary-500');
        if (selectedOption) {
          COD_WORD_LIMIT = parseInt(selectedOption.getAttribute('data-value'));
          
          // Update CoD prompt
          PROMPTS.cod = PROMPTS.cod.replace(/\(\d+ words maximum per step\)/, `(${COD_WORD_LIMIT} words maximum per step)`);
        }
      }
      
      // Get temperature
      const tempSlider = document.getElementById('temp');
      if (tempSlider) TEMPERATURE = parseFloat(tempSlider.value);
      
      // Get max tokens
      const maxTokensSlider = document.getElementById('maxTokens');
      if (maxTokensSlider) MAX_TOKENS = parseInt(maxTokensSlider.value);
      
      // Get streaming setting
      const streamingToggle = document.getElementById('streamingToggle');
      if (streamingToggle) ENABLE_STREAMING = streamingToggle.checked;
      
      // Update model display
      const modelDisplay = document.getElementById('currentModelDisplay');
      if (modelDisplay) {
        let badgeText = "Standard";
        let badgeClass = "bg-gray-600 text-gray-300";
        
        if (REASONING_METHOD === "cod") {
          badgeText = `CoD-${COD_WORD_LIMIT}`;
          badgeClass = "bg-green-900/60 text-green-400";
        } else if (REASONING_METHOD === "cot") {
          badgeText = "CoT";
          badgeClass = "bg-indigo-900/60 text-indigo-400";
        }
        
        modelDisplay.innerHTML = `<span>${MODEL_NAME_DISPLAY}</span><span class="${badgeClass} text-xs ml-2 px-2 py-0.5 rounded-full">${badgeText}</span>`;
      }
      
      closeSettingsModal();
      showNotification('Settings saved');
    }
    
    /***********************
     * Notification Function
     ***********************/
    function showNotification(message, duration = 3000) {
      const notification = document.getElementById("statusNotification");
      if (!notification) return;
      
      notification.textContent = message;
      notification.style.opacity = "1";
      
      setTimeout(() => {
        notification.style.opacity = "0";
      }, duration);
    }
    
    /***********************
     * Initialization
     ***********************/
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize event listeners
      const sendBtn = document.getElementById('sendBtn');
      const userInput = document.getElementById('userInput');
      
      // Send button
      if (sendBtn) {
        sendBtn.addEventListener('click', () => {
          if (userInput) {
            const message = userInput.value.trim();
            if (message) {
              sendMessage(message);
              userInput.value = '';
              userInput.style.height = 'auto';
            }
          }
        });
      }
      
      // Message input
      if (userInput) {
        userInput.addEventListener('input', () => {
          // Auto-resize textarea based on content
          userInput.style.height = 'auto';
          userInput.style.height = (userInput.scrollHeight) + 'px';
        });
        
        userInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            document.getElementById('sendBtn')?.click();
          }
        });
      }
      
      // Research button
      const researchBtn = document.getElementById('researchBtn');
      if (researchBtn) {
        researchBtn.addEventListener('click', toggleResearch);
      }
      
      // Research modal
      const closeResearchModalBtn = document.getElementById('closeResearchModal');
      if (closeResearchModalBtn) {
        closeResearchModalBtn.addEventListener('click', closeResearchModal);
      }
      
      const executeResearchBtn = document.getElementById('executeResearchBtn');
      if (executeResearchBtn) {
        executeResearchBtn.addEventListener('click', executeResearch);
      }
      
      const addToConversationBtn = document.getElementById('addToConversationBtn');
      if (addToConversationBtn) {
        addToConversationBtn.addEventListener('click', addResearchToConversation);
      }
      
      // Settings button
      const settingsBtn = document.getElementById('settingsBtn');
      if (settingsBtn) {
        settingsBtn.addEventListener('click', openSettingsModal);
      }
      
      // Settings modal
      const closeSettingsModalBtn = document.getElementById('closeSettingsModal');
      if (closeSettingsModalBtn) {
        closeSettingsModalBtn.addEventListener('click', closeSettingsModal);
      }
      
      const saveSettingsBtn = document.getElementById('saveSettings');
      if (saveSettingsBtn) {
        saveSettingsBtn.addEventListener('click', saveSettings);
      }
      
      const cancelSettingsBtn = document.getElementById('cancelSettings');
      if (cancelSettingsBtn) {
        cancelSettingsBtn.addEventListener('click', closeSettingsModal);
      }
      
      // Reasoning method radios
      const reasoningRadios = document.getElementsByName('reasoningMethod');
      for (const radio of reasoningRadios) {
        radio.addEventListener('change', updateCodOptionsVisibility);
      }
      
      // CoD word limit options
      const codWordLimitOptions = document.querySelectorAll('#codOptions [data-value]');
      codWordLimitOptions.forEach(option => {
        option.addEventListener('click', () => {
          codWordLimitOptions.forEach(opt => {
            opt.classList.remove('border-primary-500');
            opt.classList.add('border-dark-500');
          });
          option.classList.add('border-primary-500');
          option.classList.remove('border-dark-500');
        });
      });
      
      // Sliders
      const tempSlider = document.getElementById('temp');
      const tempValue = document.getElementById('tempValue');
      if (tempSlider && tempValue) {
        tempSlider.addEventListener('input', () => {
          tempValue.textContent = tempSlider.value;
        });
      }
      
      const maxTokensSlider = document.getElementById('maxTokens');
      const maxTokensValue = document.getElementById('maxTokensValue');
      if (maxTokensSlider && maxTokensValue) {
        maxTokensSlider.addEventListener('input', () => {
          maxTokensValue.textContent = maxTokensSlider.value;
        });
      }
      
      // Clear chat button
      const clearChatBtn = document.getElementById('clearChatBtn');
      if (clearChatBtn) {
        clearChatBtn.addEventListener('click', () => {
          if (confirm('Are you sure you want to clear the chat?')) {
            messages = [];
            renderMessages();
            showNotification('Chat cleared');
          }
        });
      }
      
      // Add welcome message
      addMessage("Hi there! I'm your AI Research Assistant powered by DeepSeek V3. I can help with general questions and research tasks. Click the research button (ðŸ“š) to search for academic papers on any topic.", "bot");
    });
  </script>
</body>
</html>
