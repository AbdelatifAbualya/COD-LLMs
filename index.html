<!DOCTYPE html><html lang="en" class="dark"><head><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reasoning Studio - CoT vs CoD</title>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&amp;family=JetBrains+Mono:wght@400;500&amp;display=swap" rel="stylesheet">
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Marked.js for Markdown parsing -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <!-- Highlight.js for code highlighting -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
  <!-- jsPDF for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: {
              50: '#eef2ff',
              100: '#e0e7ff',
              200: '#c7d2fe',
              300: '#a5b4fc',
              400: '#818cf8',
              500: '#5686f5', // Primary accent color
              600: '#4f46e5',
              700: '#4338ca',
              800: '#3730a3',
              900: '#312e81',
              950: '#1e1b4b',
            },
            dark: {
              100: '#d1d5db',
              200: '#9ca3af',
              300: '#6b7280',
              400: '#4b5563',
              500: '#374151',
              600: '#1f2937',
              700: '#111827',
              800: '#0d1117',
              900: '#030712',
            }
          },
          fontFamily: {
            sans: ['Inter', 'ui-sans-serif', 'system-ui', 'sans-serif'],
            mono: ['JetBrains Mono', 'ui-monospace', 'monospace'],
          },
        }
      }
    };
  </script>

  <style>
    /* Base Styles */
    :root {
      --primary: #5686f5;
      --primary-hover: #4169e1;
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
    }
    
    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    
    ::-webkit-scrollbar-track {
      background: rgb(30, 34, 43); /* Lighter track color */
      border-radius: 8px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: rgba(86, 134, 245, 0.6);
      border-radius: 8px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: rgba(86, 134, 245, 0.8);
    }

    /* Thinking Steps Animation */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .thinking-steps {
      animation: fadeIn 0.3s ease;
    }
    
    /* Reflection Step Animation */
    @keyframes reflectionPulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    .reflection-step .step-number {
      animation: reflectionPulse 2s infinite;
    }
    
    /* Streaming Indicator Animation */
    @keyframes typingAnimation {
      0% { border-right-color: rgba(86, 134, 245, 0.7); }
      100% { border-right-color: transparent; }
    }
    
    .streaming {
      border-right: 3px solid rgba(86, 134, 245, 0.7);
      animation: typingAnimation 0.8s infinite ease;
    }
    
    @keyframes ellipsisAnimation {
      0% { content: "."; }
      33% { content: ".."; }
      66% { content: "..."; }
      100% { content: "."; }
    }
    
    .streaming-indicator::after {
      content: "...";
      animation: ellipsisAnimation 1.5s infinite;
    }

    /* Tooltip Styling */
    .tooltip {
      position: relative;
      display: inline-block;
    }
    
    .tooltip .tooltip-text {
      visibility: hidden;
      width: 200px;
      background-color: rgb(30, 41, 59);
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 8px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -100px;
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 0.75rem;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }
    
    .tooltip:hover .tooltip-text {
      visibility: visible;
      opacity: 1;
    }

    /* Range Slider Styling */
    input[type="range"] {
      -webkit-appearance: none;
      width: 100%;
      height: 4px;
      background: #1f2937;
      border-radius: 4px;
      outline: none;
      background: linear-gradient(to right, var(--primary) var(--value-percent, 50%), #1f2937 var(--value-percent, 50%)) !important;
    }
    
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      background: white !important;
      border-radius: 50%;
      cursor: pointer;
      border: 1px solid rgba(0, 0, 0, 0.1) !important;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      margin-top: -6px;
    }
  </style>
</head>
<body class="bg-dark-800 text-gray-100 font-sans min-h-screen overflow-hidden">
  <div class="flex h-screen">
    <!-- Sidebar -->
    <div class="w-72 bg-dark-700 border-r border-dark-600 flex flex-col p-4 overflow-y-auto hidden md:flex">
      <h2 class="text-xl font-semibold mb-4">Threads</h2>
      <ul id="threadList" class="flex-1 space-y-1 mb-4">
        <li class="bg-dark-600 text-primary-300 px-3 py-2 rounded-md cursor-pointer hover:bg-dark-500 transition">Thread 1</li>
      </ul>
      <div class="space-y-2">
        <button id="newThreadBtn" class="w-full bg-primary-500 hover:bg-primary-600 text-white py-2 px-4 rounded-md transition flex items-center justify-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
          </svg>
          New Thread
        </button>
        <button id="deleteThreadBtn" class="w-full bg-dark-600 hover:bg-dark-500 text-gray-300 py-2 px-4 rounded-md transition">Delete Thread</button>
        <button id="downloadTxtBtn" class="w-full bg-dark-600 hover:bg-dark-500 text-gray-300 py-2 px-4 rounded-md transition">Download TXT</button>
        <button id="downloadPdfBtn" class="w-full bg-dark-600 hover:bg-dark-500 text-gray-300 py-2 px-4 rounded-md transition">Download PDF</button>
        <button id="clearThreadBtn" class="w-full bg-red-600/20 hover:bg-red-600/30 text-red-400 py-2 px-4 rounded-md transition">Clear Thread</button>
        <button id="openFeedbackBtn" class="w-full bg-dark-600 hover:bg-dark-500 text-gray-300 py-2 px-4 rounded-md transition flex items-center justify-center gap-2">
          <span>💬</span>
          Feedback
        </button>
      </div>
    </div>

    <!-- Mobile Sidebar Toggle -->
    <div id="mobileSidebarToggle" class="fixed left-4 top-4 bg-dark-700 p-2 rounded-md shadow-lg z-20 md:hidden">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
      </svg>
    </div>

    <!-- Mobile Sidebar -->
    <div id="mobileSidebar" class="fixed inset-0 bg-dark-800 z-30 transform -translate-x-full transition-transform duration-300 md:hidden">
      <div class="w-full h-full flex flex-col">
        <div class="flex justify-between items-center p-4 border-b border-dark-600">
          <h2 class="text-xl font-semibold">Threads</h2>
          <button id="closeMobileSidebar" class="p-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
        <div class="flex-1 p-4 overflow-y-auto">
          <ul id="mobileThreadList" class="space-y-2 mb-4">
            <li class="bg-dark-600 text-primary-300 px-3 py-2 rounded-md cursor-pointer hover:bg-dark-500 transition">Thread 1</li>
          </ul>
          <div class="space-y-2">
            <button id="mobileNewThreadBtn" class="w-full bg-primary-500 hover:bg-primary-600 text-white py-2 px-4 rounded-md transition flex items-center justify-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
              </svg>
              New Thread
            </button>
            <button id="mobileDeleteThreadBtn" class="w-full bg-dark-600 hover:bg-dark-500 text-gray-300 py-2 px-4 rounded-md transition">Delete Thread</button>
            <button id="mobileDownloadTxtBtn" class="w-full bg-dark-600 hover:bg-dark-500 text-gray-300 py-2 px-4 rounded-md transition">Download TXT</button>
            <button id="mobileDownloadPdfBtn" class="w-full bg-dark-600 hover:bg-dark-500 text-gray-300 py-2 px-4 rounded-md transition">Download PDF</button>
            <button id="mobileClearThreadBtn" class="w-full bg-red-600/20 hover:bg-red-600/30 text-red-400 py-2 px-4 rounded-md transition">Clear Thread</button>
            <button id="mobileOpenFeedbackBtn" class="w-full bg-dark-600 hover:bg-dark-500 text-gray-300 py-2 px-4 rounded-md transition flex items-center justify-center gap-2">
              <span>💬</span>
              Feedback
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content Area -->
    <div class="flex-1 flex flex-col overflow-hidden">
      <!-- Header -->
      <header class="bg-dark-700 border-b border-dark-600 h-16 flex items-center justify-between px-4 md:px-6">
        <h1 id="pageTitle" class="text-xl font-semibold">Reasoning Studio</h1>
        <div class="flex items-center gap-3">
          <div id="currentModelDisplay" class="bg-dark-600 text-sm px-3 py-1.5 rounded-lg flex items-center">
            <span>llama-3.3-70b</span>
            <span class="bg-green-900/60 text-green-400 text-xs ml-2 px-2 py-0.5 rounded-full">Adaptive</span>
          </div>
          <button id="openSettings" class="flex items-center gap-1.5 bg-dark-600 hover:bg-dark-500 text-gray-300 px-3 py-1.5 rounded-lg transition">
            <span>Settings</span>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
          </button>
        </div>
      </header>

      <!-- Chat Messages Area -->
      <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-6"></div>

      <!-- Input Area -->
      <div class="p-4 border-t border-dark-600 bg-dark-700">
        <div class="flex items-start gap-3 rounded-xl bg-dark-600 p-3 shadow-lg border border-dark-500 focus-within:border-primary-500 transition">
          <div class="flex-1">
            <textarea id="userInput" rows="1" class="w-full bg-dark-700 text-gray-100 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-primary-500 resize-none text-base" placeholder="Type your message..."></textarea>
          </div>
          <div class="flex flex-col gap-2 mt-1">
            <button id="sendBtn" class="bg-primary-500 hover:bg-primary-600 text-white p-3 rounded-lg transition">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"></path>
              </svg>
            </button>
            <label for="fileInput" class="bg-dark-500 hover:bg-dark-400 text-gray-300 p-2 rounded-lg cursor-pointer transition">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path>
              </svg>
            </label>
            <button id="webSearchBtn" class="bg-dark-500 hover:bg-dark-400 text-gray-300 p-2 rounded-lg transition">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
              </svg>
            </button>
          </div>
        </div>
        <input type="file" id="fileInput" class="hidden" multiple="">
        <div id="attachedFiles" class="mt-3 flex flex-wrap gap-3 hidden"></div>
      </div>
    </div>
  </div>

  <!-- Status Notification -->
  <div id="statusNotification" class="fixed bottom-4 right-4 bg-dark-600 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 z-50"></div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 hidden">
    <div class="bg-dark-700 rounded-xl shadow-2xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="p-5 border-b border-dark-600 flex justify-between items-center">
        <h2 class="text-xl font-semibold">Settings</h2>
        <button id="closeModalX" class="text-gray-400 hover:text-white">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <div class="p-5">
        <!-- Tab Navigation -->
        <div class="bg-dark-600 rounded-lg p-1 flex mb-5">
          <button class="tab-btn flex-1 py-2 px-4 rounded-md text-gray-400 transition" data-tab="modelTab">Model</button>
          <button class="tab-btn flex-1 py-2 px-4 rounded-md text-gray-400 transition" data-tab="reasoningTab">Reasoning</button>
          <button class="tab-btn flex-1 py-2 px-4 rounded-md text-white bg-primary-500" data-tab="parametersTab">Parameters</button>
        </div>
        
        <!-- Model Tab Content -->
        <div id="modelTab" class="tab-content hidden">
          <h3 class="text-lg font-medium mb-4 pb-2 border-b border-dark-600">Model Selection</h3>
          
          <label class="block text-sm font-medium text-gray-300 mb-2">Select Language Model</label>
          <div class="relative mb-5">
            <select id="modelSelect" class="w-full bg-dark-600 border border-dark-500 text-white rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-primary-500 appearance-none">
              <option value="" disabled="">Choose a model...</option>
              <option value="accounts/fireworks/models/llama-v3p3-70b" selected="">Llama-3 70B</option>
              <option value="accounts/fireworks/models/deepseek-v3">DeepSeek V3</option>
              <option value="accounts/fireworks/models/deepseek-r1">DeepSeek R1 (Reasoner)</option>
              <option value="accounts/fireworks/models/llama4-maverick-instruct-basic">Llama4 Maverick</option>
              <option value="accounts/fireworks/models/llama4-scout-instruct-basic">Llama4 Scout</option>
            </select>
            <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
              <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </div>
          </div>
          
          <div id="modelInfoCard" class="bg-dark-600 rounded-lg p-4 border border-dark-500 mb-5 hidden">
            <div class="font-medium text-lg mb-3" id="selectedModelName">Llama-3 70B</div>
            <div class="flex flex-wrap gap-2 mb-3" id="modelTags">
              <span class="bg-primary-500/20 text-primary-300 text-xs px-2 py-1 rounded-full">Latest</span>
              <span class="bg-primary-500/20 text-primary-300 text-xs px-2 py-1 rounded-full">Versatile</span>
              <span class="bg-primary-500/20 text-primary-300 text-xs px-2 py-1 rounded-full">Chat</span>
            </div>
            <p class="text-gray-400 text-sm" id="modelDescription">
              Meta's latest model with strong performance across a wide range of tasks.
            </p>
          </div>
          
          <button id="setModelBtn" class="w-full bg-primary-500 hover:bg-primary-600 text-white py-3 px-4 rounded-lg transition mt-4">
            Set Model
          </button>
        </div>
        
        <!-- Reasoning Tab Content -->
        <div id="reasoningTab" class="tab-content hidden">
          <h3 class="text-lg font-medium mb-4 pb-2 border-b border-dark-600">Reasoning Method</h3>
          
          <div class="bg-dark-600 border border-dark-500 rounded-lg p-4 mb-5">
            <div class="space-y-3">
              <div class="flex items-start">
                <input type="radio" id="standardReasoning" name="reasoningMethod" value="standard" class="w-4 h-4 mt-1 text-primary-500 bg-dark-500 border-dark-400 focus:ring-primary-500 focus:ring-offset-dark-700">
                <label for="standardReasoning" class="ml-3 block text-sm font-medium text-white">
                  Standard (No special prompt)
                  <div class="text-gray-400 text-xs mt-1">Default model behavior with no special reasoning instructions.</div>
                </label>
              </div>
              
              <div class="flex items-start">
                <input type="radio" id="cotReasoning" name="reasoningMethod" value="cot" class="w-4 h-4 mt-1 text-primary-500 bg-dark-500 border-dark-400 focus:ring-primary-500 focus:ring-offset-dark-700">
                <label for="cotReasoning" class="ml-3 block text-sm font-medium text-white">
                  Chain of Thought (CoT)
                  <div class="text-gray-400 text-xs mt-1">Instructs the model to think step-by-step to solve problems. Improves reasoning but uses more tokens.</div>
                </label>
              </div>
              
              <div class="flex items-start">
                <input type="radio" id="codReasoning" name="reasoningMethod" value="cod" checked="" class="w-4 h-4 mt-1 text-primary-500 bg-dark-500 border-dark-400 focus:ring-primary-500 focus:ring-offset-dark-700">
                <label for="codReasoning" class="ml-3 block text-sm font-medium text-white">
                  Chain of Draft (CoD)
                  <div class="text-gray-400 text-xs mt-1">Uses minimal words per step to reduce token usage while maintaining reasoning quality.</div>
                </label>
              </div>
            </div>
          </div>
          
          <!-- COD Word Limit options -->
          <div id="codOptions" class="mb-5">
            <h4 class="text-sm font-medium text-gray-300 mb-2">Word limit per step:</h4>
            <div class="space-y-2">
              <div class="cod-word-limit-option bg-dark-600 border border-primary-500 rounded-lg p-3 cursor-pointer" data-value="5">
                <div class="flex justify-between items-center">
                  <span class="font-medium">5 words</span>
                  <span class="bg-primary-500/20 text-primary-300 text-xs px-2 py-1 rounded-full">Paper Standard</span>
                </div>
                <p class="text-xs text-gray-400 mt-1">Original paper recommendation</p>
              </div>
              
              <div class="cod-word-limit-option bg-dark-600 border border-dark-500 hover:border-primary-400 rounded-lg p-3 cursor-pointer" data-value="10">
                <div class="flex justify-between items-center">
                  <span class="font-medium">10 words</span>
                </div>
                <p class="text-xs text-gray-400 mt-1">Balanced brevity and clarity</p>
              </div>
              
              <div class="cod-word-limit-option bg-dark-600 border border-dark-500 hover:border-primary-400 rounded-lg p-3 cursor-pointer" data-value="15">
                <div class="flex justify-between items-center">
                  <span class="font-medium">15 words</span>
                </div>
                <p class="text-xs text-gray-400 mt-1">More descriptive steps</p>
              </div>
              
              <div class="cod-word-limit-option bg-dark-600 border border-dark-500 hover:border-primary-400 rounded-lg p-3 cursor-pointer" data-value="17">
                <div class="flex justify-between items-center">
                  <span class="font-medium">17 words</span>
                </div>
                <p class="text-xs text-gray-400 mt-1">Better for complex reasoning</p>
              </div>
              
              <div class="cod-word-limit-option bg-dark-600 border border-dark-500 hover:border-primary-400 rounded-lg p-3 cursor-pointer" data-value="20">
                <div class="flex justify-between items-center">
                  <span class="font-medium">20 words</span>
                </div>
                <p class="text-xs text-gray-400 mt-1">Detailed steps for math &amp; logic</p>
              </div>
            </div>
            
            <div class="mt-5 bg-dark-600 border border-dark-500 rounded-lg p-4">
              <h5 class="font-medium text-sm mb-2 pb-2 border-b border-dark-500">Chain of Draft Example</h5>
              <div class="mt-3 space-y-2">
                <div class="text-gray-400 text-sm">Q: If a fabric store received 45 yards of cotton and used 2/9 of it, how many yards remain?</div>
                <div class="text-primary-300 font-mono text-sm">A: Total: 45 yards. Used: 2/9 × 45 = 10 yards. Remaining: 45 - 10 = 35 yards. #### 35 yards</div>
              </div>
            </div>
          </div>
          
          <!-- Enhanced Reasoning Options -->
          <div class="flex justify-between items-center mb-4 mt-6 pb-2 border-b border-dark-600">
            <h3 class="text-lg font-medium">Advanced Reasoning Options</h3>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="checkbox" id="enhancedReasoningToggle" class="sr-only peer" checked="">
              <div class="w-11 h-6 bg-dark-500 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary-600"></div>
            </label>
          </div>
          
          <div id="enhancedReasoningOptions" class="bg-dark-600 border border-dark-500 rounded-lg p-4 mb-5">
            <div class="flex items-start mb-3">
              <input type="radio" id="adaptiveReasoning" name="reasoningEnhancement" value="adaptive" checked="" class="w-4 h-4 mt-1 text-primary-500 bg-dark-500 border-dark-400 focus:ring-primary-500 focus:ring-offset-dark-700">
              <label for="adaptiveReasoning" class="ml-3 block text-sm font-medium text-white">
                Adaptive Reasoning
                <span class="ml-2 inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-primary-900/30 text-primary-300">
                  <span class="mr-1 w-1.5 h-1.5 rounded-full bg-primary-400"></span>
                  Auto
                </span>
                <div class="text-gray-400 text-xs mt-1">Automatically increases reasoning depth for complex problems.</div>
              </label>
            </div>
            
            <div class="flex items-start">
              <input type="radio" id="standardReasoningEnhancement" name="reasoningEnhancement" value="standard" class="w-4 h-4 mt-1 text-primary-500 bg-dark-500 border-dark-400 focus:ring-primary-500 focus:ring-offset-dark-700">
              <label for="standardReasoningEnhancement" class="ml-3 block text-sm font-medium text-white">
                Fixed Reasoning Depth
                <div class="text-gray-400 text-xs mt-1">Uses the same reasoning approach for all problems regardless of complexity.</div>
              </label>
            </div>
            
            <div class="mt-4 bg-dark-700 rounded-lg p-4">
              <div class="flex items-center text-primary-300 text-sm font-medium mb-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                </svg>
                Problem Complexity Detection
              </div>
              <div class="text-gray-400 text-xs">
                When adaptive reasoning is enabled, the system will automatically analyze your questions to detect:
                <ul class="list-disc list-inside mt-2 space-y-1">
                  <li>Mathematical expressions and calculations</li>
                  <li>Multi-step reasoning requirements</li>
                  <li>Logical dependencies and constraints</li>
                  <li>Complex or abstract concepts</li>
                </ul>
                <p class="mt-2">For complex problems, the model will use more detailed reasoning steps even with CoD.</p>
              </div>
            </div>
          </div>
          
          <!-- Self-Reflection Options -->
          <div class="flex justify-between items-center mb-4 pb-2 border-b border-dark-600">
            <h3 class="text-lg font-medium">Self-Reflection for Chain of Draft</h3>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="checkbox" id="selfReflectionToggle" class="sr-only peer" checked="">
              <div class="w-11 h-6 bg-dark-500 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary-600"></div>
            </label>
          </div>
          
          <div id="selfReflectionInfo" class="bg-dark-600 border border-dark-500 rounded-lg p-4 mb-5">
            <p class="text-gray-400 text-sm mb-3">
              Adds a reflection step after reasoning to help the model verify its own work and catch mistakes.
            </p>
            
            <div class="bg-dark-700 rounded-lg p-4">
              <div class="flex items-center text-purple-300 text-sm font-medium mb-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                How Self-Reflection Works
              </div>
              <div class="text-gray-400 text-xs">
                When using Chain of Draft with self-reflection:
                <ul class="list-disc list-inside mt-2 space-y-1">
                  <li>The model reasons step-by-step as usual</li>
                  <li>Before concluding, it adds a reflection step to check for errors</li>
                  <li>This helps identify calculation mistakes, misunderstandings, or logic errors</li>
                  <li>The reflection is highlighted in the UI for easy identification</li>
                </ul>
                <p class="mt-2">This approach improves accuracy with a single API call.</p>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Parameters Tab Content -->
        <div id="parametersTab" class="tab-content">
          <h3 class="text-lg font-medium mb-4 pb-2 border-b border-dark-600">Generation Parameters</h3>
          
          <!-- Streaming Toggle -->
          <div class="flex items-center justify-between mb-5 bg-dark-600 rounded-lg p-3 border border-dark-500">
            <label for="streamingToggle" class="flex items-center cursor-pointer">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-primary-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
              </svg>
              <div>
                <div class="font-medium text-sm">Enable Streaming Responses</div>
                <div class="text-gray-400 text-xs mt-0.5">See responses appear in real-time as they're generated</div>
              </div>
            </label>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="checkbox" id="streamingToggle" class="sr-only peer" checked="">
              <div class="w-11 h-6 bg-dark-500 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary-600"></div>
            </label>
          </div>
          
          <!-- Web Search Toggle -->
          <div class="flex items-center justify-between mb-5 bg-dark-600 rounded-lg p-3 border border-dark-500">
            <label for="webSearchToggle" class="flex items-center cursor-pointer">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-primary-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
              </svg>
              <div>
                <div class="font-medium text-sm">Enable Web Search</div>
                <div class="text-gray-400 text-xs mt-0.5">Allow model to search the web for up-to-date information</div>
              </div>
            </label>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="checkbox" id="webSearchToggle" class="sr-only peer">
              <div class="w-11 h-6 bg-dark-500 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary-600"></div>
            </label>
          </div>
          
          <!-- Temperature -->
          <div class="mb-4">
            <div class="flex justify-between items-center mb-2">
              <label for="temp" class="block text-sm font-medium text-gray-300">Temperature</label>
              <span id="tempValue" class="text-sm text-gray-400">0.6</span>
            </div>
            <input type="range" id="temp" min="0" max="1" step="0.01" value="0.6" class="w-full h-2 rounded-lg appearance-none cursor-pointer">
            <p class="text-xs text-gray-500 mt-1">Controls randomness: lower values make responses more focused.</p>
          </div>
          
          <!-- Top P -->
          <div class="mb-4">
            <div class="flex justify-between items-center mb-2">
              <label for="topP" class="block text-sm font-medium text-gray-300">Top P</label>
              <span id="topPValue" class="text-sm text-gray-400">1</span>
            </div>
            <input type="range" id="topP" min="0" max="1" step="0.01" value="1" class="w-full h-2 rounded-lg appearance-none cursor-pointer">
            <p class="text-xs text-gray-500 mt-1">Controls diversity via nucleus sampling.</p>
          </div>
          
          <!-- Top K -->
          <div class="mb-4">
            <div class="flex justify-between items-center mb-2">
              <label for="topK" class="block text-sm font-medium text-gray-300">Top K</label>
              <span id="topKValue" class="text-sm text-gray-400">40</span>
            </div>
            <input type="range" id="topK" min="0" max="100" step="1" value="40" class="w-full h-2 rounded-lg appearance-none cursor-pointer">
            <p class="text-xs text-gray-500 mt-1">Limits token selection to top K options.</p>
          </div>
          
          <!-- Presence Penalty -->
          <div class="mb-4">
            <div class="flex justify-between items-center mb-2">
              <label for="presencePenalty" class="block text-sm font-medium text-gray-300">Presence Penalty</label>
              <span id="presencePenaltyValue" class="text-sm text-gray-400">0</span>
            </div>
            <input type="range" id="presencePenalty" min="0" max="2" step="0.01" value="0" class="w-full h-2 rounded-lg appearance-none cursor-pointer">
            <p class="text-xs text-gray-500 mt-1">Reduces repetition of similar tokens.</p>
          </div>
          
          <!-- Frequency Penalty -->
          <div class="mb-4">
            <div class="flex justify-between items-center mb-2">
              <label for="frequencyPenalty" class="block text-sm font-medium text-gray-300">Frequency Penalty</label>
              <span id="frequencyPenaltyValue" class="text-sm text-gray-400">0</span>
            </div>
            <input type="range" id="frequencyPenalty" min="0" max="2" step="0.01" value="0" class="w-full h-2 rounded-lg appearance-none cursor-pointer">
            <p class="text-xs text-gray-500 mt-1">Reduces repetition based on frequency.</p>
          </div>
          
          <!-- Max Tokens -->
          <div class="mb-4">
            <div class="flex justify-between items-center mb-2">
              <label for="maxTokens" class="block text-sm font-medium text-gray-300">Max Tokens</label>
              <span id="maxTokensValue" class="text-sm text-gray-400">4008</span>
            </div>
            <input type="range" id="maxTokens" min="1" max="8192" step="128" value="4008" class="w-full h-2 rounded-lg appearance-none cursor-pointer">
            <p class="text-xs text-gray-500 mt-1">Maximum length of the response (1-8192 tokens for most models).</p>
          </div>
        </div>
        
        <div class="flex justify-end gap-3 pt-4 mt-4 border-t border-dark-600">
          <button id="closeSettings" class="px-4 py-2 bg-dark-600 hover:bg-dark-500 text-gray-300 rounded-lg transition">
            Cancel
          </button>
          <button id="saveSettings" class="px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg transition">
            Save Settings
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Feedback Modal -->
  <div id="feedbackModal" class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 hidden">
    <div class="bg-dark-700 rounded-xl shadow-2xl max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="p-5 border-b border-dark-600 flex justify-between items-center">
        <h2 class="text-xl font-semibold">Share Your Feedback</h2>
        <button id="closeFeedbackModal" class="text-gray-400 hover:text-white">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <div class="p-5">
        <form method="POST" name="feedback" data-netlify="true">
          <input type="hidden" name="form-name" value="feedback">
          <input type="hidden" id="feedbackModel" name="model" value="llama-3-70b">
          <input type="hidden" id="feedbackReasoning" name="reasoning_method" value="COD-5">
          
          <div class="mb-4">
            <label for="feedbackType" class="block text-sm font-medium text-gray-300 mb-2">Feedback Type:</label>
            <select id="feedbackType" name="feedback_type" class="w-full bg-dark-600 border border-dark-500 text-white rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-primary-500">
              <option value="general" selected="">General Feedback</option>
              <option value="bug">Report a Bug</option>
              <option value="feature">Feature Request</option>
              <option value="model_performance">Model Performance</option>
            </select>
          </div>
          
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-300 mb-3">How would you rate your experience?</label>
            <div class="flex justify-between">
              <label class="flex flex-col items-center cursor-pointer">
                <input type="radio" name="rating" value="1" class="sr-only peer" required="">
                <div class="text-2xl peer-checked:text-primary-400">😞</div>
                <div class="text-xs mt-1 peer-checked:text-primary-400">Poor</div>
              </label>
              <label class="flex flex-col items-center cursor-pointer">
                <input type="radio" name="rating" value="2" class="sr-only peer">
                <div class="text-2xl peer-checked:text-primary-400">😐</div>
                <div class="text-xs mt-1 peer-checked:text-primary-400">Fair</div>
              </label>
              <label class="flex flex-col items-center cursor-pointer">
                <input type="radio" name="rating" value="3" class="sr-only peer">
                <div class="text-2xl peer-checked:text-primary-400">🙂</div>
                <div class="text-xs mt-1 peer-checked:text-primary-400">Good</div>
              </label>
              <label class="flex flex-col items-center cursor-pointer">
                <input type="radio" name="rating" value="4" class="sr-only peer">
                <div class="text-2xl peer-checked:text-primary-400">😀</div>
                <div class="text-xs mt-1 peer-checked:text-primary-400">Great</div>
              </label>
              <label class="flex flex-col items-center cursor-pointer">
                <input type="radio" name="rating" value="5" class="sr-only peer">
                <div class="text-2xl peer-checked:text-primary-400">🤩</div>
                <div class="text-xs mt-1 peer-checked:text-primary-400">Excellent</div>
              </label>
            </div>
          </div>
          
          <div class="mb-4">
            <label for="feedbackComments" class="block text-sm font-medium text-gray-300 mb-2">Comments:</label>
            <textarea id="feedbackComments" name="comments" rows="4" required="" class="w-full bg-dark-600 border border-dark-500 text-white rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-primary-500"></textarea>
          </div>
          
          <button type="submit" class="w-full bg-primary-500 hover:bg-primary-600 text-white py-3 px-4 rounded-lg transition mt-2">
            Submit Feedback
          </button>
        </form>
      </div>
    </div>
  </div>

  <script>
    /***********************
     * Global Configuration
     ***********************/
    let MODEL_NAME = "";
    let MODEL_NAME_DISPLAY = "";
    let enableWebSearch = false;
    
    // API endpoints - primary and fallback
    const EDGE_API_URL = "/api/proxy";
    const FALLBACK_API_URL = "/api-fallback/proxy";
    // Keep the original for backward compatibility
    const API_PROXY_URL = EDGE_API_URL;
    
    // Reasoning Method
    let REASONING_METHOD = "cod"; // Options: "standard", "cot", "cod"
    
    // COD Word Limit
    let COD_WORD_LIMIT = 5;
    
    // Enhanced reasoning controls
    let ENHANCED_REASONING_ENABLED = true;
    let REASONING_ENHANCEMENT = "adaptive"; // Options: "adaptive", "standard"
    
    // Problem complexity detection
    let PROBLEM_COMPLEXITY = {
      hasMath: false,
      hasLogic: false,
      multiStep: false,
      complexity: "normal" // Options: "simple", "normal", "complex"
    };
    
    // Prompts for different reasoning methods
    let PROMPTS = {
      standard: "",
      
      cot: `Think step by step to solve this problem. Explain your reasoning at each step, then provide your final answer.`,
      
      cod: `Think step by step, but produce only minimal notes for each step (${COD_WORD_LIMIT} words maximum per step). Use mathematical notation where possible. Keep only essential information needed to solve the problem. Focus on key calculations and intermediate results without narrative explanation.
  
Separate your steps with periods. Write your final answer after the #### separator.

Examples:
Q: Jason had 20 lollipops. He gave Denny some lollipops. Now Jason has 12 lollipops. How many lollipops did Jason give to Denny?
A: 20 initial. 12 remaining. 20 - 12 = 8. #### 8 lollipops

Q: Roger has $125. He spends $55 on a video game and then receives $25 for his birthday. How much money does Roger have now?
A: Start: $125. Spent: $55. 125 - 55 = $70. Received: $25. 70 + 25 = $95. #### $95

Q: A square has a perimeter of 20 cm. What is its area?
A: Perimeter = 20 cm. Side length = 20/4 = 5 cm. Area = 5² = 25 cm². #### 25 square centimeters

Q: If a fabric store received 45 yards of cotton material and used 2/9 of it for a bulk order, how many yards of cotton material does the fabric store have left?
A: Total: 45 yards. Used: 2/9 × 45 = 10 yards. Remaining: 45 - 10 = 35 yards. #### 35 yards

Q: The temperature on Monday was -3°C. On Tuesday, it was 14°C. What was the change in temperature from Monday to Tuesday?
A: Monday: -3°C. Tuesday: 14°C. Change: 14 - (-3) = 17°C. #### 17°C`
    };
    
    // Enhanced prompts for complex problems with different word limits
    let ENHANCED_PROMPTS = {
      cot: `Think step by step to solve this problem. This appears to be a complex problem that requires careful reasoning. Break down your thinking into clear steps, making sure to consider all relevant information and constraints. 

For complex problems, use as many steps as needed to work through the solution thoroughly. It's better to use more steps with clear reasoning than to skip steps.

Check your calculations and logic at each step. After you've completed your reasoning process, provide your final answer.`,
      
      cod5: `Think step by step to solve this complex problem. For each step, use at most 5 words to capture the essential reasoning, but use AS MANY STEPS as needed to thoroughly work through the problem. Use mathematical notation where efficient. Show ALL intermediate calculations and logical inferences.

IMPORTANT: Instead of trying to fit complex reasoning into fewer steps, break your reasoning into more numerous simple steps. For example, instead of one step with "Calculate area using length×width=50×30=1500", use multiple steps:
1. Length = 50.
2. Width = 30.
3. Area = length × width.
4. Area = 50 × 30.
5. Area = 1500.

Before providing your final answer, add a reflection step starting with "Reflection:" to verify your work and catch any potential errors.

Separate your steps with periods. Write your final answer after the #### separator.

Example of solving a complex problem with sufficient steps:
Q: A car travels at 60 mph. After 2 hours, it increases speed to 75 mph for 1 hour. It then decreases to 50 mph for the final 30 minutes. What is the total distance traveled?
A: First segment: speed 60 mph. First segment: time 2h. First segment: distance = 60 × 2. First segment: distance = 120 miles. Second segment: speed 75 mph. Second segment: time 1h. Second segment: distance = 75 × 1. Second segment: distance = 75 miles. Third segment: speed 50 mph. Third segment: time 0.5h. Third segment: distance = 50 × 0.5. Third segment: distance = 25 miles. Total distance: 120 + 75 + 25. Reflection: Verified all calculations and units match. Each segment's distance correctly computed. #### 220 miles`,

      cod10: `Think step by step to solve this complex problem. For each step, use up to 10 words to capture the essential reasoning. Use AS MANY STEPS as needed to fully solve the problem. Include ALL intermediate calculations and logical inferences.

IMPORTANT: For complex problems, it's better to use more steps with clear reasoning than to try cramming too much into each step. Break complex calculations into multiple steps.

When thinking through difficult parts of a problem:
1. Identify what information you need
2. Think about how to derive that information
3. Perform calculations systematically
4. Check your work at key points

Before providing your final answer, add a reflection step starting with "Reflection:" to verify your work and catch any potential errors.

Separate your steps with periods. Write your final answer after the #### separator.

Example of solving a complex problem:
Q: A car travels at 60 mph. After 2 hours, it increases speed to 75 mph for 1 hour. It then decreases to 50 mph for the final 30 minutes. What is the total distance traveled?
A: First segment: speed 60 mph for 2 hours. First segment distance calculation: 60 mph × 2h. First segment distance = 120 miles. Second segment: speed 75 mph for 1 hour. Second segment distance calculation: 75 mph × 1h. Second segment distance = 75 miles. Third segment: speed 50 mph for 0.5 hours. Third segment distance calculation: 50 mph × 0.5h. Third segment distance = 25 miles. Need to sum all segment distances. Total distance calculation: 120 + 75 + 25. Reflection: Verified all time periods sum correctly and speed calculations are accurate. #### 220 miles`,
      
      cod15: `Think step by step to solve this complex problem. For each step, use up to 15 words to capture the essential reasoning, providing more detail for critical steps. Use mathematical notation where helpful but include explanations of your approach at key points.

Before providing your final answer, add a reflection step starting with "Reflection:" to verify your work and catch any potential errors.

Separate your steps with periods. Write your final answer after the #### separator.

Example of solving a complex problem:
Q: A car travels at 60 mph. After 2 hours, it increases speed to 75 mph for 1 hour. It then decreases to 50 mph for the final 30 minutes. What is the total distance traveled?
A: First segment: The car travels at 60 mph for 2 hours, so distance = 60 × 2 = 120 miles. Second segment: The car increases to 75 mph for 1 hour, so distance = 75 × 1 = 75 miles. Third segment: The car decreases to 50 mph for 0.5 hours, so distance = 50 × 0.5 = 25 miles. Reflection: Checked all calculations and time periods sum to 3.5 hours total. #### 220 miles`,
      
      cod17: `Think step by step to solve this complex problem. For each step, use up to 17 words to provide clear reasoning, especially for difficult parts. Balance precision and concision, using math notation to save words.

Before providing your final answer, add a reflection step starting with "Reflection:" to verify your work and catch any potential errors.

Separate your steps with periods. Write your final answer after the #### separator.

Example of solving a complex problem:
Q: A car travels at 60 mph. After 2 hours, it increases speed to 75 mph for 1 hour. It then decreases to 50 mph for the final 30 minutes. What is the total distance traveled?
A: First segment: The car travels at 60 mph for 2 hours, giving distance = 60 × 2 = 120 miles. Second segment: Speed increases to 75 mph for 1 hour, so this segment's distance = 75 miles. Third segment: Speed is 50 mph for 0.5 hours, contributing 50 × 0.5 = 25 miles. Reflection: Verified all calculations and confirmed total time equals 3.5 hours. #### 220 miles`,
      
      cod20: `Think step by step to solve this complex problem. For each step, use up to 20 words to provide clear reasoning, explaining your approach more thoroughly for the difficult parts of the problem.

Before providing your final answer, add a reflection step starting with "Reflection:" to verify your work and catch any potential errors.

Separate your steps with periods. Write your final answer after the #### separator.

Example of solving a complex problem:
Q: A car travels at 60 mph. After 2 hours, it increases speed to 75 mph for 1 hour. It then decreases to 50 mph for the final 30 minutes. What is the total distance traveled?
A: First segment: The car travels at 60 mph for 2 hours, so the distance covered in this segment is 60 × 2 = 120 miles. Second segment: The car then increases speed to 75 mph and maintains this for 1 hour, covering 75 × 1 = 75 miles. Third segment: Finally, the car decreases speed to 50 mph for 30 minutes (0.5 hours), covering 50 × 0.5 = 25 miles. Reflection: Verified all calculations are correct and time periods sum to 3.5 hours as expected. #### 220 miles`
    };
    
    // Default generation parameters
    let TEMPERATURE = 0.6;
    let TOP_P = 1;
    let MAX_TOKENS = 4008;
    let TOP_K = 40;
    let PRESENCE_PENALTY = 0;
    let FREQUENCY_PENALTY = 0;

    // Initialize global self-reflection variables
    let SELF_REFLECTION_ENABLED = true;
    
    // Add streaming flag
    let ENABLE_STREAMING = true;
    
    /***********************
     * Helper Functions
     ***********************/
    
    // Update the model display in the UI
    function updateCurrentModelDisplay() {
      const display = document.getElementById("currentModelDisplay");
      if (!display) return;
      
      let displayText = MODEL_NAME_DISPLAY || "No model selected";
      
      // Add badge for reasoning method
      let badgeText = "Standard";
      let badgeClass = "bg-gray-600 text-gray-300";
      
      if (REASONING_METHOD === "cod") {
        badgeText = `CoD-${COD_WORD_LIMIT}`;
        badgeClass = "bg-green-900/60 text-green-400";
      } else if (REASONING_METHOD === "cot") {
        badgeText = "CoT";
        badgeClass = "bg-indigo-900/60 text-indigo-400";
      }
      
      // Add adaptive indicator if enabled
      if (ENHANCED_REASONING_ENABLED && REASONING_ENHANCEMENT === "adaptive") {
        badgeText = "Adaptive";
        badgeClass = "bg-green-900/60 text-green-400";
      }
      
      // Update the display
      display.innerHTML = `<span>${displayText}</span><span class="${badgeClass} text-xs ml-2 px-2 py-0.5 rounded-full">${badgeText}</span>`;
    }
    
    // Get display name for model
    function getModelDisplayName(modelId) {
      const modelMap = {
        "accounts/fireworks/models/llama-v3p3-70b": "Llama-3 70B",
        "accounts/fireworks/models/deepseek-v3": "DeepSeek V3",
        "accounts/fireworks/models/deepseek-r1": "DeepSeek R1 (Reasoner)",
        "accounts/fireworks/models/llama4-maverick-instruct-basic": "Llama4 Maverick",
        "accounts/fireworks/models/llama4-scout-instruct-basic": "Llama4 Scout"
      };
      
      return modelMap[modelId] || modelId;
    }
    
    // Self-reflection initialization
    function initSelfReflection() {
      const toggle = document.getElementById('selfReflectionToggle');
      const infoPanel = document.getElementById('selfReflectionInfo');
      
      if (toggle) {
        toggle.checked = SELF_REFLECTION_ENABLED;
        
        toggle.addEventListener('change', () => {
          SELF_REFLECTION_ENABLED = toggle.checked;
          if (infoPanel) {
            infoPanel.style.display = SELF_REFLECTION_ENABLED ? 'block' : 'none';
          }
          updateCurrentModelDisplay();
        });
      }
    }
    
    // Save self-reflection settings
    function saveSelfReflectionSettings() {
      const toggle = document.getElementById('selfReflectionToggle');
      
      if (toggle) {
        SELF_REFLECTION_ENABLED = toggle.checked;
      }
      
      localStorage.setItem("selfReflectionEnabled", SELF_REFLECTION_ENABLED.toString());
    }
    
    /***********************
     * Thread Management
     ***********************/
    let threads = [];
    let currentThreadId = null;
    let threadCounter = 1;
    
    function createNewThread() {
      const newThread = {
        id: Date.now(),
        name: `Thread ${threadCounter++}`,
        messages: []
      };
      threads.push(newThread);
      currentThreadId = newThread.id;
      updateThreadList();
      renderCurrentThreadMessages();
      
      showNotification("New thread created");
    }
    
    function updateThreadList() {
      // Update main thread list
      const threadList = document.getElementById("threadList");
      if (threadList) {
        threadList.innerHTML = "";
        threads.forEach(thread => {
          const li = document.createElement("li");
          li.textContent = thread.name;
          li.className = "px-3 py-2 rounded-md cursor-pointer hover:bg-dark-500 transition";
          
          if (thread.id === currentThreadId) {
            li.classList.add("bg-dark-600", "text-primary-300");
          } else {
            li.classList.add("text-gray-300");
          }
          
          li.addEventListener("click", () => {
            currentThreadId = thread.id;
            renderCurrentThreadMessages();
            updateThreadList();
          });
          
          threadList.appendChild(li);
        });
      }
      
      // Update mobile thread list
      const mobileThreadList = document.getElementById("mobileThreadList");
      if (mobileThreadList) {
        mobileThreadList.innerHTML = "";
        threads.forEach(thread => {
          const li = document.createElement("li");
          li.textContent = thread.name;
          li.className = "px-3 py-2 rounded-md cursor-pointer hover:bg-dark-500 transition";
          
          if (thread.id === currentThreadId) {
            li.classList.add("bg-dark-600", "text-primary-300");
          } else {
            li.classList.add("text-gray-300");
          }
          
          li.addEventListener("click", () => {
            currentThreadId = thread.id;
            renderCurrentThreadMessages();
            updateThreadList();
            // Close mobile sidebar
            document.getElementById("mobileSidebar").classList.remove("translate-x-0");
            document.getElementById("mobileSidebar").classList.add("-translate-x-full");
          });
          
          mobileThreadList.appendChild(li);
        });
      }
    }
    
    function deleteCurrentThread() {
      if (!currentThreadId) return;
      if (confirm("Are you sure you want to delete this thread?")) {
        threads = threads.filter(thread => thread.id !== currentThreadId);
        if (threads.length > 0) {
          currentThreadId = threads[0].id;
        } else {
          createNewThread();
          return;
        }
        updateThreadList();
        renderCurrentThreadMessages();
        showNotification("Thread deleted");
      }
    }
    
    /***********************
     * Download Functions
     ***********************/
    function parseContentForExport(content) {
      if (!content) return []; 
      
      const result = [];
      const segments = content.split(/```/);
      for (let i = 0; i < segments.length; i++) {
        if (i % 2 === 0) {
          // Normal text
          const textLines = segments[i].split(/\r?\n/);
          textLines.forEach(line => {
            result.push({ type: 'text', content: line });
          });
        } else {
          // Code block
          const codeSegment = segments[i].trim();
          const firstNewlineIndex = codeSegment.indexOf('\n');
          let language = '';
          let codeContent = codeSegment;
          if (firstNewlineIndex !== -1) {
            const possibleLang = codeSegment.substring(0, firstNewlineIndex).trim();
            if (possibleLang && !possibleLang.includes(' ')) {
              language = possibleLang;
              codeContent = codeSegment.substring(firstNewlineIndex + 1);
            }
          }
          const codeLines = codeContent.split(/\r?\n/);
          result.push({ type: 'code', language: language, content: codeLines });
        }
      }
      return result;
    }
    
    function downloadCurrentThreadAsTxt() {
      const thread = threads.find(t => t.id === currentThreadId);
      if (!thread) {
        showNotification("Error: No active thread found");
        return;
      }
      
      let content = `Model: ${MODEL_NAME_DISPLAY || "Unknown"} (${REASONING_METHOD.toUpperCase()}`;
      if (REASONING_METHOD === "cod") {
        content += `-${COD_WORD_LIMIT}`;
      }
      content += `)\n\n`;
      
      thread.messages.forEach(msg => {
        if (msg.isPlaceholder) return;
        
        const prefix = msg.sender.toUpperCase();
        
        let headerInfo = prefix;
        if (msg.sender === "bot" && msg.wordCount !== undefined) {
          let countInfo = `[${msg.wordCount} words - ${msg.reasoningMethod || REASONING_METHOD.toUpperCase()}]`;
          if (msg.thinkingWordCount !== undefined && msg.answerWordCount !== undefined) {
            countInfo += ` (thinking: ${msg.thinkingWordCount}, answer: ${msg.answerWordCount})`;
          }
          headerInfo += ` ${countInfo}`;
        }
        
        content += `${headerInfo}:\n`;
        
        if (msg.sender === "bot" && msg.thinking && msg.answer) {
          content += `THINKING STEPS:\n${msg.thinking}\n\nFINAL ANSWER:\n${msg.answer}\n`;
        } else {
          try {
            const parsed = parseContentForExport(msg.content || "");
            parsed.forEach(item => {
              if (item.type === 'text') {
                content += item.content + '\n';
              } else if (item.type === 'code') {
                const lang = item.language ? ` (${item.language})` : '';
                content += `----- CODE BLOCK START${lang} -----\n`;
                item.content.forEach(line => {
                  content += `  ${line}\n`;
                });
                content += `----- CODE BLOCK END -----\n`;
              }
            });
          } catch (error) {
            console.error("Error parsing message content:", error);
            content += (msg.content || "") + '\n';
          }
        }
        content += '\n';
      });
      
      const blob = new Blob([content], { type: "text/plain" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `${thread.name || "Thread"}.txt`;
      a.style.display = 'none';
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 100);
      
      showNotification("TXT file downloaded");
    }
    
    function downloadCurrentThreadAsPdf() {
      const thread = threads.find(t => t.id === currentThreadId);
      if (!thread) {
        showNotification("Error: No active thread found");
        return;
      }
      
      try {
        if (typeof window.jspdf === 'undefined' && typeof window.jsPDF === 'undefined') {
          throw new Error("PDF generation library not available. Try downloading as TXT instead.");
        }
        
        const jsPDF = window.jspdf?.jsPDF || window.jsPDF || window.jspdf;
        if (!jsPDF) {
          throw new Error("PDF generation library not properly loaded.");
        }
        
        const doc = new jsPDF({
          orientation: "portrait",
          unit: "pt",
          format: "letter"
        });
        
        // Helper function to set background color
        function setPageBackground(doc) {
          doc.setFillColor(24, 24, 27);
          doc.rect(0, 0, doc.internal.pageSize.width, doc.internal.pageSize.height, 'F');
        }
        
        // Set background for first page
        setPageBackground(doc);
        
        // Set text color and font
        doc.setTextColor(229, 231, 235);
        doc.setFont("helvetica");
        
        // Add title
        let yPos = 40;
        doc.setFontSize(16);
        const title = thread.name || "Thread";
        doc.text(title, 40, yPos);
        yPos += 20;
        
        // Add model info
        doc.setFontSize(12);
        let modelText = `Model: ${MODEL_NAME_DISPLAY || "Unknown"} (${REASONING_METHOD.toUpperCase()}`;
        if (REASONING_METHOD === "cod") {
          modelText += `-${COD_WORD_LIMIT}`;
        }
        modelText += `)`;
        doc.text(modelText, 40, yPos);
        yPos += 30;
        
        // Helper constants
        const lineHeight = 14;
        const leftMargin = 40;
        const rightMargin = 40;
        const pageWidth = doc.internal.pageSize.getWidth ? doc.internal.pageSize.getWidth() : doc.internal.pageSize.width;
        const pageHeight = (doc.internal.pageSize.getHeight ? doc.internal.pageSize.getHeight() : doc.internal.pageSize.height) - 50;
        const maxLineWidth = pageWidth - leftMargin - rightMargin;
        
        // Helper function to check if we need a new page
        function checkNewPage(requiredHeight = lineHeight) {
          if (yPos + requiredHeight > pageHeight) {
            doc.addPage();
            setPageBackground(doc);
            yPos = 40;
            return true;
          }
          return false;
        }
        
        // Helper function to split text
        function splitTextToFitPage(text, fontSize = 12) {
          doc.setFontSize(fontSize);
          return doc.splitTextToSize(text, maxLineWidth);
        }
        
        // Process each message
        thread.messages.forEach((msg, index) => {
          if (msg.isPlaceholder) return;
          
          // Add spacer between messages
          if (index > 0) {
            yPos += 20;
            checkNewPage();
          }
          
          // Message sender and timestamp
          doc.setFontSize(12);
          doc.setFont("helvetica", "bold");
          
          const sender = msg.sender.toUpperCase();
          let headerText = sender;
          
          // Add word count info for bot messages
          if (msg.sender === "bot" && msg.wordCount !== undefined) {
            let countInfo = `[${msg.wordCount} words - ${msg.reasoningMethod || REASONING_METHOD.toUpperCase()}]`;
            headerText += ` ${countInfo}`;
          }
          
          doc.text(headerText, leftMargin, yPos);
          yPos += lineHeight * 1.5;
          checkNewPage();
          
          // Message content
          doc.setFont("helvetica", "normal");
          doc.setFontSize(11);
          
          // Handle messages with thinking/answer components separately
          if (msg.sender === "bot" && msg.thinking && msg.answer) {
            // Thinking section
            doc.setFont("helvetica", "bold");
            doc.text("THINKING STEPS:", leftMargin, yPos);
            yPos += lineHeight * 1.5;
            checkNewPage();
            
            doc.setFont("helvetica", "normal");
            const thinkingLines = splitTextToFitPage(msg.thinking);
            thinkingLines.forEach(line => {
              checkNewPage();
              doc.text(line, leftMargin, yPos);
              yPos += lineHeight;
            });
            
            yPos += lineHeight;
            checkNewPage();
            
            // Answer section
            doc.setFont("helvetica", "bold");
            doc.text("FINAL ANSWER:", leftMargin, yPos);
            yPos += lineHeight * 1.5;
            checkNewPage();
            
            doc.setFont("helvetica", "normal");
            const answerLines = splitTextToFitPage(msg.answer);
            answerLines.forEach(line => {
              checkNewPage();
              doc.text(line, leftMargin, yPos);
              yPos += lineHeight;
            });
          } else {
            // Regular message content
            try {
              // Try to parse content with code blocks
              const parsed = parseContentForExport(msg.content || "");
              
              let isInCodeBlock = false;
              
              parsed.forEach(item => {
                if (item.type === 'text') {
                  if (isInCodeBlock) {
                    isInCodeBlock = false;
                    yPos += lineHeight;
                    checkNewPage();
                  }
                  
                  const lines = splitTextToFitPage(item.content);
                  lines.forEach(line => {
                    checkNewPage();
                    doc.text(line, leftMargin, yPos);
                    yPos += lineHeight;
                  });
                } else if (item.type === 'code') {
                  // Mark start of code block
                  yPos += lineHeight / 2;
                  checkNewPage();
                  
                  doc.setFont("courier", "normal");
                  doc.setFontSize(9);
                  
                  const langLabel = item.language ? ` (${item.language})` : '';
                  doc.text(`----- CODE BLOCK START${langLabel} -----`, leftMargin, yPos);
                  yPos += lineHeight;
                  
                  // Print code content with slight indent
                  item.content.forEach(line => {
                    checkNewPage();
                    const codeLine = `  ${line}`;
                    const codeLines = splitTextToFitPage(codeLine, 9);
                    codeLines.forEach(l => {
                      checkNewPage();
                      doc.text(l, leftMargin, yPos);
                      yPos += lineHeight;
                      checkNewPage();
                    });
                  });
                  
                  // Mark end of code block
                  checkNewPage();
                  doc.text(`----- CODE BLOCK END -----`, leftMargin, yPos);
                  yPos += lineHeight;
                  
                  // Reset font for normal text
                  doc.setFont("helvetica", "normal");
                  doc.setFontSize(11);
                  
                  isInCodeBlock = true;
                }
              });
            } catch (error) {
              console.error("Error parsing message for PDF:", error);
              // Fallback for parsing errors
              if (msg.content) {
                const lines = splitTextToFitPage(msg.content || "");
                lines.forEach(line => {
                  checkNewPage();
                  doc.text(line, leftMargin, yPos);
                  yPos += lineHeight;
                });
              }
            }
          }
        });
        
        // Save the PDF
        doc.save(`${thread.name || "Thread"}.pdf`);
        showNotification("PDF file downloaded");
        
      } catch (error) {
        console.error("PDF generation error:", error);
        showNotification("Error generating PDF: " + error.message);
        
        // Fallback to text download if PDF fails
        showNotification("Falling back to TXT download instead");
        setTimeout(() => downloadCurrentThreadAsTxt(), 1000);
      }
    }
    
    /***********************
     * Word Counting Utility
     ***********************/
    function countWords(text) {
      // Remove code blocks for more accurate word count
      const textWithoutCode = text.replace(/```[\s\S]*?```/g, '');
      
      // Count mathematical expressions as single words
      let processedText = textWithoutCode
        // Replace simple equations with single tokens
        .replace(/\b\w+\s*=\s*[\d\w+\-*/()]+/g, "EQUATION")
        // Replace fractions with single tokens
        .replace(/\b\d+\/\d+\b/g, "FRACTION")
        // Replace mathematical operations with spaces
        .replace(/[+\-*/=<>]+/g, " ");
      
      // Split by whitespace and filter out empty strings
      const words = processedText.split(/\s+/).filter(word => word.length > 0);
      return words.length;
    }
    
    /***********************
     * Problem Complexity Analysis
     ***********************/
    function analyzeProblemComplexity(message) {
      // Reset current complexity
      PROBLEM_COMPLEXITY = {
        hasMath: false,N-like structures and UUIDs
        hasLogic: false,
        multiStep: false,tterns
        complexity: "normal",-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}/g, '')
        wordCount: message.split(/\s+/).length, '')
        estimatedSteps: 0ke content
      };.replace(/"object"\s*:\s*"[^"]*"/g, '')
        .replace(/"created"\s*:\s*\d+/g, '')
      // Mathematical expressions patterns '')
      const mathPatterns = [s*:\s*\[\{/g, '')
        /[0-9\s][\+\-\*\/\=\(\)][0-9\s]/,  // Basic operations
        /\d+\s*\^\s*\d+/,                  // Powers
        /\d+\s*\/\s*\d+/,                  // Fractions
        /(?:sin|cos|tan|log|ln|sqrt|exp)/i, // Math functions
        /\[\s*[^\]]+\s*\]/,                // Matrix notation
        /\{\s*[^\}]+\s*\}/,                // Set notation
        /[\+\-]\s*[\d\.]+[eE][\+\-]\d+/,   // Scientific notation
        /\d+\s*%/,                         // Percentages
      ];
      
      // Logical expressions patterns
      const logicPatterns = [lysis
        /(?:if|then|else|therefore|because|implies|since|hence|thus|consequently)/i,
        /(?:and|or|not|xor|nor|all|some|every|any|none)/i,
        /(?:true|false|valid|invalid|prove|QED|contradiction|logical|premise|conclusion)/i,
      ];OBLEM_COMPLEXITY = {
        hasMath: false,
      // Multi-step problem indicators
      const multiStepPatterns = [
        /(?:first|second|third|next|then|after|finally|lastly|step|phase)/i,
        /(?:find the total|calculate the|determine the|solve for)/i,
        /(?:per month|per year|initially|eventually|ultimately|before|after)/i,
        /(?:increases by|decreases by|changes by|grows|reduces)/i,
      ];
      // Mathematical expressions patterns
      // Check for math patterns
      for (const pattern of mathPatterns) {// Basic operations
        if (pattern.test(message)) {       // Powers
          PROBLEM_COMPLEXITY.hasMath = true;/ Fractions
          break;cos|tan|log|ln|sqrt|exp)/i, // Math functions
        }\[\s*[^\]]+\s*\]/,                // Matrix notation
      } /\{\s*[^\}]+\s*\}/,                // Set notation
        /[\+\-]\s*[\d\.]+[eE][\+\-]\d+/,   // Scientific notation
      // Check for logic patterns          // Percentages
      for (const pattern of logicPatterns) {
        if (pattern.test(message)) {
          PROBLEM_COMPLEXITY.hasLogic = true;
          break;cPatterns = [
        }(?:if|then|else|therefore|because|implies|since|hence|thus|consequently)/i,
      } /(?:and|or|not|xor|nor|all|some|every|any|none)/i,
        /(?:true|false|valid|invalid|prove|QED|contradiction|logical|premise|conclusion)/i,
      // Check for multi-step patterns
      for (const pattern of multiStepPatterns) {
        if (pattern.test(message)) {rs
          PROBLEM_COMPLEXITY.multiStep = true;
          break;t|second|third|next|then|after|finally|lastly|step|phase)/i,
        }(?:find the total|calculate the|determine the|solve for)/i,
      } /(?:per month|per year|initially|eventually|ultimately|before|after)/i,
        /(?:increases by|decreases by|changes by|grows|reduces)/i,
      // Determine complexity
      let complexityScore = 0;
      if (PROBLEM_COMPLEXITY.hasMath) complexityScore += 1;
      if (PROBLEM_COMPLEXITY.hasLogic) complexityScore += 1;
      if (PROBLEM_COMPLEXITY.multiStep) complexityScore += 1;
          PROBLEM_COMPLEXITY.hasMath = true;
      // Apply more specific pattern checks
        }
      // Advanced math indicators
      if (/(?:calculus|differential|integral|equation system|probability|statistics|algebra|geometry)/i.test(message)) {
        complexityScore += 1;erns
      }or (const pattern of logicPatterns) {
        if (pattern.test(message)) {
      // Long problems are often complextrue;
      if (message.length > 500) {
        complexityScore += 1;
      }
      
      // Multiple constraints or variables
      if (message.match(/(?:constraint|variable|unknown|factor|parameter|condition)/gi)?.length > 2) {
        complexityScore += 1;age)) {
      }   PROBLEM_COMPLEXITY.multiStep = true;
          break;
      // Update complexity level
      if (complexityScore >= 3) {
        PROBLEM_COMPLEXITY.complexity = "complex";
        // Estimate number of steps needed
        PROBLEM_COMPLEXITY.estimatedSteps = Math.max(
          5, BLEM_COMPLEXITY.hasMath) complexityScore += 1;
          Math.min(20, Math.ceil(PROBLEM_COMPLEXITY.wordCount / 15))
        );PROBLEM_COMPLEXITY.multiStep) complexityScore += 1;
      } else if (complexityScore >= 1) {
        PROBLEM_COMPLEXITY.complexity = "normal";
        PROBLEM_COMPLEXITY.estimatedSteps = Math.max(
          3, nced math indicators
          Math.min(10, Math.ceil(PROBLEM_COMPLEXITY.wordCount / 20))lity|statistics|algebra|geometry)/i.test(message)) {
        );mplexityScore += 1;
      } else {
        PROBLEM_COMPLEXITY.complexity = "simple";
        PROBLEM_COMPLEXITY.estimatedSteps = Math.max(
          2, sage.length > 500) {
          Math.min(5, Math.ceil(PROBLEM_COMPLEXITY.wordCount / 25))
        );
      }
      // Multiple constraints or variables
      // Adjust estimated steps based on problem characteristicsarameter|condition)/gi)?.length > 2) {
      if (PROBLEM_COMPLEXITY.hasMath && PROBLEM_COMPLEXITY.multiStep) {
        PROBLEM_COMPLEXITY.estimatedSteps += 2;
      }
      // Update complexity level
      if (PROBLEM_COMPLEXITY.hasLogic) {
        PROBLEM_COMPLEXITY.estimatedSteps += 1;x";
      } // Estimate number of steps needed
        PROBLEM_COMPLEXITY.estimatedSteps = Math.max(
      // If the problem has math expressions, ensure minimum steps
      if (PROBLEM_COMPLEXITY.hasMath) {M_COMPLEXITY.wordCount / 15))
        PROBLEM_COMPLEXITY.estimatedSteps = Math.max(PROBLEM_COMPLEXITY.estimatedSteps, 4);
      } else if (complexityScore >= 1) {
        PROBLEM_COMPLEXITY.complexity = "normal";
      console.log(`Problem analysis: ${JSON.stringify(PROBLEM_COMPLEXITY)}`);
          3, 
      return PROBLEM_COMPLEXITY;(PROBLEM_COMPLEXITY.wordCount / 20))
    }   );
      } else {
    /***********************omplexity = "simple";
     * Parse user message for word count requirements
     ***********************/
    function formatFinalAnswer(answer) {COMPLEXITY.wordCount / 25))
      if (!answer) return '';
      }
      // Clean up the answer text
      let formattedAnswer = answer.trim();roblem characteristics
      if (PROBLEM_COMPLEXITY.hasMath && PROBLEM_COMPLEXITY.multiStep) {
      // Remove any leading markers if they exist
      formattedAnswer = formattedAnswer.replace(/^(Answer:|Final answer:|The answer is:|Therefore,|Thus,|Hence,)/i, '').trim();
      
      return formattedAnswer;hasLogic) {
    }   PROBLEM_COMPLEXITY.estimatedSteps += 1;
      }
    function parseWordCountRequest(message) {
      // Common patterns for word count requestssure minimum steps
      const patterns = [XITY.hasMath) {
        /(\d+)\s*words?/i,.estimatedSteps = Math.max(PROBLEM_COMPLEXITY.estimatedSteps, 4);
        /in\s*(\d+)\s*words/i,
        /limit\s*(\d+)\s*words/i,
        /answer\s*in\s*(\d+)\s*words/i,JSON.stringify(PROBLEM_COMPLEXITY)}`);
        /respond\s*in\s*(\d+)\s*words/i,
        /keep\s*it\s*to\s*(\d+)\s*words/i,
        /no\s*more\s*than\s*(\d+)\s*words/i,
        /under\s*(\d+)\s*words/i,
        /maximum\s*of\s*(\d+)\s*words/i,
        /max\s*(\d+)\s*words/iword count requirements
      ];********************/
      nction formatFinalAnswer(answer) {
      // Check each pattern';
      for (const pattern of patterns) {
        const match = message.match(pattern);
        if (match && match[1]) {er.trim();
          const wordCount = parseInt(match[1]);
          if (!isNaN(wordCount) && wordCount > 0) {
            return wordCount;ttedAnswer.replace(/^(Answer:|Final answer:|The answer is:|Therefore,|Thus,|Hence,)/i, '').trim();
          }
        }urn formattedAnswer;
      }
      
      // No word count requirement foundge) {
      return null;tterns for word count requests
    } const patterns = [
        /(\d+)\s*words?/i,
    /***********************i,
     * Process Bot Messages for COD
     ***********************/s*words/i,
    function processBotMessage(content, reasoningMethod) {
      // Clean the full content firsts/i,
      content = cleanModelOutput(content);rds/i,
      
      // For Chain of Draft (CoD) mode/maximum\s*of\s*(\d+)\s*words/i,
      if (reasoningMethod === "cod") {
        const separatorIndex = content.indexOf("####");
        
        if (separatorIndex !== -1) {
          // Extract thinking steps and final answer(const pattern of patterns) {
          let thinking = content.substring(0, separatorIndex).trim();ttern);
          let answer = content.substring(separatorIndex + 4).trim();
           parseInt(match[1]);
          // Apply cleaning to both partsunt) && wordCount > 0) {
          thinking = cleanModelOutput(thinking);
          answer = cleanModelOutput(answer);
          
          // Check for reflection step
          const reflectionPatterns = [
            /reflection:/i,o word count requirement found
            /reflecting:/i,
            /let's verify:/i,
            /verifying:/i,
            /checking work:/i,
            /self-check:/i
          ];
          {
          let reflectionIndex = -1;
          let reflectionMatch = null;
           separatorIndex = content.indexOf("####");
          // Find the last occurring reflection step
          for (const pattern of reflectionPatterns) { (separatorIndex !== -1) {
            const match = thinking.match(pattern); final answer
            if (match && match.index > reflectionIndex) {);
              reflectionIndex = match.index;
              reflectionMatch = match;
            } Check for reflection step
          }
          
          if (reflectionIndex !== -1) { /reflecting:/i,
            // Split the thinking into regular steps and reflection  /let's verify:/i,
            const regularSteps = thinking.substring(0, reflectionIndex).trim();ying:/i,
            const reflectionStep = thinking.substring(reflectionIndex).trim();,
            
            // Format reflection step with special styling
            thinking = regularSteps + "\n\n" + reflectionStep;
          }
          
          return {
            content: content, // Find the last occurring reflection step
            thinking: thinking,   for (const pattern of reflectionPatterns) {
            answer: answer,      const match = thinking.match(pattern);
            thinkingWordCount: countWords(thinking),eflectionIndex) {
            answerWordCount: countWords(answer),index;
            hasReflection: reflectionIndex !== -1
          };
        }
      }
      
      // For Chain of Thought (CoT) mode  // Split the thinking into regular steps and reflection
      if (reasoningMethod === "cot") {    const regularSteps = thinking.substring(0, reflectionIndex).trim();
        // Look for potential conclusion markers;
        const conclusionMarkers = [
          "Therefore", "In conclusion", "So,", "Thus,", "Hence,", ith special styling
          "The answer is", "To conclude", "Finally,", "In summary","\n\n" + reflectionStep;
          "As a result", "Consequently", "The final answer"
        ];
          return {
        // Add a marker for just "Answer:" or "Final answer:" on its own line
        const answerMarkers = [
          /\n(Answer:|Final answer:)/i,
          /^(Answer:|Final answer:)/i,
          /\n(The answer is:|My answer is:|Final answer is:)/icountWords(answer),
        ];
        
        // Try each answer marker pattern
        for (const pattern of answerMarkers) {
          const answerMatch = content.match(pattern);
          if (answerMatch && answerMatch.index !== undefined) {T) mode
            // Found a marker "cot") {
            const thinking = content.substring(0, answerMatch.index).trim();
            const answer = content.substring(answerMatch.index + answerMatch[0].length).trim();
            refore", "In conclusion", "So,", "Thus,", "Hence,", 
            return {The answer is", "To conclude", "Finally,", "In summary",
              content: content, "As a result", "Consequently", "The final answer"
              thinking: thinking,];
              answer: answer,
              thinkingWordCount: countWords(thinking),"Answer:" or "Final answer:" on its own line
              answerWordCount: countWords(answer)= [
            };  /\n(Answer:|Final answer:)/i,
          }
        }
        
        // If no explicit answer marker, look for conclusion indicator words
        let lastMarkerIndex = -1; Try each answer marker pattern
        let bestMarker = "";
        h(pattern);
        for (const marker of conclusionMarkers) {werMatch.index !== undefined) {
          // Check for the marker near the end of the text (last 40%) // Found a marker
          const startSearchPos = content.length * 0.6;   const thinking = content.substring(0, answerMatch.index).trim();
          const markerIndex = content.indexOf(marker, startSearchPos);    const answer = content.substring(answerMatch.index + answerMatch[0].length).trim();
          
          if (markerIndex > lastMarkerIndex && markerIndex !== -1) {
            lastMarkerIndex = markerIndex;
            bestMarker = marker;
          }    answer: answer,
        }kingWordCount: countWords(thinking),
        : countWords(answer)
        // If we found a conclusion marker in a reasonable position
        if (lastMarkerIndex > content.length * 0.6) {
          const thinking = content.substring(0, lastMarkerIndex).trim();
          const answer = content.substring(lastMarkerIndex).trim();
          f no explicit answer marker, look for conclusion indicator words
          return {et lastMarkerIndex = -1;
            content: content,let bestMarker = "";
            thinking: thinking,
            answer: answer,
            thinkingWordCount: countWords(thinking),ar the end of the text (last 40%)
            answerWordCount: countWords(answer)
          };
        }
        
        // Last resort: if text has multiple paragraphs, try to use the last paragraph as answererIndex = markerIndex;
        const paragraphs = content.split(/\n\s*\n/);;
        if (paragraphs.length > 1) {
          const lastParagraph = paragraphs[paragraphs.length - 1].trim();
          // Only use last paragraph as answer if it's relatively short compared to whole text
          if (lastParagraph.length < content.length * 0.3) {le position
            const thinking = content.substring(0, content.lastIndexOf(lastParagraph)).trim();stMarkerIndex > content.length * 0.6) {
            return {onst thinking = content.substring(0, lastMarkerIndex).trim();
              content: content, const answer = content.substring(lastMarkerIndex).trim();
              thinking: thinking,   
              answer: lastParagraph,    return {
              thinkingWordCount: countWords(thinking),
              answerWordCount: countWords(lastParagraph)
            };er: answer,
          }nt: countWords(thinking),
        }t: countWords(answer)
      }
      
      // For standard reasoning
      if (reasoningMethod === "standard") { Last resort: if text has multiple paragraphs, try to use the last paragraph as answer
        return { const paragraphs = content.split(/\n\s*\n/);
          content: content,  if (paragraphs.length > 1) {
          thinking: null,  1].trim();
          answer: content,nly use last paragraph as answer if it's relatively short compared to whole text
          thinkingWordCount: 0,ph.length < content.length * 0.3) {
          answerWordCount: countWords(content)();
        };
      }
      
      // Default: if unable to separate, return entire content      answer: lastParagraph,
      return {         thinkingWordCount: countWords(thinking),
        content: content,          answerWordCount: countWords(lastParagraph)
        thinking: reasoningMethod === "cot" || reasoningMethod === "cod" ? content : null,
        answer: reasoningMethod === "standard" ? content : null,
        thinkingWordCount: reasoningMethod === "cot" || reasoningMethod === "cod" ? countWords(content) : 0,
        answerWordCount: reasoningMethod === "standard" ? countWords(content) : 0
      };
    }// For standard reasoning
    ndard") {
    /***********************
     * Format Thinking Steps for COD    content: content,
     ***********************/
    function formatThinkingSteps(thinking, reasoningMethod) {
      if (!thinking) return '';
        answerWordCount: countWords(content)
      // Remove any "###" prefixes
      let cleanedThinking = thinking.replace(/^#{1,3}\s*/gm, '');
      
      if (reasoningMethod === "cod") {
        // Split by periods to separate steps, but preserve periods within numbersrn {
        let steps = cleanedThinking.split(/\.(?!\d)/).filter(step => step.trim().length > 0);
        
        // Create formatted steps including reflection handling
        return steps.map((step, index) => {inkingWordCount: reasoningMethod === "cot" || reasoningMethod === "cod" ? countWords(content) : 0,
          // Check if this is a reflection step === "standard" ? countWords(content) : 0
          const isReflection = /reflection:|reflecting:|let's verify:|verifying:|checking work:|self-check:/i.test(step);
          
          const stepClass = isReflection ? 
            'flex items-start p-3 mb-2 rounded-lg bg-indigo-900/20 border-l-4 border-indigo-500' : *****************
            'flex items-start p-3 mb-2 rounded-lg bg-slate-800/30';mat Thinking Steps for COD
          
          let stepContent = step.trim();eps(thinking, reasoningMethod) {
          // Add period back if it's not a reflection step
          if (!isReflection && !stepContent.endsWith('.')) {
            stepContent += '.';
          }nking = thinking.replace(/^#{1,3}\s*/gm, '');
          
          // For reflection steps, add an icon and style differentlyreasoningMethod === "cod") {
          if (isReflection) {s, but preserve periods within numbers
            return `<div class="${stepClass} reflection-step">
              <span class="flex items-center justify-center min-w-8 h-8 mr-3 rounded-full bg-indigo-700/50 text-indigo-300 text-sm font-bold step-number">🔍</span>
              <span class="step-content font-mono text-sm text-indigo-300">${stepContent}</span>formatted steps including reflection handling
            </div>`;.map((step, index) => {
          }heck if this is a reflection step
          tion:|reflecting:|let's verify:|verifying:|checking work:|self-check:/i.test(step);
          return `<div class="${stepClass}">
            <span class="flex items-center justify-center min-w-8 h-8 mr-3 rounded-full bg-slate-700 text-primary-400 text-sm font-bold step-number">${index + 1}</span>
            <span class="step-content font-mono text-sm">${stepContent}</span>-start p-3 mb-2 rounded-lg bg-indigo-900/20 border-l-4 border-indigo-500' : 
          </div>`;
        }).join('');
      } else {   let stepContent = step.trim();
        // Original formatting for CoT     // Add period back if it's not a reflection step
        let steps = cleanedThinking.split(/\.\s+/);      if (!isReflection && !stepContent.endsWith('.')) {
        return steps.filter(step => step.trim()).';
          .map(step => 
            `<div class="p-2 mb-2 border-l-2 border-slate-600">${step.trim()}${!step.endsWith('.') ? '.' : ''}</div>`
          ).join('');n icon and style differently
      }
    }      return `<div class="${stepClass} reflection-step">
    ter justify-center min-w-8 h-8 mr-3 rounded-full bg-indigo-700/50 text-indigo-300 text-sm font-bold step-number">🔍</span>
    /***********************digo-300">${stepContent}</span>
     * Transform Message      </div>`;
     ***********************/
    function transformMessage(content) {
      if (!content) return '';
      pan class="flex items-center justify-center min-w-8 h-8 mr-3 rounded-full bg-slate-700 text-primary-400 text-sm font-bold step-number">${index + 1}</span>
      // Remove "###" prefixes from lines
      let processedContent = content.replace(/^#{1,3}\s*/gm, '');
      
      // Process markdown with marked.js if available
      if (typeof marked !== 'undefined') {
        return marked.parse(processedContent);it(/\.\s+/);
      } else {r(step => step.trim())
        // Simple markdown-like transformation for code blocks if marked is not availablemap(step => 
        const transformed = processedContent.replace(/```([\s\S]*?)```/g, (match, codeContent) => {p.endsWith('.') ? '.' : ''}</div>`
          let language = '';.join('');
          const lines = codeContent.split('\n');
          if (lines.length > 0 && !lines[0].includes(' ')) {
            language = lines[0].trim();
            lines.shift();***********************
          } * Transform Message
          return `<pre><code class="${language}">${lines.join('\n')}</code></pre>`;/
        });sage(content) {
        ;
        return transformed;
      }
    }t.replace(/^#{1,3}\s*/gm, '');
    
    /***********************.js if available
     * Rendering Messages
     ***********************/  return marked.parse(processedContent);
    function renderCurrentThreadMessages() {
      const chatMessagesDiv = document.getElementById("chatMessages");mation for code blocks if marked is not available
      if (!chatMessagesDiv) return;Content.replace(/```([\s\S]*?)```/g, (match, codeContent) => {
      
      chatMessagesDiv.innerHTML = "";const lines = codeContent.split('\n');
      const thread = threads.find(t => t.id === currentThreadId);(' ')) {
      ;
      if (thread) {
        thread.messages.forEach(msg => {
          // Create message container('\n')}</code></pre>`;
          const messageDiv = document.createElement("div");
          
          // Apply different styling based on sender
          if (msg.sender === "user") {
            messageDiv.className = "flex justify-end";
            
            const msgContent = document.createElement("div");
            msgContent.className = "max-w-[90%] bg-primary-600 text-white p-4 rounded-2xl rounded-tr-sm shadow-md";
            ***************/
            // Format and set content renderCurrentThreadMessages() {
            msgContent.innerHTML = transformMessage(msg.content);ntById("chatMessages");
            sagesDiv) return;
            // Add files to user messages if present
            if (msg.files && msg.files.length > 0) {
              addFilesToMessage(msgContent, msg.files);thread = threads.find(t => t.id === currentThreadId);
            }
            
            messageDiv.appendChild(msgContent);ad.messages.forEach(msg => {
          } else {
            // Bot messaget.createElement("div");
            messageDiv.className = "flex justify-start";
            
            const msgContent = document.createElement("div");
            msgContent.className = "max-w-[90%] bg-dark-700 border border-dark-500 p-4 rounded-2xl rounded-tl-sm shadow-md";
            
            // Handle placeholder messagesontent = document.createElement("div");
            if (msg.isPlaceholder) {me = "max-w-[90%] bg-primary-600 text-white p-4 rounded-2xl rounded-tr-sm shadow-md";
              msgContent.classList.add("opacity-70");
              msgContent.innerHTML = `<div class="flex items-center gap-2"> Format and set content
                <svg class="animate-spin h-4 w-4 text-primary-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">formMessage(msg.content);
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                ${msg.content}
              </div>`;
            } 
            // Handle streaming messagessgContent);
            else if (msg.isStreaming) {
              msgContent.classList.add("streaming");
              msgContent.innerHTML = transformMessage(msg.content);
              msgContent.innerHTML += `<div class="text-primary-400 text-xs mt-2 streaming-indicator">Generating</div>`;
            } eElement("div");
            // Handle thinking/answer messages border-dark-500 p-4 rounded-2xl rounded-tl-sm shadow-md";
            else if (msg.thinking) {
              // Thinking steps
              const thinkingContainer = document.createElement("div");
              thinkingContainer.className = "thinking-steps bg-dark-800 rounded-lg p-4 mb-4 border border-dark-600";
              msgContent.innerHTML = `<div class="flex items-center gap-2">
              // Add label for thinking stepsin h-4 w-4 text-primary-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              const thinkingLabel = document.createElement("div");stroke="currentColor" stroke-width="4"></circle>
              thinkingLabel.className = "text-xs uppercase tracking-wider font-semibold text-gray-400 mb-3 pb-2 border-b border-dark-500"; d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              thinkingLabel.textContent = msg.reasoningMethod && msg.reasoningMethod.startsWith("COD") ? 
                "Chain of Draft Steps" : "Thinking Steps";
              thinkingContainer.appendChild(thinkingLabel);div>`;
              
              // Format thinking steps Handle streaming messages
              const thinkingContent = document.createElement("div");
              thinkingContent.innerHTML = formatThinkingSteps(msgContent.classList.add("streaming");
                msg.thinking, rHTML = transformMessage(msg.content);
                msg.reasoningMethod ? msg.reasoningMethod.toLowerCase() : REASONING_METHODTML += `<div class="text-primary-400 text-xs mt-2 streaming-indicator">Generating</div>`;
              );
              thinkingContainer.appendChild(thinkingContent);
               if (msg.thinking) {
              msgContent.appendChild(thinkingContainer);
              
              // Final answerps bg-dark-800 rounded-lg p-4 mb-4 border border-dark-600";
              if (msg.answer) {
                const answerDiv = document.createElement("div"); Add label for thinking steps
                answerDiv.className = "bg-dark-800 rounded-lg p-4 border border-dark-600";
                xt-gray-400 mb-3 pb-2 border-b border-dark-500";
                const answerLabel = document.createElement("div");ngMethod && msg.reasoningMethod.startsWith("COD") ? 
                answerLabel.className = "text-xs uppercase tracking-wider font-semibold text-primary-400 mb-3 pb-2 border-b border-dark-500";"Chain of Draft Steps" : "Thinking Steps";
                answerLabel.textContent = "Final Answer";ngLabel);
                answerDiv.appendChild(answerLabel);
                // Format thinking steps
                const answerContent = document.createElement("div");document.createElement("div");
                answerContent.innerHTML = transformMessage(formatFinalAnswer(msg.answer));kingContent.innerHTML = formatThinkingSteps(
                answerDiv.appendChild(answerContent);
                   msg.reasoningMethod ? msg.reasoningMethod.toLowerCase() : REASONING_METHOD
                msgContent.appendChild(answerDiv);  );
              }
            } 
            // Default content display
            else {
              msgContent.innerHTML = transformMessage(msg.content);// Final answer
            }
            t("div");
            // Add word count badge for bot messages (except placeholders)  answerDiv.className = "bg-dark-800 rounded-lg p-4 border border-dark-600";
            if (!msg.isPlaceholder && msg.wordCount !== undefined) {
              const wordCountBadge = document.createElement("div");
              wordCountBadge.className = "absolute -top-1 -right-1 bg-dark-800 text-xs px-2 py-1 rounded-full border border-dark-600 shadow-md"; answerLabel.className = "text-xs uppercase tracking-wider font-semibold text-primary-400 mb-3 pb-2 border-b border-dark-500";
                answerLabel.textContent = "Final Answer";
              // Display reasoning method and word count
              let badgeText = `${msg.wordCount} words`;  
              
              if (msg.thinkingWordCount !== undefined && msg.answerWordCount !== undefined) {ssage(formatFinalAnswer(msg.answer));
                badgeText = `<span class="text-gray-400">${msg.thinkingWordCount}</span> + <span class="text-primary-400">${msg.answerWordCount}</span>`;
              }   
                  msgContent.appendChild(answerDiv);
              wordCountBadge.innerHTML = badgeText;
              
              // Make the container relative for absolute positioning // Default content display
              msgContent.style.position = "relative";  else {
              msgContent.appendChild(wordCountBadge);age(msg.content);
            } }
                
            // Add the content to the message divadge for bot messages (except placeholders)
            messageDiv.appendChild(msgContent);) {
          }       const wordCountBadge = document.createElement("div");
                  wordCountBadge.className = "absolute -top-1 -right-1 bg-dark-800 text-xs px-2 py-1 rounded-full border border-dark-600 shadow-md";
          chatMessagesDiv.appendChild(messageDiv);
        });d and word count
        
        // Scroll to the bottom
        chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;   if (msg.thinkingWordCount !== undefined && msg.answerWordCount !== undefined) {
      }         badgeText = `<span class="text-gray-400">${msg.thinkingWordCount}</span> + <span class="text-primary-400">${msg.answerWordCount}</span>`;
              }
      // Add syntax highlighting to code blocks
      if (typeof hljs !== 'undefined') {e.innerHTML = badgeText;
        document.querySelectorAll('pre code').forEach((block) => {         
          hljs.highlightElement(block);          // Make the container relative for absolute positioning
        });
      }
      
      // Add copy buttons to code blocks
      addCodeCopyButtons();nt to the message div
    }endChild(msgContent);
    
    function addMessageToCurrentThread(content, sender, isPlaceholder = false, files = []) {
      const thread = threads.find(t => t.id === currentThreadId);dChild(messageDiv);
      if (thread) {});
        // Process bot messages to separate thinking from answer
        let thinking = null;
        let answer = null;MessagesDiv.scrollHeight;
        let thinkingWordCount = 0;
        let answerWordCount = 0;
        let totalWordCount = 0;
        
        if (sender === "bot" && !isPlaceholder) {ocument.querySelectorAll('pre code').forEach((block) => {
          const processed = processBotMessage(content, REASONING_METHOD);  hljs.highlightElement(block);
          thinking = processed.thinking;
          answer = processed.answer;
          thinkingWordCount = processed.thinkingWordCount || 0;
          answerWordCount = processed.answerWordCount || 0;s to code blocks
          totalWordCount = thinkingWordCount + answerWordCount;
        }
        
        thread.messages.push({
          content,hreads.find(t => t.id === currentThreadId);
          sender,
          isPlaceholder,s bot messages to separate thinking from answer
          timestamp: new Date(),
          wordCount: sender === "bot" && !isPlaceholder ? totalWordCount : undefined,
          reasoningMethod: sender === "bot" && !isPlaceholder ? 
            (REASONING_METHOD === "cod" ? `${REASONING_METHOD.toUpperCase()}-${COD_WORD_LIMIT}` : REASONING_METHOD.toUpperCase()) : 
            undefined,
          thinking,
          answer,(sender === "bot" && !isPlaceholder) {
          thinkingWordCount: sender === "bot" && !isPlaceholder ? thinkingWordCount : undefined,  const processed = processBotMessage(content, REASONING_METHOD);
          answerWordCount: sender === "bot" && !isPlaceholder ? answerWordCount : undefined,g;
          // Add files to the message   answer = processed.answer;
          files: files && files.length > 0 ? files : undefined,     thinkingWordCount = processed.thinkingWordCount || 0;
          // Add complexity info for debugging      answerWordCount = processed.answerWordCount || 0;
          complexityInfo: sender === "user" ? PROBLEM_COMPLEXITY : undefinedhinkingWordCount + answerWordCount;
        });
        
        renderCurrentThreadMessages();
      }
    }
        isPlaceholder,
    /***********************ate(),
     * Build Messages Array for Chat Completions : undefined,
     ***********************/    reasoningMethod: sender === "bot" && !isPlaceholder ? 
    function buildMessagesForChat(wordCountRequest = null) {D === "cod" ? `${REASONING_METHOD.toUpperCase()}-${COD_WORD_LIMIT}` : REASONING_METHOD.toUpperCase()) : 
      const thread = threads.find(t => t.id === currentThreadId);      undefined,
      if (!thread) return [];
      
      const messages = [];: sender === "bot" && !isPlaceholder ? thinkingWordCount : undefined,
      const supportsMultimodal = doesModelSupportMultimodal(MODEL_NAME);    answerWordCount: sender === "bot" && !isPlaceholder ? answerWordCount : undefined,
      
      let systemPrompt = "";
      
      // Use enhanced reasoning for complex problems if enabledr" ? PROBLEM_COMPLEXITY : undefined
      let shouldUseEnhancedPrompt = false;
      let problemType = "";
      nderCurrentThreadMessages();
      // Determine if this is a complex problem that needs enhanced reasoning
      if (ENHANCED_REASONING_ENABLED && REASONING_ENHANCEMENT === "adaptive") {
        if (PROBLEM_COMPLEXITY.complexity === "complex") {
          shouldUseEnhancedPrompt = true;
          problemType = "complex";ild Messages Array for Chat Completions
          console.log("Using enhanced prompts for complex problem detected");*********************/
        } nction buildMessagesForChat(wordCountRequest = null) {
        else if (PROBLEM_COMPLEXITY.hasMath && (PROBLEM_COMPLEXITY.multiStep || PROBLEM_COMPLEXITY.hasLogic)) {
          shouldUseEnhancedPrompt = true;
          problemType = "mathematical";
          console.log("Using enhanced prompts for mathematical problem detected");
        }upportMultimodal(MODEL_NAME);
      }
      
      // If we have a reasoning method other than standard, add the system prompt
      if (REASONING_METHOD !== "standard") {plex problems if enabled
        // Determine which prompt to use based on complexity and settings
        if (shouldUseEnhancedPrompt) {
          if (REASONING_METHOD === "cot") {
            systemPrompt = ENHANCED_PROMPTS.cot;ine if this is a complex problem that needs enhanced reasoning
          } else if (REASONING_METHOD === "cod") {NG_ENHANCEMENT === "adaptive") {
            // Use the appropriate CoD prompt based on word limitex") {
            if (COD_WORD_LIMIT === 5) {
              systemPrompt = ENHANCED_PROMPTS.cod5;
              if (!SELF_REFLECTION_ENABLED) {le.log("Using enhanced prompts for complex problem detected");
                systemPrompt = systemPrompt.replace(/Before providing your final answer, add a reflection step.*?errors\.(\r?\n|\r)/g, '');
              }LEM_COMPLEXITY.multiStep || PROBLEM_COMPLEXITY.hasLogic)) {
            } else if (COD_WORD_LIMIT === 10) {
              systemPrompt = ENHANCED_PROMPTS.cod10;
              if (!SELF_REFLECTION_ENABLED) {le.log("Using enhanced prompts for mathematical problem detected");
                systemPrompt = systemPrompt.replace(/Before providing your final answer, add a reflection step.*?errors\.(\r?\n|\r)/g, '');
              }
            } else if (COD_WORD_LIMIT === 15) {
              systemPrompt = ENHANCED_PROMPTS.cod15;
              if (!SELF_REFLECTION_ENABLED) {NING_METHOD !== "standard") {
                systemPrompt = systemPrompt.replace(/Before providing your final answer, add a reflection step.*?errors\.(\r?\n|\r)/g, '');on complexity and settings
              }
            } else if (COD_WORD_LIMIT === 17) {
              systemPrompt = ENHANCED_PROMPTS.cod17;
              if (!SELF_REFLECTION_ENABLED) {e if (REASONING_METHOD === "cod") {
                systemPrompt = systemPrompt.replace(/Before providing your final answer, add a reflection step.*?errors\.(\r?\n|\r)/g, '');he appropriate CoD prompt based on word limit
              }
            } else if (COD_WORD_LIMIT === 20) {
              systemPrompt = ENHANCED_PROMPTS.cod20; if (!SELF_REFLECTION_ENABLED) {
              if (!SELF_REFLECTION_ENABLED) {     systemPrompt = systemPrompt.replace(/Before providing your final answer, add a reflection step.*?errors\.(\r?\n|\r)/g, '');
                systemPrompt = systemPrompt.replace(/Before providing your final answer, add a reflection step.*?errors\.(\r?\n|\r)/g, '');
              }
            } else {;
              // Fallback to standard prompt but update word limit    if (!SELF_REFLECTION_ENABLED) {
              systemPrompt = PROMPTS[REASONING_METHOD].replace(/\(\d+ words maximum per step\)/, `(${COD_WORD_LIMIT} words maximum per step)`);lace(/Before providing your final answer, add a reflection step.*?errors\.(\r?\n|\r)/g, '');
            }
          }15) {
        } else {
          // Use the selected reasoning method prompt  if (!SELF_REFLECTION_ENABLED) {
          systemPrompt = PROMPTS[REASONING_METHOD]; final answer, add a reflection step.*?errors\.(\r?\n|\r)/g, '');
          
          // If it's COD, update the word limit
          if (REASONING_METHOD === "cod") {
            // First update the word limit
            systemPrompt = systemPrompt.replace(/\(\d+ words maximum per step\)/, `(${COD_WORD_LIMIT} words maximum per step)`);eplace(/Before providing your final answer, add a reflection step.*?errors\.(\r?\n|\r)/g, '');
            
            // If self-reflection is enabled but not in the prompt, add it
            if (SELF_REFLECTION_ENABLED && !systemPrompt.includes("add a reflection step")) {
              const reflectionInstruction = "\n\nBefore providing your final answer, add a reflection step starting with \"Reflection:\" to verify your work and catch any potential errors.";REFLECTION_ENABLED) {
              // Find a good place to insert - after the first paragraph but before examples
              const firstParagraphEnd = systemPrompt.indexOf("\n\n");
              if (firstParagraphEnd !== -1) {
                const examplesStart = systemPrompt.indexOf("Examples:");e word limit
                if (examplesStart !== -1 && examplesStart > firstParagraphEnd) {ystemPrompt = PROMPTS[REASONING_METHOD].replace(/\(\d+ words maximum per step\)/, `(${COD_WORD_LIMIT} words maximum per step)`);
                  systemPrompt = systemPrompt.substring(0, examplesStart) + reflectionInstruction + "\n\n" + systemPrompt.substring(examplesStart);
                } else {
                  systemPrompt = systemPrompt.substring(0, firstParagraphEnd + 2) + reflectionInstruction + systemPrompt.substring(firstParagraphEnd + 2);
                }
              } else {
                systemPrompt += reflectionInstruction;
              }it
            }
            
            // If this is a problem that needs many steps, add instructions to use more stepsemPrompt = systemPrompt.replace(/\(\d+ words maximum per step\)/, `(${COD_WORD_LIMIT} words maximum per step)`);
            if (PROBLEM_COMPLEXITY.estimatedSteps > 5) {
              // Insert guidance about using sufficient steps after the first paragraphf self-reflection is enabled but not in the prompt, add it
              const firstParagraphEnd = systemPrompt.indexOf("\n\n");a reflection step")) {
              if (firstParagraphEnd !== -1) {onst reflectionInstruction = "\n\nBefore providing your final answer, add a reflection step starting with \"Reflection:\" to verify your work and catch any potential errors.";
                const beforeInsert = systemPrompt.substring(0, firstParagraphEnd); // Find a good place to insert - after the first paragraph but before examples
                const afterInsert = systemPrompt.substring(firstParagraphEnd);   const firstParagraphEnd = systemPrompt.indexOf("\n\n");
                     if (firstParagraphEnd !== -1) {
                const insertText = `\n\nIMPORTANT: This problem may require ${PROBLEM_COMPLEXITY.estimatedSteps}+ reasoning steps. Use as many steps as needed to fully solve the problem - it's better to break complex reasoning into more simple steps than to skip important details.`;        const examplesStart = systemPrompt.indexOf("Examples:");
                tParagraphEnd) {
                systemPrompt = beforeInsert + insertText + afterInsert;ompt.substring(0, examplesStart) + reflectionInstruction + "\n\n" + systemPrompt.substring(examplesStart);
              }
            }rompt.substring(0, firstParagraphEnd + 2) + reflectionInstruction + systemPrompt.substring(firstParagraphEnd + 2);
          }
        }   } else {
               systemPrompt += reflectionInstruction;
        let reasoningInfo = `${REASONING_METHOD.toUpperCase()}`;      }
        if (REASONING_METHOD === "cod") {
          reasoningInfo += `-${COD_WORD_LIMIT}`;
          if (SELF_REFLECTION_ENABLED) {   // If this is a problem that needs many steps, add instructions to use more steps
            reasoningInfo += " with self-reflection";    if (PROBLEM_COMPLEXITY.estimatedSteps > 5) {
          }nt steps after the first paragraph
        }      const firstParagraphEnd = systemPrompt.indexOf("\n\n");
        hEnd !== -1) {
        if (shouldUseEnhancedPrompt) {
          reasoningInfo += " (Enhanced for complex problem)";       const afterInsert = systemPrompt.substring(firstParagraphEnd);
        }        
        nsertText = `\n\nIMPORTANT: This problem may require ${PROBLEM_COMPLEXITY.estimatedSteps}+ reasoning steps. Use as many steps as needed to fully solve the problem - it's better to break complex reasoning into more simple steps than to skip important details.`;
        console.log(`Using ${reasoningInfo} prompt`);
        beforeInsert + insertText + afterInsert;
        if (wordCountRequest) {   }
          console.log(`Added instruction for ${wordCountRequest} word limit on final answer only`);
        }
        }
        messages.push({
          role: "system",Case()}`;
          content: systemPromptHOD === "cod") {
        });`-${COD_WORD_LIMIT}`;
      } else {
        console.log("Using standard reasoning (no special prompt)");easoningInfo += " with self-reflection";
        
        // If word count limit was requested, add a system message for it
        if (wordCountRequest && wordCountRequest > 0) { 
          messages.push({  if (shouldUseEnhancedPrompt) {
            role: "system",omplex problem)";
            content: `Please limit your response to ${wordCountRequest} words maximum.`
          });
          console.log(`Added instruction for ${wordCountRequest} word limit`);g ${reasoningInfo} prompt`);
        }
      }
      untRequest} word limit on final answer only`);
      // Add all user and assistant messages
      thread.messages
        .filter(msg => !msg.isPlaceholder)
        .forEach(msg => {
          if (msg.sender === "user" && msg.files && msg.files.length > 0 && supportsMultimodal) {
            // Check if we have any image files with dataUrl
            const hasImages = msg.files.some(file => 
              file.type.startsWith('image/') && file.dataUrl);ial prompt)");
            
            if (hasImages) {as requested, add a system message for it
              // For messages with images, create multimodal message formatCountRequest > 0) {
              const contentArray = [];push({
              e: "system",
              // Add text content if presentntent: `Please limit your response to ${wordCountRequest} words maximum.`
              if (msg.content && msg.content.trim()) {
                contentArray.push({  ${wordCountRequest} word limit`);
                  type: "text", 
                  text: msg.content 
                });
              }ant messages
              
              // Add images to the content array> !msg.isPlaceholder)
              msg.files.forEach(fileObj => {=> {
                if (fileObj.type.startsWith('image/') && fileObj.dataUrl) {.sender === "user" && msg.files && msg.files.length > 0 && supportsMultimodal) {
                  contentArray.push({eck if we have any image files with dataUrl
                    type: "image_url",nst hasImages = msg.files.some(file => 
                    image_url: {) && file.dataUrl);
                      url: fileObj.dataUrl
                    }
                  });ages, create multimodal message format
                }st contentArray = [];
              });
              
              // Add the multimodal messageg.content && msg.content.trim()) {
              messages.push({
                role: "user",", 
                content: contentArrayontent 
              });
              
              console.log(`Added multimodal message with ${contentArray.length} parts`); 
            } else {dd images to the content array
              // No valid images, use text-only formateObj => {
              messages.push({.type.startsWith('image/') && fileObj.dataUrl) {
                role: "user",
                content: msg.contentrl",
              });     image_url: {
            }           url: fileObj.dataUrl
          } else {         }
            // Regular text message            });
            messages.push({
              role: msg.sender === "user" ? "user" : "assistant",         });
              content: msg.content          
            });timodal message
          }.push({
        });
                  content: contentArray
      return messages;
    }
     multimodal message with ${contentArray.length} parts`);
    /***********************
     * Message Sendingmat
     ***********************/
    
    // Check which models support multimodal content
    function doesModelSupportMultimodal(modelName) {
      const multimodalModels = [    }
        'accounts/fireworks/models/deepseek-v3',    } else {
        'accounts/fireworks/models/llama-v3p3-70b',
        'accounts/fireworks/models/llama-v3p1-8b',
        'accounts/fireworks/models/qwen2p5',         role: msg.sender === "user" ? "user" : "assistant",
        'accounts/fireworks/models/llama4-maverick',          content: msg.content
        'accounts/fireworks/models/llama4-scout'
      ];
      
      return multimodalModels.some(supportedModel => 
        modelName && modelName.includes(supportedModel));
    }
    
    // Helper function to read files as base64 data URLs
    function readFileAsBase64(file) {
      return new Promise((resolve, reject) => {*******************/
        const reader = new FileReader();
        reader.onload = () => {// Check which models support multimodal content
          resolve(reader.result); // This is the data URLodelName) {
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });  'accounts/fireworks/models/llama-v3p1-8b',
    }
      'accounts/fireworks/models/llama4-maverick',
    async function sendMessage(message) {a4-scout'
      // Get the current streaming setting
      const savedStreamingPref = localStorage.getItem('streamingEnabled');
      ENABLE_STREAMING = savedStreamingPref !== null ? savedStreamingPref === 'true' : ENABLE_STREAMING;
      
      console.log(`Current streaming state: ${ENABLE_STREAMING ? 'enabled' : 'disabled'}`);
      
      // Check if Web Search is enabled Helper function to read files as base64 data URLs
      const useWebSearch = localStorage.getItem('webSearchEnabled') === 'true';
      
      // Analyze problem complexity if enhanced reasoning is enabledeReader();
      if (ENHANCED_REASONING_ENABLED && REASONING_ENHANCEMENT === "adaptive") {  reader.onload = () => {
        analyzeProblemComplexity(message);This is the data URL
      }
      
      // Process files for sending to the APIader.readAsDataURL(file);
      const supportsMultimodal = doesModelSupportMultimodal(MODEL_NAME);
      let processedFiles = [];
      
      if (attachedFiles.length > 0) {unction sendMessage(message) {
        try {et the current streaming setting
          console.log(`Processing ${attachedFiles.length} files for sending`);.getItem('streamingEnabled');
           !== null ? savedStreamingPref === 'true' : ENABLE_STREAMING;
          // Notify user if images won't be sent to the model
          if (!supportsMultimodal && attachedFiles.some(file => file.type.startsWith('image/'))) {ING ? 'enabled' : 'disabled'}`);
            showNotification(`Note: Selected model (${MODEL_NAME_DISPLAY}) may not fully support image input.`);
          }bled
          Storage.getItem('webSearchEnabled') === 'true';
          for (const file of attachedFiles) {
            // For images, read as data URLity if enhanced reasoning is enabled
            if (file.type.startsWith('image/')) {BLED && REASONING_ENHANCEMENT === "adaptive") {
              const dataUrl = await readFileAsBase64(file);oblemComplexity(message);
              processedFiles.push({
                originalFile: file,
                name: file.name,
                type: file.type,esModelSupportMultimodal(MODEL_NAME);
                size: file.size,
                dataUrl: dataUrl
              }); 0) {
              console.log(`Processed image file: ${file.name}`);
            } else {.log(`Processing ${attachedFiles.length} files for sending`);
              // For other files, just add metadata
              processedFiles.push({/ Notify user if images won't be sent to the model
                originalFile: file,ltimodal && attachedFiles.some(file => file.type.startsWith('image/'))) {
                name: file.name,L_NAME_DISPLAY}) may not fully support image input.`);
                type: file.type,
                size: file.size 
              });   for (const file of attachedFiles) {
            }      // For images, read as data URL
          }
        } catch (error) {
          console.error('Error processing files:', error);        processedFiles.push({
          showNotification('Error processing files for upload');
        }e.name,
      }
      
      // Add message to thread with processed files
      addMessageToCurrentThread(message, "user", false, processedFiles);
             console.log(`Processed image file: ${file.name}`);
      // Clear attached files after sending      } else {
      attachedFiles = [];
      const attachedFilesContainer = document.getElementById('attachedFiles');
      if (attachedFilesContainer) {
        attachedFilesContainer.innerHTML = '';
        attachedFilesContainer.style.display = 'none';
      } size: file.size
             });
      // If we're not using web search, make sure we have a model selected      }
      if (!useWebSearch && !MODEL_NAME) {
        const errorMsg = "Error: Please select a model in the Settings or enable Web Search.";
        addMessageToCurrentThread(errorMsg, "bot");    console.error('Error processing files:', error);
        console.error(errorMsg);upload');
        return;
      }
      
      // Parse message for word count requirements
      const wordCountRequest = parseWordCountRequest(message);addMessageToCurrentThread(message, "user", false, processedFiles);
      
      // Add placeholder message showing we're thinking
      let placeholderText = useWebSearch ? "Searching the web..." : "Thinking...";
      addMessageToCurrentThread(placeholderText, "bot", true);iles');
      const thread = threads.find(t => t.id === currentThreadId);
      const placeholderIndex = thread.messages.length - 1; = '';
      tachedFilesContainer.style.display = 'none';
      try {
        // Continue with Web Search or regular API calls
        if (useWebSearch) {e we have a model selected
          // Modify the placeholder to indicate web search is happening!useWebSearch && !MODEL_NAME) {
          thread.messages[placeholderIndex].content = "Searching the web for information...";rrorMsg = "Error: Please select a model in the Settings or enable Web Search.";
          renderCurrentThreadMessages();t");
          
          // Timestamp to prevent caching
          const timestamp = new Date().getTime();
          const cacheBuster = `?t=${timestamp}`;
          essage for word count requirements
          try {essage);
            // Call the Perplexity API endpoint
            const searchResponse = await fetch(`/api/perplexity${cacheBuster}`, { placeholder message showing we're thinking
              method: "POST",rch ? "Searching the web..." : "Thinking...";
              headers: { 
                "Content-Type": "application/json" hread = threads.find(t => t.id === currentThreadId);
              },placeholderIndex = thread.messages.length - 1;
              body: JSON.stringify({ query: message })
            });
            
            if (!searchResponse.ok) {
              throw new Error(`Error with web search: ${searchResponse.status}`); Modify the placeholder to indicate web search is happening
            }dex].content = "Searching the web for information...";
            
            const searchData = await searchResponse.json();
            
            // Format the response with sources if available
            let responseContent = searchData.answer || "No answer found";imestamp}`;
            
            // Add sources if available
            if (searchData.sources && searchData.sources.length > 0) {ll the Perplexity API endpoint
              responseContent += "\n\n**Sources:**\n";onst searchResponse = await fetch(`/api/perplexity${cacheBuster}`, {
              searchData.sources.forEach((source, index) => {  method: "POST",
                responseContent += `${index + 1}. [${source.title || "Source"}](${source.url || "#"})\n`;
                if (source.snippet) {" 
                  responseContent += `   ${source.snippet}\n`;
                }ingify({ query: message })
              });
            }
            
            // Update the message with search resultsb search: ${searchResponse.status}`);
            thread.messages[placeholderIndex] = {
              content: responseContent,
              sender: "bot",t searchResponse.json();
              isPlaceholder: false,
              timestamp: new Date(), Format the response with sources if available
              wordCount: countWords(responseContent),ta.answer || "No answer found";
              reasoningMethod: "WEB-SEARCH",
              thinking: null,if available
              answer: responseContent,es.length > 0) {
              thinkingWordCount: 0,*\n";
              answerWordCount: countWords(responseContent)
            };ent += `${index + 1}. [${source.title || "Source"}](${source.url || "#"})\n`;
            renderCurrentThreadMessages(); {
            return; `   ${source.snippet}\n`;
          } catch (error) {
            console.error("Web search error:", error);
            thread.messages[placeholderIndex] = {
              content: `Web search error: ${error.message}. Try again or disable web search in settings.`,
              sender: "bot",ith search results
              isPlaceholder: false,eholderIndex] = {
              timestamp: new Date(),content: responseContent,
              wordCount: 0,
              reasoningMethod: "WEB-SEARCH",ceholder: false,
              thinking: null,   timestamp: new Date(),
              answer: null,     wordCount: countWords(responseContent),
              thinkingWordCount: 0,      reasoningMethod: "WEB-SEARCH",
              answerWordCount: 0
            };
            renderCurrentThreadMessages();      thinkingWordCount: 0,
            return;ntent)
          }
        }    renderCurrentThreadMessages();
        
        // Build messages array with current settings and word count request
        const messagesForApi = buildMessagesForChat(wordCountRequest);
        
        // Validate max_tokens before sending to API     content: `Web search error: ${error.message}. Try again or disable web search in settings.`,
        let validatedMaxTokens = parseInt(MAX_TOKENS);      sender: "bot",
        e,
        // Ensure it's a valid number
        if (isNaN(validatedMaxTokens) || !isFinite(validatedMaxTokens)) {
          validatedMaxTokens = 4096; // Default to 4096 if invalid
          console.warn(`Invalid max_tokens value, defaulting to ${validatedMaxTokens}`);     thinking: null,
        }      answer: null,
        
        // Enforce model's limits
        validatedMaxTokens = Math.min(Math.max(1, validatedMaxTokens), 8192);
        if (validatedMaxTokens !== MAX_TOKENS) {    renderCurrentThreadMessages();
          console.warn(`Adjusted max_tokens from ${MAX_TOKENS} to ${validatedMaxTokens} to meet API requirements`);
        }
        
        // Detect if the messages are too long
        const totalWords = messagesForApi.reduce((total, msg) => total + countWords(typeof msg.content === 'string' ? msg.content : JSON.stringify(msg.content)), 0);unt request
        const estimatedTokens = totalWords * 1.5; // Rough estimate of tokens from wordsonst messagesForApi = buildMessagesForChat(wordCountRequest);
        
        // If the prompt is large, adjust max_tokens
        let adjustedMaxTokens = validatedMaxTokens;
        if (estimatedTokens > 2000) {
          console.log(`Large prompt detected (est. ${Math.round(estimatedTokens)} tokens). Reducing max_tokens to avoid timeouts.`);
          adjustedMaxTokens = Math.min(4096, validatedMaxTokens);ite(validatedMaxTokens)) {
        }t to 4096 if invalid
          console.warn(`Invalid max_tokens value, defaulting to ${validatedMaxTokens}`);
        // Final validation to ensure we're within model's limits
        adjustedMaxTokens = Math.min(Math.max(1, adjustedMaxTokens), 8192);
        imits
        // Add timestamp to URL to prevent cachingin(Math.max(1, validatedMaxTokens), 8192);
        const timestamp = new Date().getTime();MAX_TOKENS) {
        const cacheBuster = `?t=${timestamp}`;`Adjusted max_tokens from ${MAX_TOKENS} to ${validatedMaxTokens} to meet API requirements`);
        
        // Create payload for API request
        const payload = { Detect if the messages are too long
          model: MODEL_NAME,const totalWords = messagesForApi.reduce((total, msg) => total + countWords(typeof msg.content === 'string' ? msg.content : JSON.stringify(msg.content)), 0);
          messages: messagesForApi,* 1.5; // Rough estimate of tokens from words
          temperature: TEMPERATURE,
          top_p: TOP_P,
          max_tokens: adjustedMaxTokens,t adjustedMaxTokens = validatedMaxTokens;
          stream: ENABLE_STREAMING // Use the streaming flagimatedTokens > 2000) {
        };ound(estimatedTokens)} tokens). Reducing max_tokens to avoid timeouts.`);
        
        // Check if we should use streaming
        if (ENABLE_STREAMING) {
          console.log("Using streaming mode with Edge Function");model's limits
          in(Math.max(1, adjustedMaxTokens), 8192);
          try {
            // Update the placeholder to indicate streamingdd timestamp to URL to prevent caching
            thread.messages[placeholderIndex].content = "Connecting to streaming API...";
            renderCurrentThreadMessages();
            
            // Prepare to collect the full response
            let fullResponse = "";
            let renderPending = false;: MODEL_NAME,
            ssages: messagesForApi,
            // First send the initial request to start the stream
            const initResponse = await fetch(`/api/streaming-edge${cacheBuster}`, {
              method: "POST",_tokens: adjustedMaxTokens,
              headers: { "Content-Type": "application/json" },ream: ENABLE_STREAMING // Use the streaming flag
              body: JSON.stringify(payload)
            });
            
            if (!initResponse.ok) {ENABLE_STREAMING) {
              throw new Error(`Error starting stream: ${initResponse.status}`);aming mode with Edge Function");
            }
            
            // Set up event source for streaming Update the placeholder to indicate streaming
            const reader = initResponse.body.getReader();es[placeholderIndex].content = "Connecting to streaming API...";
            const decoder = new TextDecoder();
            
            // Process the streamPrepare to collect the full response
            while (true) {t fullResponse = "";
              const { done, value } = await reader.read();lse;
              
              if (done) { First send the initial request to start the stream
                console.log("Stream complete");reaming-edge${cacheBuster}`, {
                break;
              }headers: { "Content-Type": "application/json" },
              d)
              // Decode this chunk
              const chunk = decoder.decode(value, { stream: true });
              
              // Process SSE format (data: {...}\n\n)w new Error(`Error starting stream: ${initResponse.status}`);
              const lines = chunk.split('\n');
              
              for (const line of lines) {
                if (line.startsWith('data: ')) {itResponse.body.getReader();
                  // Extract the data partecoder = new TextDecoder();
                  const dataText = line.slice(6).trim();
                  the stream
                  // Special end marker
                  if (dataText === '[DONE]') {d();
                    console.log("Received [DONE] marker");
                    continue;
                  };
                  
                  try {
                    // Attempt to parse as JSON
                    const data = JSON.parse(dataText);ode this chunk
                    value, { stream: true });
                    // Check for errors from server
                    if (data.error === true) {
                      console.error("Streaming error:", data.message);nk.split('\n');
                      throw new Error(data.message || "Unknown streaming error");
                    }onst line of lines) {
                     ')) {
                    // Check for completion
                    if (data.done === true) {
                      console.log("Received done: true");
                      continue;
                    }{
                    nsole.log("Received [DONE] marker");
                    // Extract new content
                    if (data.choices && data.choices[0]) {
                      // Get the content delta or content
                      const contentDelta = data.choices[0].delta?.content || 
                                          data.choices[0].message?.content || ON
                                          "";
                      
                      if (contentDelta) {from server
                        // Add to full response
                        fullResponse += contentDelta;rror:", data.message);
                        treaming error");
                        // Update the message
                        thread.messages[placeholderIndex] = {
                          content: fullResponse,
                          sender: "bot",
                          isPlaceholder: false,e: true");
                          timestamp: new Date(),
                          isStreaming: true // Flag as streaming
                        };
                        t new content
                        // Use requestAnimationFrame for smoother renderingata.choices && data.choices[0]) {
                        if (!renderPending) {/ Get the content delta or content
                          renderPending = true; const contentDelta = data.choices[0].delta?.content || 
                          requestAnimationFrame(() => {  data.choices[0].message?.content || 
                            renderCurrentThreadMessages();
                            renderPending = false;
                          });
                        }
                      }  fullResponse += contentDelta;
                    }
                  } catch (parseError) {
                    // If not valid JSON, just append it as raw textolderIndex] = {
                    if (dataText && dataText !== '') {lResponse,
                      console.log("Non-JSON data received:", dataText);
                      fullResponse += dataText;,
                      Date(),
                      // Update the message with the raw text  isStreaming: true // Flag as streaming
                      thread.messages[placeholderIndex] = {  };
                        content: fullResponse,
                        sender: "bot",tionFrame for smoother rendering
                        isPlaceholder: false,
                        timestamp: new Date(),
                        isStreaming: true
                      };essages();
                       renderPending = false;
                      // Use requestAnimationFrame for smoother rendering   });
                      if (!renderPending) {   }
                        renderPending = true;   }
                        requestAnimationFrame(() => {   }
                          renderCurrentThreadMessages();   } catch (parseError) {
                          renderPending = false;       // If not valid JSON, just append it as raw text
                        });        if (dataText && dataText !== '') {
                      }dataText);
                    }
                  }          
                }sage with the raw text
              }
            },
            
            // Stream is complete - process the full response           isPlaceholder: false,
            console.log("Stream complete, processing final response");            timestamp: new Date(),
            
            // Create response metadata
            let reasoningInfo = REASONING_METHOD.toUpperCase();
            if (REASONING_METHOD === "cod") {r rendering
              reasoningInfo += `-${COD_WORD_LIMIT}`;
            }           renderPending = true;
                        requestAnimationFrame(() => {
            // Add enhanced reasoning info if used
            if (ENHANCED_REASONING_ENABLED && 
                REASONING_ENHANCEMENT === "adaptive" &&             });
                PROBLEM_COMPLEXITY.complexity === "complex") {
              reasoningInfo += "-ENHANCED";
            }
            
            // Process bot message to separate thinking and answer parts
            const processed = processBotMessage(fullResponse, REASONING_METHOD);
            
            // Update with the finalized message (not streaming anymore)he full response
            thread.messages[placeholderIndex] = {rocessing final response");
              content: fullResponse,
              sender: "bot",
              isPlaceholder: false,;
              timestamp: new Date(),
              wordCount: (processed.thinkingWordCount || 0) + (processed.answerWordCount || 0),reasoningInfo += `-${COD_WORD_LIMIT}`;
              reasoningMethod: reasoningInfo,}
              thinking: processed.thinking,
              answer: processed.answer,// Add enhanced reasoning info if used
              thinkingWordCount: processed.thinkingWordCount || 0,NABLED && 
              answerWordCount: processed.answerWordCount || 0,
              isStreaming: false // No longer streaming    PROBLEM_COMPLEXITY.complexity === "complex") {
            };
            
            renderCurrentThreadMessages();
            rate thinking and answer parts
          } catch (streamingError) {const processed = processBotMessage(fullResponse, REASONING_METHOD);
            console.error("Streaming error:", streamingError);
            lized message (not streaming anymore)
            // Fallback to non-streaming if streaming failsthread.messages[placeholderIndex] = {
            console.log("Falling back to non-streaming API...");
            thread.messages[placeholderIndex].content = "Streaming failed, falling back to regular API...";
            renderCurrentThreadMessages();   isPlaceholder: false,
                 timestamp: new Date(),
            // Set streaming to false in the payload for fallback      wordCount: (processed.thinkingWordCount || 0) + (processed.answerWordCount || 0),
            payload.stream = false;
            d.thinking,
            // Continue with non-streaming approach below,
            ENABLE_STREAMING = false; // Temporarily disable streamingWordCount || 0,
          }
        }    isStreaming: false // No longer streaming
        
        // Only proceed with non-streaming approach if streaming is disabled or failed  
        if (!ENABLE_STREAMING) {derCurrentThreadMessages();
          // Set a client-side timeout
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 35000); // 35 seconds timeoutreaming error:", streamingError);
          
          console.log("Sending request to Edge Function endpoint...");ing fails
          ole.log("Falling back to non-streaming API...");
          try {].content = "Streaming failed, falling back to regular API...";
            // First try: Send request to the Edge Function endpoint();
            const response = await fetch(`${EDGE_API_URL}${cacheBuster}`, {
              method: "POST",// Set streaming to false in the payload for fallback
              headers: {se;
                "Content-Type": "application/json"
              },// Continue with non-streaming approach below
              body: JSON.stringify(payload),ly disable streaming
              signal: controller.signal
            });
            
            // Clear the timeoutach if streaming is disabled or failed
            clearTimeout(timeoutId);
            
            // If successful, process the responset controller = new AbortController();
            if (response.ok) {etTimeout(() => controller.abort(), 35000); // 35 seconds timeout
              const data = await response.json();
              const botReply = data.choices &&e.log("Sending request to Edge Function endpoint...");
                              data.choices[0] &&
                              data.choices[0].message &&
                              data.choices[0].message.content;e Function endpoint
              }${cacheBuster}`, {
              if (botReply) {hod: "POST",
                const trimmedReply = botReply.trim();aders: {
                
                // Create response metadata
                let reasoningInfo = REASONING_METHOD.toUpperCase();
                if (REASONING_METHOD === "cod") {
                  reasoningInfo += `-${COD_WORD_LIMIT}`;
                }
                lear the timeout
                // Add enhanced reasoning info if used
                if (ENHANCED_REASONING_ENABLED && 
                    REASONING_ENHANCEMENT === "adaptive" && f successful, process the response
                    PROBLEM_COMPLEXITY.complexity === "complex") {
                  reasoningInfo += "-ENHANCED";e.json();
                }ata.choices &&
                ces[0] &&
                // Process bot message to separate thinking and answer partses[0].message &&
                const processed = processBotMessage(trimmedReply, REASONING_METHOD);
                
                thread.messages[placeholderIndex] = {
                  content: trimmedReply,ly.trim();
                  sender: "bot",
                  isPlaceholder: false,
                  timestamp: new Date(),t reasoningInfo = REASONING_METHOD.toUpperCase();
                  wordCount: (processed.thinkingWordCount || 0) + (processed.answerWordCount || 0),) {
                  reasoningMethod: reasoningInfo,  reasoningInfo += `-${COD_WORD_LIMIT}`;
                  thinking: processed.thinking,
                  answer: processed.answer,
                  thinkingWordCount: processed.thinkingWordCount || 0,// Add enhanced reasoning info if used
                  answerWordCount: processed.answerWordCount || 0ANCED_REASONING_ENABLED && 
                };     REASONING_ENHANCEMENT === "adaptive" && 
                renderCurrentThreadMessages();PROBLEM_COMPLEXITY.complexity === "complex") {
                
                // Re-enable streaming for next message
                ENABLE_STREAMING = true;  
                te thinking and answer parts
                return;ssage(trimmedReply, REASONING_METHOD);
              }
            } else {
              // If Edge Function returned an error response, try the fallback
              console.log(`Edge Function returned error ${response.status}, trying fallback...`);bot",
              
              // Try to parse the error response   timestamp: new Date(),
              let errorText = "Unknown error";    wordCount: (processed.thinkingWordCount || 0) + (processed.answerWordCount || 0),
              try {
                const errorResponse = await response.json();     thinking: processed.thinking,
                errorText = errorResponse.message || errorResponse.error || `Status code: ${response.status}`;ssed.answer,
              } catch (e) { 0,
                console.error("Failed to parse error response:", e);
              }    };
              es();
              throw new Error(`Edge Function returned status: ${response.status} - ${errorText}`);
            }
          } catch (edgeError) {
            // If Edge Function failed completely, try the fallback   
            console.log("Edge Function error, using fallback function:", edgeError.message);    return;
            
            // Update placeholder message
            if (thread.messages[placeholderIndex].isPlaceholder) {
              thread.messages[placeholderIndex].content = "Edge Function error, trying fallback...";  console.log(`Edge Function returned error ${response.status}, trying fallback...`);
              renderCurrentThreadMessages();
            }
            
            // Set a longer timeout for the fallback function
            const fallbackController = new AbortController();rResponse = await response.json();
            const fallbackTimeoutId = setTimeout(() => fallbackController.abort(), 60000); // 60 seconds timeout errorResponse.error || `Status code: ${response.status}`;
            tch (e) {
            try {to parse error response:", e);
              // Try the fallback serverless function
              const fallbackResponse = await fetch(`${FALLBACK_API_URL}${cacheBuster}`, {
                method: "POST", new Error(`Edge Function returned status: ${response.status} - ${errorText}`);
                headers: {
                  "Content-Type": "application/json" (edgeError) {
                }, If Edge Function failed completely, try the fallback
                body: JSON.stringify({r, using fallback function:", edgeError.message);
                  ...payload,
                  max_tokens: Math.min(8192, adjustedMaxTokens) // Ensure within model limits Update placeholder message
                }),erIndex].isPlaceholder) {
                signal: fallbackController.signal"Edge Function error, trying fallback...";
              });
              
              // Clear the fallback timeout
              clearTimeout(fallbackTimeoutId);
              troller = new AbortController();
              if (!fallbackResponse.ok) {> fallbackController.abort(), 60000); // 60 seconds timeout
                // Try to get detailed error from response
                let errorMsg = `Status: ${fallbackResponse.status}`;
                try {k serverless function
                  const errorData = await fallbackResponse.json();LBACK_API_URL}${cacheBuster}`, {
                  errorMsg = errorData.message || errorData.error || errorMsg;
                } catch (e) {ders: {
                  // If we can't parse JSON, try text "Content-Type": "application/json"
                  try {},
                    errorMsg = await fallbackResponse.text();
                  } catch (e2) {   ...payload,
                    // If all else fails, use status code    max_tokens: Math.min(8192, adjustedMaxTokens) // Ensure within model limits
                    errorMsg = `Status: ${fallbackResponse.status}`;
                  }
                }
                
                throw new Error(`Both endpoints failed. ${errorMsg}`);
              }
              
              // Process the fallback responsesponse.ok) {
              const fallbackData = await fallbackResponse.json();
              const botReply = fallbackData.choices &&let errorMsg = `Status: ${fallbackResponse.status}`;
                            fallbackData.choices[0] &&
                            fallbackData.choices[0].message &&
                            fallbackData.choices[0].message.content; errorData.error || errorMsg;
              
              if (botReply) { // If we can't parse JSON, try text
                const trimmedReply = botReply.trim() + "\n\n*Note: This response was generated using the fallback API endpoint.*";  try {
                text();
                // Create response metadata
                let reasoningInfo = REASONING_METHOD.toUpperCase();
                if (REASONING_METHOD === "cod") {`;
                  reasoningInfo += `-${COD_WORD_LIMIT}`;
                }
                
                // Add enhanced reasoning info if used
                if (ENHANCED_REASONING_ENABLED && 
                    REASONING_ENHANCEMENT === "adaptive" && 
                    PROBLEM_COMPLEXITY.complexity === "complex") {
                  reasoningInfo += "-ENHANCED"; fallbackResponse.json();
                }allbackData.choices &&
                a.choices[0] &&
                // Process bot message to separate thinking and answer parts.choices[0].message &&
                const processed = processBotMessage(trimmedReply, REASONING_METHOD);
                
                thread.messages[placeholderIndex] = {
                  content: trimmedReply,ly.trim() + "\n\n*Note: This response was generated using the fallback API endpoint.*";
                  sender: "bot",
                  isPlaceholder: false,
                  timestamp: new Date(),t reasoningInfo = REASONING_METHOD.toUpperCase();
                  wordCount: (processed.thinkingWordCount || 0) + (processed.answerWordCount || 0),) {
                  reasoningMethod: reasoningInfo,  reasoningInfo += `-${COD_WORD_LIMIT}`;
                  thinking: processed.thinking,
                  answer: processed.answer,
                  thinkingWordCount: processed.thinkingWordCount || 0,// Add enhanced reasoning info if used
                  answerWordCount: processed.answerWordCount || 0ANCED_REASONING_ENABLED && 
                };ASONING_ENHANCEMENT === "adaptive" && 
                renderCurrentThreadMessages();
                   reasoningInfo += "-ENHANCED";
                // Re-enable streaming for next message
                ENABLE_STREAMING = true;
                ing and answer parts
                return;
              } else {
                throw new Error("No valid response from fallback endpoint");eholderIndex] = {
              }   content: trimmedReply,
            } catch (fallbackError) {     sender: "bot",
              // Both edge function and fallback failed       isPlaceholder: false,
              if (fallbackError.name === 'AbortError') {         timestamp: new Date(),
                throw new Error("The fallback API also timed out. Try reducing max_tokens or using a simpler query.");ount: (processed.thinkingWordCount || 0) + (processed.answerWordCount || 0),
              } else {oningInfo,
                throw fallbackError;          thinking: processed.thinking,
              }
            }          thinkingWordCount: processed.thinkingWordCount || 0,
          }
        }
      } catch (error) {
        console.error("Error:", error);
        
        let errorMessage = "Error: " + error.message;
        
        // Check for specific error types and provide helpful messages
        if (error.name === "AbortError") {
          errorMessage = "Request timed out. Try again with a shorter question or reduce max_tokens in settings.";
        } else if (error.message.includes("401")) {
          errorMessage = "Authentication failed. Please check if your API key is properly set in environment variables.";
        } else if (error.message.includes("429")) {
          errorMessage = "Rate limit exceeded. Please wait a moment before trying again.";
        } else if (error.message.includes("500")) {
          errorMessage = "Server error. Please try again later.";
        } else if (error.message.includes("502") || error.message.includes("504")) {
          errorMessage = "The API took too long to respond. Try reducing max_tokens in settings (should be 8192 or less).";
        } else if (error.message.includes("Failed to fetch")) {
          errorMessage = "Could not connect to the API. Please check your internet connection and try again."; }
        } else if (error.message.includes("Both endpoints failed")) {}
          errorMessage = "Both primary and fallback API endpoints failed. Please try again later with reduced max_tokens.";
        } else if (error.message.includes("max_tokens")) {error);
          errorMessage = "The API requires max_tokens to be between 1 and 8192. Please adjust your settings.";
        } else if (error.message.includes("stream")) {or: " + error.message;
          errorMessage = "Error with streaming mode. Trying again may help, or disable streaming in the code.";
        }ecific error types and provide helpful messages
        
        thread.messages[placeholderIndex] = {"Request timed out. Try again with a shorter question or reduce max_tokens in settings.";
          content: errorMessage,r.message.includes("401")) {
          sender: "bot",ntication failed. Please check if your API key is properly set in environment variables.";
          isPlaceholder: false,sage.includes("429")) {
          timestamp: new Date(),errorMessage = "Rate limit exceeded. Please wait a moment before trying again.";
          wordCount: 0,} else if (error.message.includes("500")) {
          reasoningMethod: useWebSearch ? "WEB-SEARCH" : REASONING_METHOD.toUpperCase(),. Please try again later.";
          thinking: null,} else if (error.message.includes("502") || error.message.includes("504")) {
          answer: null, to respond. Try reducing max_tokens in settings (should be 8192 or less).";
          thinkingWordCount: 0,.includes("Failed to fetch")) {
          answerWordCount: 0   errorMessage = "Could not connect to the API. Please check your internet connection and try again.";
        };   } else if (error.message.includes("Both endpoints failed")) {
              errorMessage = "Both primary and fallback API endpoints failed. Please try again later with reduced max_tokens.";
        renderCurrentThreadMessages();sage.includes("max_tokens")) {
         "The API requires max_tokens to be between 1 and 8192. Please adjust your settings.";
        // Re-enable streaming for next messageage.includes("stream")) {
        ENABLE_STREAMING = true;h streaming mode. Trying again may help, or disable streaming in the code.";
      }
    }
    
    /***********************
     * Code Copy Feature "bot",
     ***********************/ isPlaceholder: false,
    function addCodeCopyButtons() {  timestamp: new Date(),
      const codeBlocks = document.querySelectorAll('pre code');
      codeBlocks.forEach(code => {  reasoningMethod: useWebSearch ? "WEB-SEARCH" : REASONING_METHOD.toUpperCase(),
        // Skip if already has a copy button container
        if (code.parentElement.classList.contains('relative')) {
          return;
        }
        
        const pre = code.parentElement;
        
        // Create container div
        const container = document.createElement('div');
        container.className = 'relative mb-4 rounded-lg overflow-hidden';
        pre.parentNode.insertBefore(container, pre);
        container.appendChild(pre);
        
        // Add language badge if specified
        const codeClass = code.className;de Copy Feature
        const language = codeClass.match(/language-([^\s]+)/)?.[1];********************/
        if (language && language !== 'plaintext') {
          const langBadge = document.createElement('div');
          langBadge.className = 'absolute top-2 left-2 bg-dark-900/80 text-xs py-1 px-2 rounded text-gray-400';deBlocks.forEach(code => {
          langBadge.textContent = language; has a copy button container
          container.appendChild(langBadge);ve')) {
        }
        
        // Add styles to the pre element
        pre.className = 'bg-dark-900 rounded-lg p-4 overflow-x-auto text-sm';
        
        // Add copy button
        const copyBtn = document.createElement('button'););
        copyBtn.className = 'absolute top-2 right-2 bg-dark-900/80 text-gray-400 hover:text-white text-xs py-1 px-2 rounded transition-colors';elative mb-4 rounded-lg overflow-hidden';
        copyBtn.textContent = 'Copy';, pre);
        copyBtn.addEventListener('click', () => {
          navigator.clipboard.writeText(code.textContent || '')
            .then(() => { language badge if specified
              copyBtn.textContent = 'Copied!';code.className;
              copyBtn.classList.add('text-green-400');guage-([^\s]+)/)?.[1];
              setTimeout(() => {
                copyBtn.textContent = 'Copy';ment.createElement('div');
                copyBtn.classList.remove('text-green-400');-2 left-2 bg-dark-900/80 text-xs py-1 px-2 rounded text-gray-400';
              }, 2000);
            })endChild(langBadge);
            .catch(() => {
              copyBtn.textContent = 'Failed';
              copyBtn.classList.add('text-red-400');// Add styles to the pre element
              setTimeout(() => {unded-lg p-4 overflow-x-auto text-sm';
                copyBtn.textContent = 'Copy';
                copyBtn.classList.remove('text-red-400');   // Add copy button
              }, 2000);    const copyBtn = document.createElement('button');
            });'absolute top-2 right-2 bg-dark-900/80 text-gray-400 hover:text-white text-xs py-1 px-2 rounded transition-colors';
        });t = 'Copy';
        ner('click', () => {
        container.appendChild(copyBtn);|| '')
      });
    }ed!';
    400');
    /***********************        setTimeout(() => {
     * Notification SystemtextContent = 'Copy';
     ***********************/400');
    function showNotification(message, duration = 3000) {00);
      const notification = document.getElementById("statusNotification");       })
      notification.textContent = message;        .catch(() => {
      notification.classList.add("opacity-100");ntent = 'Failed';
      st.add('text-red-400');
      setTimeout(() => {> {
        notification.classList.remove("opacity-100");tContent = 'Copy';
      }, duration);            copyBtn.classList.remove('text-red-400');
    }
    
    /***********************
     * File Upload Management  
     ***********************/
    let attachedFiles = [];});
    
    function handleFileInput() {
      const fileInput = document.getElementById('fileInput');
      const attachedFilesContainer = document.getElementById('attachedFiles');
      ******************/
      if (!fileInput || !attachedFilesContainer) return;sage, duration = 3000) {
      ("statusNotification");
      fileInput.addEventListener('change', (event) => {
        try {cation.classList.add("opacity-100");
          const files = event.target.files;
          const maxFileSize = 10 * 1024 * 1024; // 10MB limit
          e("opacity-100");
          if (files.length > 0) {ion);
            // Show the container if it was hidden
            attachedFilesContainer.classList.remove('hidden');
            
            // Process each filement
            for (let i = 0; i < files.length; i++) {*************/
              const file = files[i];edFiles = [];
              
              // Check file size
              if (file.size > maxFileSize) {.getElementById('fileInput');
                showNotification(`File ${file.name} is too large. Maximum size is 10MB`);s');
                continue;
              }Input || !attachedFilesContainer) return;
              
              // Check if the file is already in the listt) => {
              const isDuplicate = attachedFiles.some(f => f.name === file.name && f.size === file.size);
              if (isDuplicate) {t files = event.target.files;
                showNotification(`File ${file.name} is already attached`);024 * 1024; // 10MB limit
                continue;
              }(files.length > 0) {
              // Show the container if it was hidden
              // Add file to attachedFiles arrayclassList.remove('hidden');
              attachedFiles.push(file);
               // Process each file
              // Create file preview0; i < files.length; i++) {
              createFilePreview(file, attachedFilesContainer);
            }
                 // Check file size
            // Reset the file input     if (file.size > maxFileSize) {
            fileInput.value = '';           showNotification(`File ${file.name} is too large. Maximum size is 10MB`);
          }            continue;
        } catch (error) {
          console.error('Error handling file upload:', error);
          showNotification('Error uploading file. Please try again.');
        }        const isDuplicate = attachedFiles.some(f => f.name === file.name && f.size === file.size);
      });
    }le.name} is already attached`);
    
    function createFilePreview(file, container) {
      const filePreview = document.createElement('div');
      filePreview.className = 'relative bg-dark-700 rounded-lg p-2 border border-dark-600';
      
      // Create preview content based on file type
      if (file.type.startsWith('image/')) {
        // Create image preview for image files    createFilePreview(file, attachedFilesContainer);
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = document.createElement('img');
          img.className = 'w-16 h-16 object-cover rounded';
          img.src = e.target.result;
          filePreview.appendChild(img);catch (error) {
          ling file upload:', error);
          // Add file nameNotification('Error uploading file. Please try again.');
          const fileName = document.createElement('div');
          fileName.className = 'mt-1 text-xs text-gray-400 text-center truncate w-16';
          fileName.textContent = file.name.length > 15 ? file.name.substring(0, 12) + '...' : file.name;
          filePreview.appendChild(fileName);
        };ontainer) {
        reader.readAsDataURL(file);nst filePreview = document.createElement('div');
      } else {ame = 'relative bg-dark-700 rounded-lg p-2 border border-dark-600';
        // Create icon preview for non-image files
        const icon = document.createElement('div');
        icon.className = 'w-16 h-16 flex items-center justify-center bg-dark-600 rounded text-2xl';
        icon.textContent = getFileIcon(file.type);files
        filePreview.appendChild(icon); const reader = new FileReader();
          reader.onload = (e) => {
        // Add file namement.createElement('img');
        const fileName = document.createElement('div');
        fileName.className = 'mt-1 text-xs text-gray-400 text-center truncate w-16';
        fileName.textContent = file.name.length > 15 ? file.name.substring(0, 12) + '...' : file.name;);
        filePreview.appendChild(fileName);
      }
      
      // Add remove button  fileName.className = 'mt-1 text-xs text-gray-400 text-center truncate w-16';
      const removeButton = document.createElement('button');tent = file.name.length > 15 ? file.name.substring(0, 12) + '...' : file.name;
      removeButton.className = 'absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs';hild(fileName);
      removeButton.textContent = '×';};
      removeButton.addEventListener('click', () => {
        // Remove from array
        attachedFiles = attachedFiles.filter(f => f !== file); files
        onst icon = document.createElement('div');
        // Remove from DOMcon.className = 'w-16 h-16 flex items-center justify-center bg-dark-600 rounded text-2xl';
        filePreview.remove();type);
          filePreview.appendChild(icon);
        // Hide container if no files left
        if (attachedFiles.length === 0) {
          container.classList.add('hidden');   const fileName = document.createElement('div');
        }    fileName.className = 'mt-1 text-xs text-gray-400 text-center truncate w-16';
      });name.length > 15 ? file.name.substring(0, 12) + '...' : file.name;
      filePreview.appendChild(removeButton);
      
      // Add the preview to the container
      container.appendChild(filePreview);button
    }ement('button');
    lassName = 'absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs';
    function getFileIcon(fileType) {
      if (fileType.startsWith('image/')) {ddEventListener('click', () => {
        return '🖼️';
      } else if (fileType.startsWith('text/')) {s = attachedFiles.filter(f => f !== file);
        return '📄';
      } else if (fileType.includes('pdf')) {om DOM
        return '📑';
      } else if (fileType.includes('word') || fileType.includes('document')) {
        return '📝';
      } else if (fileType.includes('excel') || fileType.includes('spreadsheet')) {iles.length === 0) {
        return '📊';
      } else if (fileType.includes('audio')) {
        return '🎵';
      } else if (fileType.includes('video')) {pendChild(removeButton);
        return '🎬';
      } else if (fileType.includes('zip') || fileType.includes('compressed')) { // Add the preview to the container
        return '🗜️';  container.appendChild(filePreview);
      } else if (fileType.includes('code') || fileType.includes('javascript') || fileType.includes('html') || fileType.includes('css')) {
        return '📱';
      } else {nction getFileIcon(fileType) {
        return '📦';
      }
    }} else if (fileType.startsWith('text/')) {
    
    function addFilesToMessage(messageDiv, files) {
      if (!files || files.length === 0) return;
      ludes('word') || fileType.includes('document')) {
      const filesContainer = document.createElement('div');
      filesContainer.className = 'mt-3 space-y-2';e.includes('spreadsheet')) {
      
      files.forEach(file => {'audio')) {
        if (file.type.startsWith('image/')) {
          // Display images inline if (fileType.includes('video')) {
          if (file.dataUrl) {
            // If we already have a data URL, use it directlyType.includes('compressed')) {
            const img = document.createElement('img');
            img.className = 'max-w-full rounded-lg cursor-pointer hover:opacity-90 transition-opacity'; (fileType.includes('code') || fileType.includes('javascript') || fileType.includes('html') || fileType.includes('css')) {
            img.src = file.dataUrl;rn '📱';
            img.alt = file.name || 'Image';
            
            // Add click event to open full size image
            img.addEventListener('click', () => {
              window.open(file.dataUrl, '_blank');
            });
            
            filesContainer.appendChild(img);
          } else if (file.originalFile) {lement('div');
            // If we have the original file object, read ittainer.className = 'mt-3 space-y-2';
            const reader = new FileReader();
            reader.onload = (e) => {
              const img = document.createElement('img');
              img.className = 'max-w-full rounded-lg cursor-pointer hover:opacity-90 transition-opacity';lay images inline
              img.src = e.target.result;file.dataUrl) {
              img.alt = file.name || 'Image';use it directly
              nst img = document.createElement('img');
              // Add click event to open full size imageursor-pointer hover:opacity-90 transition-opacity';
              img.addEventListener('click', () => {c = file.dataUrl;
                window.open(e.target.result, '_blank');
              });
              en full size image
              filesContainer.appendChild(img);
            };
            reader.readAsDataURL(file.originalFile);
          } else {
            // Original implementation for backward compatibility - direct File objectlesContainer.appendChild(img);
            const reader = new FileReader();
            reader.onload = (e) => { read it
              const img = document.createElement('img');
              img.className = 'max-w-full rounded-lg cursor-pointer hover:opacity-90 transition-opacity';r.onload = (e) => {
              img.src = e.target.result;const img = document.createElement('img');
              img.alt = file.name || 'Image';ded-lg cursor-pointer hover:opacity-90 transition-opacity';
              img.src = e.target.result;
              // Add click event to open full size imagemage';
              img.addEventListener('click', () => {   
                window.open(e.target.result, '_blank'); Add click event to open full size image
              });
              
              filesContainer.appendChild(img);
            };    
            reader.readAsDataURL(file);
          }
        } else {
          // For non-image files, display as attachment
          const attachment = document.createElement('div');  // Original implementation for backward compatibility - direct File object
          attachment.className = 'flex items-center bg-dark-600 p-2 rounded-lg';
          
          const icon = document.createElement('div');    const img = document.createElement('img');
          icon.className = 'text-xl mr-3 text-gray-400';or-pointer hover:opacity-90 transition-opacity';
          icon.textContent = getFileIcon(file.type);
          attachment.appendChild(icon);';
          
          const fileInfo = document.createElement('div');    // Add click event to open full size image
          fileInfo.className = 'flex-1';
          
          const fileName = document.createElement('div');
          fileName.className = 'text-sm font-medium';
          fileName.textContent = file.name;    filesContainer.appendChild(img);
          fileInfo.appendChild(fileName);
          
          const fileSize = document.createElement('div'); }
          fileSize.className = 'text-xs text-gray-400'; else {
          fileSize.textContent = formatFileSize(file.size);    // For non-image files, display as attachment
          fileInfo.appendChild(fileSize);lement('div');
               attachment.className = 'flex items-center bg-dark-600 p-2 rounded-lg';
          attachment.appendChild(fileInfo);      
          filesContainer.appendChild(attachment);teElement('div');
        }ay-400';
      });
      
      messageDiv.appendChild(filesContainer);     
    }      const fileInfo = document.createElement('div');
     = 'flex-1';
    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' bytes';cument.createElement('div');
      else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';text-sm font-medium';
      else return (bytes / 1048576).toFixed(1) + ' MB';
    }ndChild(fileName);
        
    /***********************= document.createElement('div');
     * Web Search Functionsext-gray-400';
     ***********************/    fileSize.textContent = formatFileSize(file.size);
    function toggleWebSearch() {Child(fileSize);
      const btn = document.getElementById('webSearchBtn');
      if (!btn) return;    attachment.appendChild(fileInfo);
      
      // Toggle the state
      enableWebSearch = !enableWebSearch;
      
      // Store preference
      localStorage.setItem('webSearchEnabled', enableWebSearch.toString());
      
      // Update button appearance with active class
      if (enableWebSearch) {
        btn.classList.add('bg-primary-500', 'text-white');lse if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
        btn.classList.remove('bg-dark-500', 'text-gray-300');else return (bytes / 1048576).toFixed(1) + ' MB';
        btn.title = "Web search is enabled (click to disable)";
      } else {
        btn.classList.remove('bg-primary-500', 'text-white');**********************
        btn.classList.add('bg-dark-500', 'text-gray-300');
        btn.title = "Web search is disabled (click to enable)";***********************/
      }function toggleWebSearch() {
      etElementById('webSearchBtn');
      // Show notification
      showNotification(enableWebSearch ? 'Web search enabled' : 'Web search disabled');
        // Toggle the state
      console.log(`Web search ${enableWebSearch ? 'enabled' : 'disabled'}`);ch = !enableWebSearch;
    }
    ore preference
    /***********************ableWebSearch.toString());
     * Settings Management
     ***********************/lass
    
    // Tab handling
    function setupTabNavigation() {btn.classList.remove('bg-dark-500', 'text-gray-300');
      try {bled (click to disable)";
        console.log("Setting up tab navigation");
        tn.classList.remove('bg-primary-500', 'text-white');
        // Get all tab buttons and tab contentsbtn.classList.add('bg-dark-500', 'text-gray-300');
        const tabButtons = document.querySelectorAll('.tab-btn');to enable)";
        const tabContents = document.querySelectorAll('.tab-content');
        
        if (tabButtons.length === 0) {ification
          console.warn("No tab buttons found");eb search disabled');
        }
        ed'}`);
        // Add click event listeners to tab buttons
        tabButtons.forEach(button => {
          button.addEventListener('click', () => {**************
            try {
              // Remove active class from all buttons and contents
              tabButtons.forEach(btn => {
                btn.classList.remove('bg-primary-500', 'text-white');ng
                btn.classList.add('text-gray-400');etupTabNavigation() {
              });
              
              tabContents.forEach(content => {
                content.classList.remove('active'); all tab buttons and tab contents
                content.style.display = 'none';orAll('.tab-btn');
              });content');
              
              // Add active class to clicked button== 0) {
              button.classList.add('bg-primary-500', 'text-white');
              button.classList.remove('text-gray-400');
              
              // Show corresponding tab content
              const tabId = button.getAttribute('data-tab');ons.forEach(button => {
              const tabContent = document.getElementById(tabId);stener('click', () => {
              if (tabContent) {
                tabContent.classList.add('active'); // Remove active class from all buttons and contents
                tabContent.style.display = 'block'; tabButtons.forEach(btn => {
              } else {     btn.classList.remove('bg-primary-500', 'text-white');
                console.warn(`Tab content with id "${tabId}" not found`);lassList.add('text-gray-400');
              }
            } catch (err) {       
              console.error("Error handling tab click:", err);         tabContents.forEach(content => {
            }            content.classList.remove('active');
          });e.display = 'none';
        });
      } catch (err) {
        console.error("Error in setupTabNavigation:", err);
      }
    }
    
    // Custom model handling
    function setupModelInput() {        const tabId = button.getAttribute('data-tab');
      const modelSelect = document.getElementById('modelSelect');entById(tabId);
      const setModelBtn = document.getElementById('setModelBtn');        if (tabContent) {
      const modelInfoCard = document.getElementById('modelInfoCard');.classList.add('active');
      const selectedModelName = document.getElementById('selectedModelName');t.style.display = 'block';
      const modelTags = document.getElementById('modelTags');
      const modelDescription = document.getElementById('modelDescription');Tab content with id "${tabId}" not found`);
      
      if (!modelSelect || !modelInfoCard) return;
          console.error("Error handling tab click:", err);
      // Model information
      const modelInfo = {
        "accounts/fireworks/models/llama-v3p3-70b": {
          name: "Llama-3 70B",
          tags: ["Latest", "Versatile", "Chat"],nsole.error("Error in setupTabNavigation:", err);
          description: "Meta's latest model with strong performance across a wide range of tasks."
        },
        "accounts/fireworks/models/deepseek-v3": {
          name: "DeepSeek V3",
          tags: ["Latest", "Versatile", "Advanced", "Chat"],on setupModelInput() {
          description: "DeepSeek's latest model with strong all-around capabilities and reasoning."
        },.getElementById('setModelBtn');
        "accounts/fireworks/models/deepseek-r1": {InfoCard');
          name: "DeepSeek R1 (Reasoner)",
          tags: ["Reasoner", "Advanced", "Complex Tasks"],t modelTags = document.getElementById('modelTags');
          description: "DeepSeek model focused on complex reasoning tasks."iption');
        },
        "accounts/fireworks/models/llama4-maverick-instruct-basic": {
          name: "Llama4 Maverick",
          tags: ["New", "Llama4", "Vision", "1M Context"],Model information
          description: "Llama 4 Maverick model with large context and vision capabilities."nst modelInfo = {
        },  "accounts/fireworks/models/llama-v3p3-70b": {
        "accounts/fireworks/models/llama4-scout-instruct-basic": {
          name: "Llama4 Scout",
          tags: ["New", "Llama4", "Vision", "128k Context"],odel with strong performance across a wide range of tasks."
          description: "Llama 4 Scout model with vision capabilities."
        } "accounts/fireworks/models/deepseek-v3": {
      };    name: "DeepSeek V3",
      hat"],
      // Initialize with current model if set strong all-around capabilities and reasoning."
      if (MODEL_NAME && modelInfo[MODEL_NAME]) {
        modelSelect.value = MODEL_NAME;seek-r1": {
        updateModelInfo(MODEL_NAME);  name: "DeepSeek R1 (Reasoner)",
      }"Complex Tasks"],
       reasoning tasks."
      // Update model info card when selection changes
      modelSelect.addEventListener('change', () => {erick-instruct-basic": {
        const selectedModel = modelSelect.value;"Llama4 Maverick",
        updateModelInfo(selectedModel); tags: ["New", "Llama4", "Vision", "1M Context"],
            description: "Llama 4 Maverick model with large context and vision capabilities."
        // Show visual feedback on change
        modelSelect.style.borderColor = 'var(--primary)';-scout-instruct-basic": {
        setTimeout(() => {
          modelSelect.style.borderColor = '';  tags: ["New", "Llama4", "Vision", "128k Context"],
        }, 500);cout model with vision capabilities."
      });
      
      // Helper function to update model info
      function updateModelInfo(modelId) {odel if set
        if (!modelInfoCard) return;
        elSelect.value = MODEL_NAME;
        if (modelInfo[modelId]) {dateModelInfo(MODEL_NAME);
          const info = modelInfo[modelId];
          
          // Update headertion changes
          if (selectedModelName) {ener('change', () => {
            selectedModelName.textContent = info.name;ue;
          }
          
          // Update tags with animation
          if (modelTags) {style.borderColor = 'var(--primary)';
            modelTags.style.opacity = '0';Timeout(() => {
            setTimeout(() => {modelSelect.style.borderColor = '';
              modelTags.innerHTML = info.tags
                .map(tag => `<span class="bg-primary-500/20 text-primary-300 text-xs px-2 py-1 rounded-full">${tag}</span>`)
                .join('');
              modelTags.style.opacity = '1';date model info
            }, 150);
          }
          
          // Update description with animation(modelInfo[modelId]) {
          if (modelDescription) {const info = modelInfo[modelId];
            modelDescription.style.opacity = '0';
            setTimeout(() => {
              modelDescription.textContent = info.description;
              modelDescription.style.opacity = '1';
            }, 150);}
          }
          
          // Show the card with animation
          modelInfoCard.classList.remove('hidden');
          modelInfoCard.style.opacity = '0';etTimeout(() => {
          modelInfoCard.style.transform = 'translateY(10px)';delTags.innerHTML = info.tags
          500/20 text-primary-300 text-xs px-2 py-1 rounded-full">${tag}</span>`)
          requestAnimationFrame(() => {
            modelInfoCard.style.transition = 'opacity 0.3s ease, transform 0.3s ease';     modelTags.style.opacity = '1';
            modelInfoCard.style.opacity = '1';     }, 150);
            modelInfoCard.style.transform = 'translateY(0)';    }
          });
        } else {ription with animation
          // Hide or reset the card if no valid model
          modelInfoCard.classList.add('hidden');0';
        }
      }Content = info.description;
      
      // Set model button handler
      if (setModelBtn) {
        setModelBtn.addEventListener('click', () => {
          const modelName = modelSelect.value;imation
          if (modelName && modelInfo[modelName]) {
            MODEL_NAME = modelName;
            MODEL_NAME_DISPLAY = modelInfo[modelName].name;transform = 'translateY(10px)';
            updateCurrentModelDisplay();
            showNotification('Model set: ' + MODEL_NAME_DISPLAY);
            Card.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
            // Add visual feedbacknfoCard.style.opacity = '1';
            setModelBtn.classList.add('bg-green-500');
            setModelBtn.textContent = "Model Set!";);
            setTimeout(() => {lse {
              setModelBtn.classList.remove('bg-green-500');   // Hide or reset the card if no valid model
              setModelBtn.textContent = "Set Model";     modelInfoCard.classList.add('hidden');
            }, 1000);    }
          } else {
            showNotification('Please select a valid model');
          }
        });
      }  setModelBtn.addEventListener('click', () => {
    }delSelect.value;
    
    // Improved Chain of Draft word limit options UI      MODEL_NAME = modelName;
    function updateCoDOptionsUI() {
      const codOptions = document.getElementById('codOptions');play();
      if (!codOptions) return;L_NAME_DISPLAY);
      
      // Update selected state   // Add visual feedback
      const options = codOptions.querySelectorAll('.cod-word-limit-option');      setModelBtn.classList.add('bg-green-500');
      
      // First remove all event listeners by cloning options
      options.forEach(option => {        setModelBtn.classList.remove('bg-green-500');
        const newOption = option.cloneNode(true);el";
        option.parentNode.replaceChild(newOption, option);
      });
      lect a valid model');
      // Now get the fresh node list after replacement
      const refreshedOptions = codOptions.querySelectorAll('.cod-word-limit-option');
      
      // Update the visual state for each option
      refreshedOptions.forEach(option => {
        const value = parseInt(option.getAttribute('data-value'));proved Chain of Draft word limit options UI
        if (value === COD_WORD_LIMIT) {tion updateCoDOptionsUI() {
          option.classList.add('border-primary-500');('codOptions');
          option.classList.remove('border-dark-500', 'hover:border-primary-400');
        } else {
          option.classList.remove('border-primary-500');pdate selected state
          option.classList.add('border-dark-500', 'hover:border-primary-400');rAll('.cod-word-limit-option');
        }
        
        // Add new click listener to each option
        option.addEventListener('click', function() {
          const clickedValue = parseInt(this.getAttribute('data-value'));tNode.replaceChild(newOption, option);
          
          // Update all options' visual state
          refreshedOptions.forEach(opt => {get the fresh node list after replacement
            if (parseInt(opt.getAttribute('data-value')) === clickedValue) {efreshedOptions = codOptions.querySelectorAll('.cod-word-limit-option');
              opt.classList.add('border-primary-500');
              opt.classList.remove('border-dark-500', 'hover:border-primary-400'); each option
            } else { {
              opt.classList.remove('border-primary-500');
              opt.classList.add('border-dark-500', 'hover:border-primary-400'); (value === COD_WORD_LIMIT) {
            }('border-primary-500');
          });emove('border-dark-500', 'hover:border-primary-400');
          else {
          // Update word limit valueremove('border-primary-500');
          COD_WORD_LIMIT = clickedValue;-dark-500', 'hover:border-primary-400');
          console.log("COD word limit changed to:", COD_WORD_LIMIT);
          
          // Update the prompt  // Add new click listener to each option
          updateCoDPrompt();
               const clickedValue = parseInt(this.getAttribute('data-value'));
          // Update display          
          updateCurrentModelDisplay();
        });ch(opt => {
      });e')) === clickedValue) {
      
      console.log("COD options UI updated, current limit:", COD_WORD_LIMIT);            opt.classList.remove('border-dark-500', 'hover:border-primary-400');
    }
        opt.classList.remove('border-primary-500');
    // Improved function to update the CoD prompt when word limit changes'hover:border-primary-400');
    function updateCoDPrompt() {
      // Update the prompt to reflect new word limit
      const basePrompt = `Think step by step, but produce only minimal notes for each step (${COD_WORD_LIMIT} words maximum per step). Use mathematical notation where possible. Keep only essential information needed to solve the problem. Focus on key calculations and intermediate results without narrative explanation.
      // Update word limit value
Separate your steps with periods. Write your final answer after the #### separator.`;
      LIMIT);
      // Add self-reflection instruction if enabled
      const basePromptWithReflection = SELF_REFLECTION_ENABLED ? 
        basePrompt + `\n\nBefore providing your final answer, add a reflection step starting with "Reflection:" to verify your work and catch any potential errors.` : teCoDPrompt();
        basePrompt;
         // Update display
      // Keep the examples part of the prompt    updateCurrentModelDisplay();
      const examplesStart = PROMPTS.cod.indexOf('Examples:');
      if (examplesStart !== -1) { });
        PROMPTS.cod = basePromptWithReflection + '\n\n' + PROMPTS.cod.substring(examplesStart);  
      } else {ed, current limit:", COD_WORD_LIMIT);
        PROMPTS.cod = basePromptWithReflection;
      }
      
      console.log(`Updated CoD prompt with word limit: ${COD_WORD_LIMIT}, self-reflection: ${SELF_REFLECTION_ENABLED}`);
    }
    const basePrompt = `Think step by step, but produce only minimal notes for each step (${COD_WORD_LIMIT} words maximum per step). Use mathematical notation where possible. Keep only essential information needed to solve the problem. Focus on key calculations and intermediate results without narrative explanation.
    // Setup Enhanced Reasoning options
    function setupEnhancedReasoningOptions() {riods. Write your final answer after the #### separator.`;
      const enhancedToggle = document.getElementById('enhancedReasoningToggle');
      const optionsContainer = document.getElementById('enhancedReasoningOptions');struction if enabled
      const adaptiveRadio = document.getElementById('adaptiveReasoning');
      const standardRadio = document.getElementById('standardReasoningEnhancement');asePrompt + `\n\nBefore providing your final answer, add a reflection step starting with "Reflection:" to verify your work and catch any potential errors.` : 
       basePrompt;
      // Initialize state
      if (enhancedToggle) {pt
        enhancedToggle.checked = ENHANCED_REASONING_ENABLED;amples:');
        if (optionsContainer) {
          optionsContainer.style.display = ENHANCED_REASONING_ENABLED ? 'block' : 'none';cod = basePromptWithReflection + '\n\n' + PROMPTS.cod.substring(examplesStart);
        }
      }ROMPTS.cod = basePromptWithReflection;
      
      if (adaptiveRadio && standardRadio) {
        if (REASONING_ENHANCEMENT === 'adaptive') {oD prompt with word limit: ${COD_WORD_LIMIT}, self-reflection: ${SELF_REFLECTION_ENABLED}`);
          adaptiveRadio.checked = true;
        } else {
          standardRadio.checked = true;
        }ngOptions() {
      }
       optionsContainer = document.getElementById('enhancedReasoningOptions');
      // Add event listenersetElementById('adaptiveReasoning');
      if (enhancedToggle) { standardRadio = document.getElementById('standardReasoningEnhancement');
        enhancedToggle.addEventListener('change', () => {
          ENHANCED_REASONING_ENABLED = enhancedToggle.checked;// Initialize state
          if (optionsContainer) {{
            optionsContainer.style.display = ENHANCED_REASONING_ENABLED ? 'block' : 'none';LED;
          }
          updateCurrentModelDisplay();NCED_REASONING_ENABLED ? 'block' : 'none';
        });
      }
      
      if (adaptiveRadio) {f (adaptiveRadio && standardRadio) {
        adaptiveRadio.addEventListener('change', () => {  if (REASONING_ENHANCEMENT === 'adaptive') {
          if (adaptiveRadio.checked) {ecked = true;
            REASONING_ENHANCEMENT = 'adaptive';
            updateCurrentModelDisplay();;
          }
        });
      }
      d event listeners
      if (standardRadio) {f (enhancedToggle) {
        standardRadio.addEventListener('change', () => {   enhancedToggle.addEventListener('change', () => {
          if (standardRadio.checked) {      ENHANCED_REASONING_ENABLED = enhancedToggle.checked;
            REASONING_ENHANCEMENT = 'standard';{
            updateCurrentModelDisplay();le.display = ENHANCED_REASONING_ENABLED ? 'block' : 'none';
          }
        });
      }  });
    }
    
    // Setup COD options displayo) {
    function setupCODOptions() {'change', () => {
      const reasoningRadios = document.getElementsByName('reasoningMethod');
      const codOptions = document.getElementById('codOptions');MENT = 'adaptive';
      dateCurrentModelDisplay();
      if (!codOptions) return;
       });
      // Initial state}
      if (REASONING_METHOD === 'cod') {
        codOptions.style.display = 'block';
        updateCoDOptionsUI(); () => {
      } else {
        codOptions.style.display = 'none';
      }play();
      
      // Update when reasoning method changes
      reasoningRadios.forEach(radio => {
        radio.addEventListener('change', () => {
          if (radio.value === 'cod' && radio.checked) {
            codOptions.style.display = 'block'; Setup COD options display
            updateCoDOptionsUI();
          } else {
            codOptions.style.display = 'none';.getElementById('codOptions');
          }
        });
      });
      itial state
      // Also update CoD prompt when self-reflection setting changesEASONING_METHOD === 'cod') {
      const selfReflectionToggle = document.getElementById('selfReflectionToggle'); codOptions.style.display = 'block';
      if (selfReflectionToggle) {   updateCoDOptionsUI();
        selfReflectionToggle.addEventListener('change', () => {  } else {
          if (REASONING_METHOD === 'cod') {y = 'none';
            updateCoDPrompt();
          }
        });
      }
    }ner('change', () => {
    'cod' && radio.checked) {
    // Settings slider handling
    function setupSliders() {  updateCoDOptionsUI();
      // Connect all sliders to their value displays
      document.querySelectorAll('input[type="range"]').forEach(slider => {y = 'none';
        const valueDisplay = document.getElementById(`${slider.id}Value`);}
        if (valueDisplay) {
          // Set initial value
          valueDisplay.textContent = slider.value;
          self-reflection setting changes
          // Update color based on valueelfReflectionToggle = document.getElementById('selfReflectionToggle');
          updateRangeColor(slider);(selfReflectionToggle) {
          elfReflectionToggle.addEventListener('change', () => {
          // Add input event listener     if (REASONING_METHOD === 'cod') {
          slider.addEventListener('input', () => {        updateCoDPrompt();
            valueDisplay.textContent = slider.value;
            updateRangeColor(slider);
          });
        }
      });
    }
    
    // Update range slider background // Connect all sliders to their value displays
    function updateRangeColor(slider) {  document.querySelectorAll('input[type="range"]').forEach(slider => {
      const min = parseFloat(slider.min) || 0;ent.getElementById(`${slider.id}Value`);
      const max = parseFloat(slider.max) || 1;(valueDisplay) {
      const value = parseFloat(slider.value) || 0;
      const percent = ((value - min) / (max - min)) * 100;  valueDisplay.textContent = slider.value;
      slider.style.setProperty('--value-percent', `${percent}%`);
    }  // Update color based on value
    
    function openSettingsModal() {
      try {
        console.log("Opening settings modal");  slider.addEventListener('input', () => {
        ider.value;
        // Initialize settings UI
        
        // Set reasoning method radio buttons}
        const reasoningRadio = document.getElementById(`${REASONING_METHOD}Reasoning`);
        if (reasoningRadio) reasoningRadio.checked = true;
        
        // Set enhanced reasoning optionsdate range slider background
        const enhancedToggle = document.getElementById('enhancedReasoningToggle');tion updateRangeColor(slider) {
        if (enhancedToggle) enhancedToggle.checked = ENHANCED_REASONING_ENABLED;
        
        const enhancedOptionsContainer = document.getElementById('enhancedReasoningOptions');nst value = parseFloat(slider.value) || 0;
        if (enhancedOptionsContainer) { min)) * 100;
          enhancedOptionsContainer.style.display = ENHANCED_REASONING_ENABLED ? 'block' : 'none';percent}%`);
        }
        
        const adaptiveRadio = document.getElementById('adaptiveReasoning');
        const standardRadio = document.getElementById('standardReasoningEnhancement');
        onsole.log("Opening settings modal");
        if (adaptiveRadio && standardRadio) {
          if (REASONING_ENHANCEMENT === 'adaptive') {I
            adaptiveRadio.checked = true;
          } else {tons
            standardRadio.checked = true;yId(`${REASONING_METHOD}Reasoning`);
          }o.checked = true;
        }
        
        // Set parameter slidersconst enhancedToggle = document.getElementById('enhancedReasoningToggle');
        setSliderAndValue("temp", TEMPERATURE);cked = ENHANCED_REASONING_ENABLED;
        setSliderAndValue("topP", TOP_P);
        setSliderAndValue("maxTokens", MAX_TOKENS);nhancedReasoningOptions');
        setSliderAndValue("topK", TOP_K);
        setSliderAndValue("presencePenalty", PRESENCE_PENALTY);ner.style.display = ENHANCED_REASONING_ENABLED ? 'block' : 'none';
        setSliderAndValue("frequencyPenalty", FREQUENCY_PENALTY);
        
        // Update CoD options UI if applicableeRadio = document.getElementById('adaptiveReasoning');
        if (REASONING_METHOD === 'cod') {ReasoningEnhancement');
          const codOptions = document.getElementById('codOptions');
          if (codOptions) codOptions.style.display = 'block';if (adaptiveRadio && standardRadio) {
          updateCoDOptionsUI();HANCEMENT === 'adaptive') {
        }
        
        // Show modal    standardRadio.checked = true;
        const modal = document.getElementById("settingsModal");
        if (modal) modal.style.display = "flex";
        
        // Reset tab state
        const tabButtons = document.querySelectorAll('.tab-btn');SliderAndValue("temp", TEMPERATURE);
        const tabContents = document.querySelectorAll('.tab-content');setSliderAndValue("topP", TOP_P);
        , MAX_TOKENS);
        // Hide all tabs firstOP_K);
        tabContents.forEach(content => {
          content.classList.remove('active'); FREQUENCY_PENALTY);
          content.style.display = 'none';
        });// Update CoD options UI if applicable
        
        // Deactivate all tab buttons
        tabButtons.forEach(btn => {
          btn.classList.remove('bg-primary-500', 'text-white');  updateCoDOptionsUI();
          btn.classList.add('text-gray-400');
        });
        
        // Activate only the parameters tab by defaultnst modal = document.getElementById("settingsModal");
        const parametersTabBtn = document.querySelector('.tab-btn[data-tab="parametersTab"]');
        const parametersTab = document.getElementById('parametersTab');
        / Reset tab state
        if (parametersTabBtn && parametersTab) {const tabButtons = document.querySelectorAll('.tab-btn');
          parametersTabBtn.classList.add('bg-primary-500', 'text-white');ment.querySelectorAll('.tab-content');
          parametersTabBtn.classList.remove('text-gray-400');
          
          parametersTab.classList.add('active');
          parametersTab.style.display = 'block'; content.classList.remove('active');
        }  content.style.display = 'none';
        
        // Set web search toggle
        const webSearchToggle = document.getElementById('webSearchToggle');buttons
        if (webSearchToggle) {
          webSearchToggle.checked = enableWebSearch; btn.classList.remove('bg-primary-500', 'text-white');
        }  btn.classList.add('text-gray-400');
        
        // Set streaming toggle
        const streamingToggle = document.getElementById('streamingToggle');
        if (streamingToggle) { const parametersTabBtn = document.querySelector('.tab-btn[data-tab="parametersTab"]');
          streamingToggle.checked = ENABLE_STREAMING;   const parametersTab = document.getElementById('parametersTab');
        }    
        ab) {
        console.log("Settings modal opened successfully");ary-500', 'text-white');
      } catch (err) {
        console.error("Error in openSettingsModal:", err);    
      }sTab.classList.add('active');
    }.display = 'block';
    
    function setSliderAndValue(id, value) { 
      const slider = document.getElementById(id);
      const valueDisplay = document.getElementById(`${id}Value`);   const webSearchToggle = document.getElementById('webSearchToggle');
          if (webSearchToggle) {
      if (slider) { enableWebSearch;
        slider.value = value;
        updateRangeColor(slider);
      }   // Set streaming toggle
      if (valueDisplay) valueDisplay.textContent = value;    const streamingToggle = document.getElementById('streamingToggle');
    }{
    treamingToggle.checked = ENABLE_STREAMING;
    function closeSettingsModal() {
      const modal = document.getElementById("settingsModal");
      if (modal) modal.style.display = "none";ssfully");
    }
    odal:", err);
    function saveSettings() {
      try {
        console.log("Saving settings...");
        d, value) {
        // Save previous settings for comparison
        const prevMethod = REASONING_METHOD;ument.getElementById(`${id}Value`);
        const prevWordLimit = COD_WORD_LIMIT;
        const prevEnhanced = ENHANCED_REASONING_ENABLED;
        const prevEnhancementType = REASONING_ENHANCEMENT;
        pdateRangeColor(slider);
        // Get streaming setting
        const streamingToggle = document.getElementById('streamingToggle');lay.textContent = value;
        if (streamingToggle) {
          ENABLE_STREAMING = streamingToggle.checked;
          localStorage.setItem('streamingEnabled', ENABLE_STREAMING.toString());
          console.log(`Streaming preference saved: ${ENABLE_STREAMING}`);
        }
        
        // Get web search setting
        const webSearchToggle = document.getElementById('webSearchToggle');
        if (webSearchToggle) {
          enableWebSearch = webSearchToggle.checked;
          localStorage.setItem('webSearchEnabled', enableWebSearch.toString());
          console.log(`Web search preference saved: ${enableWebSearch}`);
        }
        
        // Get model from selectEnhanced = ENHANCED_REASONING_ENABLED;
        try {
          const modelSelect = document.getElementById("modelSelect");
          if (modelSelect && modelSelect.value) {ting
            MODEL_NAME = modelSelect.value.trim();treamingToggle');
            MODEL_NAME_DISPLAY = getModelDisplayName(MODEL_NAME);f (streamingToggle) {
            console.log("Model saved:", MODEL_NAME, MODEL_NAME_DISPLAY);  ENABLE_STREAMING = streamingToggle.checked;
          } else {streamingEnabled', ENABLE_STREAMING.toString());
            console.warn("Model select not found or no value selected");sole.log(`Streaming preference saved: ${ENABLE_STREAMING}`);
          }
        } catch (modelErr) {
          console.error("Error getting model:", modelErr);g
        }lementById('webSearchToggle');
        
        // Save reasoning methodearch = webSearchToggle.checked;
        try {alStorage.setItem('webSearchEnabled', enableWebSearch.toString());
          const reasoningRadios = document.getElementsByName("reasoningMethod");onsole.log(`Web search preference saved: ${enableWebSearch}`);
          for (const radio of reasoningRadios) {
            if (radio.checked) {
              REASONING_METHOD = radio.value;/ Get model from select
              console.log("Reasoning method saved:", REASONING_METHOD);try {
              break;ementById("modelSelect");
            }value) {
          }EL_NAME = modelSelect.value.trim();
        } catch (reasoningErr) {
          console.error("Error getting reasoning method:", reasoningErr);
        }
        
        // Save COD word limit if applicable
        if (REASONING_METHOD === "cod") {
          try {
            // Get the selected CoD word limit option directly from DOM
            const selectedOption = document.querySelector('.cod-word-limit-option.border-primary-500');
            if (selectedOption) {
              const newValue = parseInt(selectedOption.getAttribute('data-value'));
              if (!isNaN(newValue)) {ios = document.getElementsByName("reasoningMethod");
                COD_WORD_LIMIT = newValue;
                console.log("COD word limit saved:", COD_WORD_LIMIT); if (radio.checked) {
              }     REASONING_METHOD = radio.value;
            } else {      console.log("Reasoning method saved:", REASONING_METHOD);
              console.warn("No selected COD word limit option found");
            }
          } catch (codErr) {
            console.error("Error getting COD word limit:", codErr);{
          }ningErr);
        }
        
        // Save enhanced reasoning settings Save COD word limit if applicable
        try {
          const enhancedToggle = document.getElementById('enhancedReasoningToggle');
          if (enhancedToggle) {  // Get the selected CoD word limit option directly from DOM
            ENHANCED_REASONING_ENABLED = enhancedToggle.checked;rySelector('.cod-word-limit-option.border-primary-500');
            console.log("Enhanced reasoning enabled:", ENHANCED_REASONING_ENABLED);
          }ption.getAttribute('data-value'));
          
          const adaptiveRadio = document.getElementById('adaptiveReasoning');
          const standardRadio = document.getElementById('standardReasoningEnhancement');   console.log("COD word limit saved:", COD_WORD_LIMIT);
          
          if (adaptiveRadio && standardRadio) { } else {
            if (adaptiveRadio.checked) {selected COD word limit option found");
              REASONING_ENHANCEMENT = 'adaptive';
            } else if (standardRadio.checked) { } catch (codErr) {
              REASONING_ENHANCEMENT = 'standard';    console.error("Error getting COD word limit:", codErr);
            }
            console.log("Reasoning enhancement:", REASONING_ENHANCEMENT);
          }
        } catch (enhancedErr) {ttings
          console.error("Error getting enhanced reasoning settings:", enhancedErr);
        }ggle');
        f (enhancedToggle) {
        // Save self-reflection settingsING_ENABLED = enhancedToggle.checked;
        try {ABLED);
          const selfReflectionToggle = document.getElementById('selfReflectionToggle'); }
          if (selfReflectionToggle) {  
            SELF_REFLECTION_ENABLED = selfReflectionToggle.checked;ptiveReasoning');
            console.log("Self-reflection enabled:", SELF_REFLECTION_ENABLED);st standardRadio = document.getElementById('standardReasoningEnhancement');
          }
        } catch (selfErr) { && standardRadio) {
          console.error("Error getting self-reflection settings:", selfErr);
        }
         } else if (standardRadio.checked) {
        // Save generation parameters safely with validation    REASONING_ENHANCEMENT = 'standard';
        try {
          const tempSlider = document.getElementById("temp");asoning enhancement:", REASONING_ENHANCEMENT);
          if (tempSlider) {
            TEMPERATURE = parseFloat(tempSlider.value);atch (enhancedErr) {
            if (TEMPERATURE === 0) TEMPERATURE = 0.01; // Ensure minimum valueconsole.error("Error getting enhanced reasoning settings:", enhancedErr);
          }
          
          const topPSlider = document.getElementById("topP");
          if (topPSlider) { {
            TOP_P = parseFloat(topPSlider.value);const selfReflectionToggle = document.getElementById('selfReflectionToggle');
          }
          selfReflectionToggle.checked;
          const topKSlider = document.getElementById("topK");BLED);
          if (topKSlider) {
            TOP_K = parseFloat(topKSlider.value);catch (selfErr) {
          }
          
          const presencePenaltySlider = document.getElementById("presencePenalty");
          if (presencePenaltySlider) {Save generation parameters safely with validation
            PRESENCE_PENALTY = parseFloat(presencePenaltySlider.value);y {
          }
          
          const frequencyPenaltySlider = document.getElementById("frequencyPenalty");
          if (frequencyPenaltySlider) {minimum value
            FREQUENCY_PENALTY = parseFloat(frequencyPenaltySlider.value);
          }
          topP");
          const maxTokensSlider = document.getElementById("maxTokens");
          if (maxTokensSlider) {
            // Enforce model's max_tokens limits (1-8192)
            const rawMaxTokens = parseInt(maxTokensSlider.value);
            MAX_TOKENS = Math.min(Math.max(1, rawMaxTokens), 8192);
            (topKSlider) {
            // Update the slider and display if needed TOP_K = parseFloat(topKSlider.value);
            if (MAX_TOKENS !== rawMaxTokens) {}
              maxTokensSlider.value = MAX_TOKENS;
              const valueDisplay = document.getElementById('maxTokensValue');tySlider = document.getElementById("presencePenalty");
              if (valueDisplay) valueDisplay.textContent = MAX_TOKENS;
              console.log(`Adjusted max_tokens from ${rawMaxTokens to ${MAX_TOKENS} to meet API requirements`);   PRESENCE_PENALTY = parseFloat(presencePenaltySlider.value);
            }  }
          }
          st frequencyPenaltySlider = document.getElementById("frequencyPenalty");
          console.log("Parameters saved:", {TEMPERATURE, TOP_P, TOP_K, MAX_TOKENS, PRESENCE_PENALTY, FREQUENCY_PENALTY});
        } catch (paramsErr) {lue);
          console.error("Error getting parameters:", paramsErr);
        }
        = document.getElementById("maxTokens");
        // Save settings to localStorage
        try {
          localStorage.setItem("modelName", MODEL_NAME);
          localStorage.setItem("reasoningMethod", REASONING_METHOD);s), 8192);
          localStorage.setItem("codWordLimit", COD_WORD_LIMIT.toString());
          console.log("Saved COD word limit to localStorage:", COD_WORD_LIMIT);
          // ...existing code...
          localStorage.setItem("enhancedReasoningEnabled", ENHANCED_REASONING_ENABLED.toString());
          localStorage.setItem("reasoningEnhancement", REASONING_ENHANCEMENT);
          localStorage.setItem("temperature", TEMPERATURE.toString());    if (valueDisplay) valueDisplay.textContent = MAX_TOKENS;
          localStorage.setItem("topP", TOP_P.toString());ted max_tokens from ${rawMaxTokens} to ${MAX_TOKENS} to meet API requirements`);
          localStorage.setItem("topK", TOP_K.toString());
          localStorage.setItem("presencePenalty", PRESENCE_PENALTY.toString());
          localStorage.setItem("frequencyPenalty", FREQUENCY_PENALTY.toString());
          localStorage.setItem("maxTokens", MAX_TOKENS.toString());ers saved:", {TEMPERATURE, TOP_P, TOP_K, MAX_TOKENS, PRESENCE_PENALTY, FREQUENCY_PENALTY});
          localStorage.setItem("selfReflectionEnabled", SELF_REFLECTION_ENABLED.toString());
           console.error("Error getting parameters:", paramsErr);
          // Save custom prompts}
          localStorage.setItem("customPrompts", JSON.stringify(PROMPTS));
          localStorage.setItem("enhancedPrompts", JSON.stringify(ENHANCED_PROMPTS));rage
          console.log("Settings saved to localStorage");try {
        } catch (storageErr) {m("modelName", MODEL_NAME);
          console.error("Error saving to localStorage:", storageErr);  localStorage.setItem("reasoningMethod", REASONING_METHOD);
        }imit", COD_WORD_LIMIT.toString());
        localStorage:", COD_WORD_LIMIT);
        // Update model display
        updateCurrentModelDisplay(); ENHANCED_REASONING_ENABLED.toString());
        NING_ENHANCEMENT);
        closeSettingsModal();
        torage.setItem("topP", TOP_P.toString());
        // Show appropriate notificationtoString());
        if (prevMethod !== REASONING_METHOD ||  localStorage.setItem("presencePenalty", PRESENCE_PENALTY.toString());
            (REASONING_METHOD === "cod" && prevMethod === "cod" && prevWordLimit !== COD_WORD_LIMIT) ||e.setItem("frequencyPenalty", FREQUENCY_PENALTY.toString());
            prevEnhanced !== ENHANCED_REASONING_ENABLED ||S.toString());
            prevEnhancementType !== REASONING_ENHANCEMENT) {led", SELF_REFLECTION_ENABLED.toString());
          showNotification("Settings saved - reasoning method changed");   
        } else {     // Save custom prompts
          showNotification("Settings saved");      localStorage.setItem("customPrompts", JSON.stringify(PROMPTS));
        }em("enhancedPrompts", JSON.stringify(ENHANCED_PROMPTS));
      } catch (err) {g("Settings saved to localStorage");
        console.error("Error in saveSettings:", err);{
        showNotification("Error saving settings");ving to localStorage:", storageErr);
      }
    }
    
    /***********************
     * Feedback Form
     ***********************/
    function initFeedbackForm() {
      // Get references to elements  // Show appropriate notification
      const openBtn = document.getElementById('openFeedbackBtn');|| 
      const mobileOpenBtn = document.getElementById('mobileOpenFeedbackBtn');od" && prevMethod === "cod" && prevWordLimit !== COD_WORD_LIMIT) ||
      const modal = document.getElementById('feedbackModal'); ||
      const closeBtn = document.getElementById('closeFeedbackModal');
      const modelInput = document.getElementById('feedbackModel');ettings saved - reasoning method changed");
      const reasoningInput = document.getElementById('feedbackReasoning');
      );
      // Function to open the feedback modal
      function openFeedbackModal() {ch (err) {
        // Update hidden fields with current model inforr);
        if (modelInput) modelInput.value = MODEL_NAME_DISPLAY || 'Not set';howNotification("Error saving settings");
        if (reasoningInput) {
          let reasoningMethod = REASONING_METHOD.toUpperCase();
          if (REASONING_METHOD === 'cod') {
            reasoningMethod += `-${COD_WORD_LIMIT}`;*********************
          } Feedback Form
          reasoningInput.value = reasoningMethod;
        }dbackForm() {
        
        // Show the modalonst openBtn = document.getElementById('openFeedbackBtn');
        if (modal) modal.style.display = 'flex';const mobileOpenBtn = document.getElementById('mobileOpenFeedbackBtn');
      }nt.getElementById('feedbackModal');
      edbackModal');
      // Set up event listenerstById('feedbackModel');
      if (openBtn) {
        openBtn.addEventListener('click', openFeedbackModal);
      }unction to open the feedback modal
      
      if (mobileOpenBtn) {s with current model info
        mobileOpenBtn.addEventListener('click', () => {(modelInput) modelInput.value = MODEL_NAME_DISPLAY || 'Not set';
          // First close the mobile sidebar if (reasoningInput) {
          document.getElementById("mobileSidebar").classList.remove("translate-x-0");    let reasoningMethod = REASONING_METHOD.toUpperCase();
          document.getElementById("mobileSidebar").classList.add("-translate-x-full");NG_METHOD === 'cod') {
          `;
          // Then open the feedback modal
          openFeedbackModal();easoningInput.value = reasoningMethod;
        }); }
      }  
      
      if (closeBtn) { modal.style.display = 'flex';
        closeBtn.addEventListener('click', () => {
          if (modal) modal.style.display = 'none';
        });
      }penBtn) {
      nBtn.addEventListener('click', openFeedbackModal);
      // Close modal when clicking outside
      if (modal) {
        modal.addEventListener('click', (event) => {
          if (event.target === modal) {
            modal.style.display = 'none';t close the mobile sidebar
          }").classList.remove("translate-x-0");
        });ById("mobileSidebar").classList.add("-translate-x-full");
      }
      dal
      // Show success message after form submission
      const form = document.querySelector('form[name="feedback"]');;
      if (form) {
        form.addEventListener('submit', (e) => {
          e.preventDefault();closeBtn) {
          stener('click', () => {
          // Show success notificationdal.style.display = 'none';
          showNotification('Thank you for your feedback!');
          
          // Close the modal 
          if (modal) modal.style.display = 'none';  // Close modal when clicking outside
          
          // Reset the formstener('click', (event) => {
          form.reset();= modal) {
        });ne';
      }
    }
    
    /***********************
     * Mobile Navigationon
     ***********************/k"]');
    function initMobileNavigation() {
      const mobileSidebarToggle = document.getElementById('mobileSidebarToggle');
      const mobileSidebar = document.getElementById('mobileSidebar');.preventDefault();
      const closeMobileSidebar = document.getElementById('closeMobileSidebar');   
          // Show success notification
      if (mobileSidebarToggle && mobileSidebar) {eedback!');
        mobileSidebarToggle.addEventListener('click', () => {
          mobileSidebar.classList.remove('-translate-x-full');
          mobileSidebar.classList.add('translate-x-0');
        });
      }   // Reset the form
          form.reset();
      if (closeMobileSidebar && mobileSidebar) {
        closeMobileSidebar.addEventListener('click', () => {
          mobileSidebar.classList.remove('translate-x-0');
          mobileSidebar.classList.add('-translate-x-full');
        });
      }bile Navigation
      **********************/
      // Mobile buttons should trigger their desktop counterparts
      document.getElementById('mobileNewThreadBtn')?.addEventListener('click', () => {e = document.getElementById('mobileSidebarToggle');
        createNewThread();ileSidebar');
        mobileSidebar.classList.remove('translate-x-0');'closeMobileSidebar');
        mobileSidebar.classList.add('-translate-x-full');
      });if (mobileSidebarToggle && mobileSidebar) {
      
      document.getElementById('mobileDeleteThreadBtn')?.addEventListener('click', () => {ove('-translate-x-full');
        deleteCurrentThread();
        mobileSidebar.classList.remove('translate-x-0');
        mobileSidebar.classList.add('-translate-x-full');
      });
      
      document.getElementById('mobileDownloadTxtBtn')?.addEventListener('click', () => {stener('click', () => {
        downloadCurrentThreadAsTxt(););
        mobileSidebar.classList.remove('translate-x-0'););
        mobileSidebar.classList.add('-translate-x-full'););
      });}
      
      document.getElementById('mobileDownloadPdfBtn')?.addEventListener('click', () => {parts
        downloadCurrentThreadAsPdf();('click', () => {
        mobileSidebar.classList.remove('translate-x-0');();
        mobileSidebar.classList.add('-translate-x-full');emove('translate-x-0');
      });slate-x-full');
      
      document.getElementById('mobileClearThreadBtn')?.addEventListener('click', () => {
        if (confirm("Clear all messages in this thread?")) {ument.getElementById('mobileDeleteThreadBtn')?.addEventListener('click', () => {
          const thread = threads.find(t => t.id === currentThreadId);
          if (thread) {
            thread.messages = [];obileSidebar.classList.add('-translate-x-full');
            renderCurrentThreadMessages(); });
            showNotification("Thread cleared");  
          }d('mobileDownloadTxtBtn')?.addEventListener('click', () => {
        }ntThreadAsTxt();
        mobileSidebar.classList.remove('translate-x-0');st.remove('translate-x-0');
        mobileSidebar.classList.add('-translate-x-full');translate-x-full');
      });
    }
    ntListener('click', () => {
    /***********************downloadCurrentThreadAsPdf();
     * Initialization
     ***********************/mobileSidebar.classList.add('-translate-x-full');
    function loadPersistedSettings() {
      try {
        MODEL_NAME = localStorage.getItem("modelName") || "";?.addEventListener('click', () => {
        MODEL_NAME_DISPLAY = getModelDisplayName(MODEL_NAME);ges in this thread?")) {
        > t.id === currentThreadId);
        REASONING_METHOD = localStorage.getItem("reasoningMethod") || "cod";
         thread.messages = [];
        const codWordLimit = localStorage.getItem("codWordLimit");   renderCurrentThreadMessages();
        if (codWordLimit) {    showNotification("Thread cleared");
          const parsedLimit = parseInt(codWordLimit);
          if (!isNaN(parsedLimit)) {
            COD_WORD_LIMIT = parsedLimit;'translate-x-0');
            console.log("Loaded COD word limit:", COD_WORD_LIMIT);
          }
        }
        
        // Load enhanced reasoning settings
        const enhancedEnabled = localStorage.getItem("enhancedReasoningEnabled");
        if (enhancedEnabled !== null) {*******************/
          ENHANCED_REASONING_ENABLED = enhancedEnabled === "true";tion loadPersistedSettings() {
        }
        
        const enhancementType = localStorage.getItem("reasoningEnhancement"); getModelDisplayName(MODEL_NAME);
        if (enhancementType) {
          REASONING_ENHANCEMENT = enhancementType;"cod";
        }
        onst codWordLimit = localStorage.getItem("codWordLimit");
        // Load custom prompts if availableif (codWordLimit) {
        const storedPrompts = localStorage.getItem("customPrompts");dLimit);
        if (storedPrompts) {
          const parsedPrompts = JSON.parse(storedPrompts);imit;
          // Merge with default prompts to ensure all properties exist
          PROMPTS = { ...PROMPTS, ...parsedPrompts };
        }
        
        // Load enhanced prompts if available// Load enhanced reasoning settings
        const storedEnhancedPrompts = localStorage.getItem("enhancedPrompts");ancedReasoningEnabled");
        if (storedEnhancedPrompts) {
          const parsedEnhancedPrompts = JSON.parse(storedEnhancedPrompts);  ENHANCED_REASONING_ENABLED = enhancedEnabled === "true";
          // Merge with default prompts to ensure all properties exist
          ENHANCED_PROMPTS = { ...ENHANCED_PROMPTS, ...parsedEnhancedPrompts };
        }const enhancementType = localStorage.getItem("reasoningEnhancement");
        
        const temp = localStorage.getItem("temperature");ntType;
        if (temp) TEMPERATURE = parseFloat(temp);}
        
        const topP = localStorage.getItem("topP");
        if (topP) TOP_P = parseFloat(topP);const storedPrompts = localStorage.getItem("customPrompts");
        
        const topK = localStorage.getItem("topK");
        if (topK) TOP_K = parseFloat(topK);  // Merge with default prompts to ensure all properties exist
        
        const presencePenalty = localStorage.getItem("presencePenalty");
        if (presencePenalty) PRESENCE_PENALTY = parseFloat(presencePenalty);
        lable
        const frequencyPenalty = localStorage.getItem("frequencyPenalty");
        if (frequencyPenalty) FREQUENCY_PENALTY = parseFloat(frequencyPenalty);
        pts);
        const maxTokens = localStorage.getItem("maxTokens"); // Merge with default prompts to ensure all properties exist
        if (maxTokens) MAX_TOKENS = parseInt(maxTokens);  ENHANCED_PROMPTS = { ...ENHANCED_PROMPTS, ...parsedEnhancedPrompts };
        
        // Load self-reflection settings
        const selfReflectionEnabled = localStorage.getItem("selfReflectionEnabled");"temperature");
        if (selfReflectionEnabled !== null) {
          SELF_REFLECTION_ENABLED = selfReflectionEnabled === 'true';
        }const topP = localStorage.getItem("topP");
        topP);
        // Load streaming preference
        const savedStreamingPref = localStorage.getItem('streamingEnabled');m("topK");
        if (savedStreamingPref !== null) {
          ENABLE_STREAMING = savedStreamingPref === 'true';
        }ePenalty = localStorage.getItem("presencePenalty");
        loat(presencePenalty);
        // Load web search preference 
        const webSearchEnabled = localStorage.getItem('webSearchEnabled');   const frequencyPenalty = localStorage.getItem("frequencyPenalty");
        if (webSearchEnabled !== null) {    if (frequencyPenalty) FREQUENCY_PENALTY = parseFloat(frequencyPenalty);
          enableWebSearch = webSearchEnabled === 'true';
        }tItem("maxTokens");
      } catch (err) {  if (maxTokens) MAX_TOKENS = parseInt(maxTokens);
        console.error("Error loading settings:", err);
      }settings
    }ocalStorage.getItem("selfReflectionEnabled");
    if (selfReflectionEnabled !== null) {
    function initApp() {d === 'true';
      console.log("Initializing app...");
      
      try {// Load streaming preference
        loadPersistedSettings();ngPref = localStorage.getItem('streamingEnabled');
        console.log("Settings loaded");
          ENABLE_STREAMING = savedStreamingPref === 'true';
        // Update CoD prompt with the correct word limit
        updateCoDPrompt();
        console.log("CoD prompt updated");
        const webSearchEnabled = localStorage.getItem('webSearchEnabled');
        createNewThread();{
        console.log("New thread created");SearchEnabled === 'true';
        
        // Set up event listenerscatch (err) {
        initEventListeners(); settings:", err);
        console.log("Event listeners initialized");
        
        // Initialize mobile navigation
        initMobileNavigation();
        console.log("Mobile navigation initialized");
        
        updateCurrentModelDisplay();
        console.log("Model display updated");
         loaded");
        // Initialize feedback form
        initFeedbackForm();
        console.log("Feedback form initialized");
        ompt updated");
        // Add clear thread button event listener
        const clearThreadBtn = document.getElementById("clearThreadBtn");
        if (clearThreadBtn) {
          clearThreadBtn.addEventListener("click", () => {
            if (confirm("Clear all messages in this thread?")) {t up event listeners
              const thread = threads.find(t => t.id === currentThreadId);ventListeners();
              if (thread) {
                thread.messages = [];
                renderCurrentThreadMessages();// Initialize mobile navigation
                showNotification("Thread cleared");
              }e navigation initialized");
            }
          });splay();
          console.log("Clear thread button initialized");og("Model display updated");
        }
        
        // If we don't have a model name, open settings modal
        if (!MODEL_NAME) {
          console.log("No model name found, opening settings");
          setTimeout(() => {r thread button event listener
            try {onst clearThreadBtn = document.getElementById("clearThreadBtn");
              openSettingsModal();adBtn) {
              console.log("Settings modal opened");) => {
            } catch (err) {     if (confirm("Clear all messages in this thread?")) {
              console.error("Error opening settings modal:", err);         const thread = threads.find(t => t.id === currentThreadId);
            }          if (thread) {
          }, 1000);];
        }     renderCurrentThreadMessages();
      } catch (err) {
        console.error("Initialization error:", err);      }
      }
    }
    ");
    function initEventListeners() {
      try {
        console.log("Initializing event listeners");on't have a model name, open settings modal
        
        // Helper function to safely add event listenersonsole.log("No model name found, opening settings");
        const addListener = (id, event, handler) => {setTimeout(() => {
          const element = document.getElementById(id);    try {
          if (element) {odal();
            element.addEventListener(event, handler);
          } else {
            console.warn(`Element with id "${id}" not found for event listener`););
          }
        };  }, 1000);
        
        // Settings buttons
        addListener("openSettings", "click", openSettingsModal);
        addListener("closeSettings", "click", closeSettingsModal);
        addListener("closeModalX", "click", closeSettingsModal);
        addListener("saveSettings", "click", saveSettings);
        
        // Thread management
        addListener("newThreadBtn", "click", createNewThread);ializing event listeners");
        addListener("deleteThreadBtn", "click", deleteCurrentThread);
        addListener("downloadTxtBtn", "click", downloadCurrentThreadAsTxt);nt listeners
        addListener("downloadPdfBtn", "click", downloadCurrentThreadAsPdf);=> {
        addListener("clearThreadBtn", "click", () => {st element = document.getElementById(id);
          if (confirm("Clear all messages in this thread?")) {f (element) {
            const thread = threads.find(t => t.id === currentThreadId); element.addEventListener(event, handler);
            if (thread) {  } else {
              thread.messages = [];ement with id "${id}" not found for event listener`);
              renderCurrentThreadMessages();
              showNotification("Thread cleared");};
            }
          }
        });enSettings", "click", openSettingsModal);
        ettingsModal);
        // Web search toggletingsModal);
        addListener("webSearchBtn", "click", toggleWebSearch);, saveSettings);
        
        // Message inputread management
        const textarea = document.getElementById('userInput');dListener("newThreadBtn", "click", createNewThread);
        if (textarea) {urrentThread);
          textarea.addEventListener('input', () => {loadCurrentThreadAsTxt);
            // Auto-resize textarea based on contenttn", "click", downloadCurrentThreadAsPdf);
            textarea.style.height = 'auto';
            textarea.style.height = (textarea.scrollHeight) + 'px';(confirm("Clear all messages in this thread?")) {
          });onst thread = threads.find(t => t.id === currentThreadId);
             if (thread) {
          textarea.addEventListener('keydown', (e) => {      thread.messages = [];
            if (e.key === 'Enter' && !e.shiftKey) {rrentThreadMessages();
              e.preventDefault(););
              document.getElementById('sendBtn')?.click();
            }
          });
        }
        
        // Send button, "click", toggleWebSearch);
        addListener("sendBtn", "click", () => {
          const textarea = document.getElementById('userInput');ssage input
          if (textarea) {st textarea = document.getElementById('userInput');
            const message = textarea.value.trim();(textarea) {
            if (message || attachedFiles.length > 0) {  textarea.addEventListener('input', () => {
              sendMessage(message);ea based on content
              textarea.value = '';.height = 'auto';
              textarea.style.height = 'auto';    textarea.style.height = (textarea.scrollHeight) + 'px';
            }
          }
        });
        
        // Initialize file upload
        handleFileInput();   document.getElementById('sendBtn')?.click();
          }
        // Close modal when clicking outside
        window.addEventListener("click", (event) => {
          const settingsModal = document.getElementById("settingsModal");
          if (settingsModal && event.target === settingsModal) {Send button
            closeSettingsModal();Listener("sendBtn", "click", () => {
          }  const textarea = document.getElementById('userInput');
          
          const feedbackModal = document.getElementById("feedbackModal");= textarea.value.trim();
          if (feedbackModal && event.target === feedbackModal) {(message || attachedFiles.length > 0) {
            feedbackModal.style.display = 'none';);
          } '';
        });eight = 'auto';
        
        // Set up settings UI functionality
        setTimeout(() => {
          try {
            setupTabNavigation();e upload
            setupModelInput();
            setupCODOptions();
            setupEnhancedReasoningOptions(); modal when clicking outside
            setupSliders();ntListener("click", (event) => {
            initSelfReflection();odal");
            console.log("UI functionality setup complete");   if (settingsModal && event.target === settingsModal) {
          } catch (err) {       closeSettingsModal();
            console.error("Error setting up UI functionality:", err);      }
          }
        }, 100);al");
      } catch (err) {f (feedbackModal && event.target === feedbackModal) {
        console.error("Error initializing event listeners:", err);
      }  }
    }
    
    // Initialize the application
    document.addEventListener("DOMContentLoaded", async function() {etTimeout(() => {
      try {
        console.log("Starting application initialization...");();
        
        // Dark mode detectionODOptions();
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
          document.documentElement.classList.add('dark'); setupSliders();
        } initSelfReflection();
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {    console.log("UI functionality setup complete");
          if (event.matches) {
            document.documentElement.classList.add('dark');r("Error setting up UI functionality:", err);
          } else {
            document.documentElement.classList.remove('dark');}, 100);
          }
        });
        
        // Initialize the app
        await initApp();
        console.log("Application initialized successfully");itialize the application
        ment.addEventListener("DOMContentLoaded", async function() {
        // Initialize Web search button state
        const webSearchBtn = document.getElementById('webSearchBtn');
        if (webSearchBtn && enableWebSearch) {
          webSearchBtn.classList.add('bg-primary-500', 'text-white'); // Dark mode detection
          webSearchBtn.classList.remove('bg-dark-500', 'text-gray-300'); if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        }ocument.documentElement.classList.add('dark');
                }
      } catch (error) {        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
        console.error("Error during application initialization:", error);event.matches) {
        showNotification("Error initializing application. Please refresh the page.");            document.documentElement.classList.add('dark');







</body></html>  </script>    });      }          } else {
            document.documentElement.classList.remove('dark');
          }
        });
        
        // Initialize the app
        await initApp();
        console.log("Application initialized successfully");
        
        // Initialize Web search button state
        const webSearchBtn = document.getElementById('webSearchBtn');
        if (webSearchBtn && enableWebSearch) {
          webSearchBtn.classList.add('bg-primary-500', 'text-white');
          webSearchBtn.classList.remove('bg-dark-500', 'text-gray-300');
        }
        
      } catch (error) {
        console.error("Error during application initialization:", error);
        showNotification("Error initializing application. Please refresh the page.");
      }
    });
  </script>


</body></html>
