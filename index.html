<!DOCTYPE html><html lang="en"><head><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP Research Lab</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/0.5.0-beta4/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        primaryDark: '#4B4AC9',
                        primaryLight: '#7E7DE8',
                        dark: {
                            bg: '#121212',
                            card: '#1E1E1E',
                            input: '#2D2D2D',
                            text: '#F9FAFB'
                        },
                        light: {
                            bg: '#F9FAFB',
                            card: '#FFFFFF',
                            input: '#F3F4F6',
                            text: '#1F2937'
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite'
                    }
                }
            }
        }
    </script>
    <style>
        /* Markdown styling */
        .markdown-content h1 { font-size: 1.8rem; font-weight: bold; margin-top: 1.5rem; margin-bottom: 0.75rem; }
        .markdown-content h2 { font-size: 1.5rem; font-weight: bold; margin-top: 1.25rem; margin-bottom: 0.75rem; }
        .markdown-content h3 { font-size: 1.25rem; font-weight: bold; margin-top: 1rem; margin-bottom: 0.5rem; }
        .markdown-content h4 { font-size: 1.1rem; font-weight: bold; margin-top: 1rem; margin-bottom: 0.5rem; }
        .markdown-content p { margin-bottom: 0.75rem; }
        .markdown-content ul, .markdown-content ol { margin-left: 2rem; margin-bottom: 0.75rem; }
        .markdown-content ul { list-style-type: disc; }
        .markdown-content ol { list-style-type: decimal; }
        .markdown-content pre { background-color: #f0f0f0; padding: 0.75rem; border-radius: 0.25rem; margin-bottom: 0.75rem; overflow-x: auto; }
        .dark .markdown-content pre { background-color: #2d2d2d; }
        .markdown-content code { font-family: monospace; }
        .markdown-content blockquote { border-left: 4px solid #ddd; padding-left: 1rem; margin-left: 0; margin-bottom: 0.75rem; }
        .dark .markdown-content blockquote { border-left-color: #555; }
        .markdown-content img { max-width: 100%; height: auto; margin: 1rem 0; }
        .markdown-content table { border-collapse: collapse; margin-bottom: 0.75rem; width: 100%; }
        .markdown-content th, .markdown-content td { border: 1px solid #ddd; padding: 0.5rem; }
        .dark .markdown-content th, .dark .markdown-content td { border-color: #555; }
        
        /* Step timeline indicators */
        .timeline-container {
            position: relative;
        }
        
        .timeline-line {
            position: absolute;
            left: 15px;
            top: 24px;
            bottom: 0;
            width: 2px;
            background-color: #5D5CDE;
        }
        
        .timeline-step:last-child .timeline-line {
            display: none;
        }
        
        /* Typing animation */
        .typing-animation::after {
            content: "|";
            animation: blink 1s step-end infinite;
        }
        
        @keyframes blink {
            from, to { opacity: 1; }
            50% { opacity: 0; }
        }
        
        /* Progress bar animation */
        @keyframes progress {
            from { width: 0; }
            to { width: 100%; }
        }
        
        .animate-progress {
            animation: progress var(--duration, 5s) linear forwards;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(156, 163, 175, 0.5);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(156, 163, 175, 0.7);
        }
        
        .dark ::-webkit-scrollbar-thumb {
            background: rgba(75, 85, 99, 0.5);
        }
        
        .dark ::-webkit-scrollbar-thumb:hover {
            background: rgba(75, 85, 99, 0.7);
        }
    </style>
</head>
<body class="bg-light-bg dark:bg-dark-bg text-light-text dark:text-dark-text transition-colors duration-300">
    <div class="min-h-screen flex flex-col">
        <header class="border-b border-gray-200 dark:border-gray-800 bg-white dark:bg-dark-card shadow-sm z-10">
            <div class="container max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-primary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19.9 13.5a9 9 0 1 1-9-9 9 9 0 0 1 9 9Z"></path>
                        <path d="M12 4.5V9"></path>
                        <path d="M9 2h6"></path>
                        <path d="M19.5 13.5 16 17"></path>
                    </svg>
                    <h1 class="text-xl md:text-2xl font-bold">MCP Research Lab</h1>
                </div>
                <button id="themeToggle" class="flex items-center justify-center w-10 h-10 rounded-full bg-light-input dark:bg-dark-input hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors duration-200">
                    <!-- Moon icon for light mode -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-700 dark:hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path>
                    </svg>
                    <!-- Sun icon for dark mode -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-300 hidden dark:block" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="4"></circle>
                        <path d="M12 2v2"></path>
                        <path d="M12 20v2"></path>
                        <path d="m4.93 4.93 1.41 1.41"></path>
                        <path d="m17.66 17.66 1.41 1.41"></path>
                        <path d="M2 12h2"></path>
                        <path d="M20 12h2"></path>
                        <path d="m6.34 17.66-1.41 1.41"></path>
                        <path d="m19.07 4.93-1.41 1.41"></path>
                    </svg>
                </button>
            </div>
        </header>

        <main class="flex-1 container max-w-6xl mx-auto px-4 py-8">
            <!-- Introduction Card -->
            <section id="introCard" class="bg-light-card dark:bg-dark-card rounded-xl p-6 mb-8 shadow-md transition-all duration-300">
                <div class="flex items-start space-x-4">
                    <div class="rounded-full bg-primary/10 p-3 text-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                            <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
                        </svg>
                    </div>
                    <div class="flex-1">
                        <h2 class="text-xl font-bold mb-2">Powered by MCP Agent Army</h2>
                        <p class="text-gray-600 dark:text-gray-300 mb-4">This professional research tool uses Model Context Protocol (MCP) and specialized agents to deliver comprehensive analysis on any topic. The system orchestrates multiple specialized agents through Vercel-hosted services to conduct deep exploration and synthesize findings.</p>
                        <div class="flex flex-wrap gap-2">
                            <div class="bg-primary/10 dark:bg-primary/20 text-primary px-3 py-1 rounded-full text-sm">Brave Search</div>
                            <div class="bg-primary/10 dark:bg-primary/20 text-primary px-3 py-1 rounded-full text-sm">Firecrawl</div>
                            <div class="bg-primary/10 dark:bg-primary/20 text-primary px-3 py-1 rounded-full text-sm">Data Analysis</div>
                            <div class="bg-primary/10 dark:bg-primary/20 text-primary px-3 py-1 rounded-full text-sm">GitHub</div>
                            <div class="bg-primary/10 dark:bg-primary/20 text-primary px-3 py-1 rounded-full text-sm">Airtable</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Input Section -->
            <section id="inputSection" class="bg-light-card dark:bg-dark-card rounded-xl p-6 mb-8 shadow-md transition-all duration-300">
                <h2 class="text-xl font-bold mb-4 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-primary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="m12 19-2 2-2-2"></path>
                        <path d="M4 4v9a4 4 0 0 0 4 4h12"></path>
                        <path d="m8 17 4 4 4-4"></path>
                        <path d="M5 8h14"></path>
                        <path d="M5 12h4"></path>
                    </svg>
                    Research Configuration
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="researchTopic" class="block text-sm font-medium mb-2">Research Topic</label>
                        <textarea id="researchTopic" rows="4" placeholder="Enter a detailed description of what you'd like to research..." class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 focus:border-primary focus:ring-2 focus:ring-primary focus:outline-none bg-light-input dark:bg-dark-input dark:border-gray-700 dark:text-white"></textarea>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label for="researchDepth" class="block text-sm font-medium mb-2">Research Depth</label>
                            <select id="researchDepth" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 focus:border-primary focus:ring-2 focus:ring-primary focus:outline-none bg-light-input dark:bg-dark-input dark:border-gray-700 dark:text-white">
                                <option value="quick">Quick (5-10 min)</option>
                                <option value="standard" selected="">Standard (15-30 min)</option>
                                <option value="comprehensive">Comprehensive (30-60 min)</option>
                            </select>
                        </div>
                        <div>
                            <label for="primaryAgentSelector" class="block text-sm font-medium mb-2">Primary MCP Agent</label>
                            <select id="primaryAgentSelector" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 focus:border-primary focus:ring-2 focus:ring-primary focus:outline-none bg-light-input dark:bg-dark-input dark:border-gray-700 dark:text-white">
                                <option value="all" selected="">Orchestration Agent (Use All Tools)</option>
                                <option value="brave">Brave Search Agent</option>
                                <option value="firecrawl">Firecrawl Web Extraction Agent</option>
                                <option value="airtable">Airtable Agent</option>
                                <option value="github">GitHub Agent</option>
                                <option value="filesystem">Filesystem Agent</option>
                            </select>
                        </div>
                        <div>
                            <label for="researchStyle" class="block text-sm font-medium mb-2">Research Style</label>
                            <select id="researchStyle" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 focus:border-primary focus:ring-2 focus:ring-primary focus:outline-none bg-light-input dark:bg-dark-input dark:border-gray-700 dark:text-white">
                                <option value="standard" selected="">Standard</option>
                                <option value="academic">Academic</option>
                                <option value="journalistic">Journalistic</option>
                                <option value="strategic">Strategic Analysis</option>
                                <option value="technical">Technical</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="mt-4">
                    <div class="flex items-center justify-between mb-2">
                        <label class="block text-sm font-medium">Advanced Settings</label>
                        <button id="advancedSettingsToggle" class="text-sm text-primary hover:text-primaryDark transition-colors duration-200">
                            Show Advanced Settings
                        </button>
                    </div>
                    <div id="advancedSettings" class="hidden space-y-4 p-4 border border-gray-200 dark:border-gray-700 rounded-lg mt-2 bg-gray-50 dark:bg-gray-800/30">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="temperature" class="block text-sm font-medium mb-2">Temperature</label>
                                <div class="flex items-center space-x-4">
                                    <input type="range" id="temperature" min="0" max="1" step="0.1" value="0.6" class="w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-lg appearance-none cursor-pointer">
                                    <span id="temperatureValue" class="text-sm min-w-12 text-center">0.6</span>
                                </div>
                                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Lower values for more focused research, higher for more creative exploration</p>
                            </div>
                            <div>
                                <label for="outputFormat" class="block text-sm font-medium mb-2">Output Format</label>
                                <select id="outputFormat" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 focus:border-primary focus:ring-2 focus:ring-primary focus:outline-none bg-light-input dark:bg-dark-input dark:border-gray-700 dark:text-white">
                                    <option value="report" selected="">Complete Report</option>
                                    <option value="debug">Debug Mode (Show Thinking Process)</option>
                                    <option value="dual">Dual Mode (Thinking + Final Report)</option>
                                </select>
                                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Choose how to display the research process and results</p>
                            </div>
                        </div>
                        <div>
                            <label for="chartType" class="block text-sm font-medium mb-2">Data Visualization</label>
                            <select id="chartType" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 focus:border-primary focus:ring-2 focus:ring-primary focus:outline-none bg-light-input dark:bg-dark-input dark:border-gray-700 dark:text-white">
                                <option value="auto" selected="">Automatic (Based on Data)</option>
                                <option value="bar">Bar Charts</option>
                                <option value="line">Line Charts</option>
                                <option value="pie">Pie Charts</option>
                                <option value="scatter">Scatter Plots</option>
                                <option value="none">No Charts</option>
                            </select>
                            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Select the type of visualization to include in the research</p>
                        </div>
                        <div>
                            <label for="mcpTools" class="block text-sm font-medium mb-2">MCP Tools</label>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                                <div class="flex items-center">
                                    <input type="checkbox" id="braveSearch" class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary" checked="">
                                    <label for="braveSearch" class="ml-2 text-sm">Brave Search</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="firecrawl" class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary" checked="">
                                    <label for="firecrawl" class="ml-2 text-sm">Firecrawl</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="airtable" class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary">
                                    <label for="airtable" class="ml-2 text-sm">Airtable</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="github" class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary">
                                    <label for="github" class="ml-2 text-sm">GitHub</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="filesystem" class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary">
                                    <label for="filesystem" class="ml-2 text-sm">File System</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="slack" class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary">
                                    <label for="slack" class="ml-2 text-sm">Slack</label>
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="maxTokens" class="block text-sm font-medium mb-2">Max Tokens</label>
                                <div class="relative">
                                    <select id="maxTokens" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 focus:border-primary focus:ring-2 focus:ring-primary focus:outline-none bg-light-input dark:bg-dark-input dark:border-gray-700 dark:text-white">
                                        <option value="8192">8,192 tokens</option>
                                        <option value="16384">16,384 tokens</option>
                                        <option value="20480" selected="">20,480 tokens (Recommended)</option>
                                        <option value="32768">32,768 tokens (Maximum)</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label for="sessionId" class="block text-sm font-medium mb-2">Session ID</label>
                                <input type="text" id="sessionId" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 focus:border-primary focus:ring-2 focus:ring-primary focus:outline-none bg-light-input dark:bg-dark-input dark:border-gray-700 dark:text-white" placeholder="Optional - For continuing research">
                                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">For continuing previous research sessions</p>
                            </div>
                        </div>
                    </div>
                </div>
                <button id="startResearch" class="w-full mt-6 bg-primary hover:bg-primaryDark text-white font-medium py-3 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.3-4.3"></path>
                    </svg>
                    Start Comprehensive Research
                </button>
            </section>

            <!-- Research Progress Section (Initially Hidden) -->
            <section id="researchProgress" class="hidden bg-light-card dark:bg-dark-card rounded-xl p-6 mb-8 shadow-md transition-all duration-300">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-primary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 16a4 4 0 1 0 0-8 4 4 0 0 0 0 8Z"></path>
                            <path d="M12 8v1"></path>
                            <path d="M12 15v1"></path>
                            <path d="M8 12H7"></path>
                            <path d="M17 12h-1"></path>
                            <circle cx="12" cy="12" r="9"></circle>
                        </svg>
                        Research in Progress
                    </h2>
                    <div class="flex items-center text-sm text-gray-500 dark:text-gray-400">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 animate-pulse text-primary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <path d="M12 6v6l4 2"></path>
                        </svg>
                        <span id="elapsedTime">00:00</span>
                    </div>
                </div>
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center">
                        <div class="w-2 h-2 rounded-full bg-primary animate-pulse mr-2"></div>
                        <p class="text-sm font-medium" id="currentStepLabel">Initializing research...</p>
                    </div>
                    <div class="text-sm font-medium" id="progressPercentage">0%</div>
                </div>
                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 mb-6">
                    <div id="progressBar" class="bg-primary h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <div id="progressSteps" class="space-y-1 mb-6">
                    <!-- Timeline steps will be added here dynamically -->
                </div>
                <div class="bg-gray-100 dark:bg-gray-800 rounded-lg p-4 mb-4 max-h-64 overflow-y-auto" id="streamingOutput">
                    <p class="text-sm font-mono typing-animation">Initializing research process...</p>
                </div>
                <button id="cancelResearch" class="text-red-500 hover:text-red-700 text-sm font-medium mt-2 flex items-center transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="m15 9-6 6"></path>
                        <path d="m9 9 6 6"></path>
                    </svg>
                    Cancel Research
                </button>
            </section>

            <!-- Research Results Section (Initially Hidden) -->
            <section id="researchResults" class="hidden space-y-8 transition-all duration-300">
                <div class="bg-light-card dark:bg-dark-card rounded-xl p-6 shadow-md">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-bold flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-primary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                                <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
                            </svg>
                            Research Summary
                        </h2>
                        <div class="flex items-center space-x-2">
                            <button id="copyResults" class="inline-flex items-center px-3 py-1.5 text-sm font-medium rounded-md bg-gray-100 hover:bg-gray-200 dark:bg-gray-800 dark:hover:bg-gray-700 transition-colors duration-200">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect>
                                    <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path>
                                </svg>
                                Copy
                            </button>
                            <button id="downloadResults" class="inline-flex items-center px-3 py-1.5 text-sm font-medium rounded-md bg-gray-100 hover:bg-gray-200 dark:bg-gray-800 dark:hover:bg-gray-700 transition-colors duration-200">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="7 10 12 15 17 10"></polyline>
                                    <line x1="12" x2="12" y1="15" y2="3"></line>
                                </svg>
                                Save as Markdown
                            </button>
                        </div>
                    </div>
                    <div id="researchContent" class="markdown-content pt-2 border-t border-gray-200 dark:border-gray-700"></div>
                </div>
                <div class="flex flex-col md:flex-row gap-4">
                    <div class="bg-light-card dark:bg-dark-card rounded-xl p-6 shadow-md md:w-1/2">
                        <h3 class="text-lg font-semibold mb-4 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-primary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="m9 18 6-6-6-6"></path>
                            </svg>
                            Research Stats
                        </h3>
                        <div class="space-y-4" id="researchStats">
                            <!-- Will be filled dynamically -->
                        </div>
                    </div>
                    <div class="bg-light-card dark:bg-dark-card rounded-xl p-6 shadow-md md:w-1/2">
                        <h3 class="text-lg font-semibold mb-4 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-primary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M12 3c-1.2 0-2.4.6-3 1.7A4 4 0 0 0 4 9c0 1 .6 2.2 1.3 3.2a18 18 0 0 0 5.2 5.2 4 4 0 0 0 6.1-6.1 18 18 0 0 0-5.2-5.2A10 10 0 0 0 12 3z"></path>
                            </svg>
                            Key Insights
                        </h3>
                        <div class="space-y-2" id="keyInsights">
                            <!-- Will be filled dynamically -->
                        </div>
                    </div>
                </div>
                <div class="flex justify-center">
                    <button id="newResearch" class="mt-2 bg-primary hover:bg-primaryDark text-white font-medium py-3 px-6 rounded-lg transition-colors duration-200 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M3 12h18"></path>
                            <path d="M12 3v18"></path>
                        </svg>
                        Start New Research
                    </button>
                </div>
            </section>
        </main>

        <footer class="border-t border-gray-200 dark:border-gray-800 py-6">
            <div class="container max-w-6xl mx-auto px-4 text-center text-sm text-gray-500 dark:text-gray-400">
                <p>MCP Research Lab powered by Model Context Protocol Agent Army</p>
            </div>
        </footer>
    </div>

    <script>
        // Set up dark mode based on system preference
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
        
        // DOM elements
        const themeToggle = document.getElementById('themeToggle');
        const startResearchBtn = document.getElementById('startResearch');
        const newResearchBtn = document.getElementById('newResearch');
        const cancelResearchBtn = document.getElementById('cancelResearch');
        const copyResultsBtn = document.getElementById('copyResults');
        const downloadResultsBtn = document.getElementById('downloadResults');
        const researchTopicInput = document.getElementById('researchTopic');
        const researchDepthSelect = document.getElementById('researchDepth');
        const researchProgress = document.getElementById('researchProgress');
        const progressSteps = document.getElementById('progressSteps');
        const streamingOutput = document.getElementById('streamingOutput');
        const progressBar = document.getElementById('progressBar');
        const progressPercentage = document.getElementById('progressPercentage');
        const currentStepLabel = document.getElementById('currentStepLabel');
        const elapsedTime = document.getElementById('elapsedTime');
        const researchResults = document.getElementById('researchResults');
        const researchContent = document.getElementById('researchContent');
        const researchStats = document.getElementById('researchStats');
        const keyInsights = document.getElementById('keyInsights');
        const advancedSettingsToggle = document.getElementById('advancedSettingsToggle');
        const advancedSettings = document.getElementById('advancedSettings');
        const temperatureSlider = document.getElementById('temperature');
        const temperatureValue = document.getElementById('temperatureValue');
        
        // Research state
        let currentResearchPlan = [];
        let currentResearchStep = 0;
        let researchResponses = [];
        let isResearchInProgress = false;
        let startTime = null;
        let elapsedTimeInterval = null;
        let streamingInterval = null;
        let abortController = null;
        
        // Toggle theme
        themeToggle.addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
        });
        
        // Toggle advanced settings
        advancedSettingsToggle.addEventListener('click', () => {
            advancedSettings.classList.toggle('hidden');
            advancedSettingsToggle.textContent = advancedSettings.classList.contains('hidden') 
                ? 'Show Advanced Settings' 
                : 'Hide Advanced Settings';
        });
        
        // Update temperature value display
        temperatureSlider.addEventListener('input', () => {
            temperatureValue.textContent = temperatureSlider.value;
        });
        
        // Start research button click handler
        startResearchBtn.addEventListener('click', async () => {
            const researchTopic = researchTopicInput.value.trim();
            
            if (!researchTopic) {
                showError('Please enter a research topic');
                return;
            }
            
            if (isResearchInProgress) {
                return;
            }
            
            // Reset previous research
            currentResearchPlan = [];
            currentResearchStep = 0;
            researchResponses = [];
            progressSteps.innerHTML = '';
            streamingOutput.innerHTML = '<p class="text-sm font-mono typing-animation">Initializing research process...</p>';
            isResearchInProgress = true;
            abortController = new AbortController();
            
            // Reset and start timer
            startTime = Date.now();
            if (elapsedTimeInterval) clearInterval(elapsedTimeInterval);
            elapsedTimeInterval = setInterval(updateElapsedTime, 1000);
            
            // Show progress section, hide results
            researchProgress.classList.remove('hidden');
            researchResults.classList.add('hidden');
            
            // Disable start button
            startResearchBtn.disabled = true;
            startResearchBtn.innerHTML = `
                <svg class="animate-spin -ml-1 mr-2 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Creating Research Plan...
            `;
            
            // Update progress
            updateProgress(0, 'Planning Research');
            
            // Generate research plan
            try {
                // Add initial step in timeline
                addTimelineStep('Planning Research', 'Creating a detailed research plan...', 'in-progress');
                
                const planPrompt = createPlanningPrompt(researchTopic, researchDepthSelect.value);
                const planResponse = await fetchWithStreaming('/api/research/plan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        topic: researchTopic,
                        depth: researchDepthSelect.value,
                        style: document.getElementById('researchStyle').value,
                        model: document.getElementById('modelSelector').value,
                        temperature: parseFloat(temperatureSlider.value),
                        maxTokens: parseInt(document.getElementById('maxTokens').value)
                    }),
                    signal: abortController.signal
                }, handleStreamingPlanUpdate);
                
                if (!planResponse || planResponse.error) {
                    throw new Error(planResponse?.error || 'Failed to create research plan');
                }
                
                await handlePlanningResponse(planResponse);
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.log('Research planning aborted');
                } else {
                    handleError('Error starting research', error);
                }
            }
        });
        
        // Cancel research button click handler
        cancelResearchBtn.addEventListener('click', () => {
            if (abortController) {
                abortController.abort();
                abortController = null;
            }
            
            // Clear intervals
            if (elapsedTimeInterval) {
                clearInterval(elapsedTimeInterval);
                elapsedTimeInterval = null;
            }
            
            if (streamingInterval) {
                clearInterval(streamingInterval);
                streamingInterval = null;
            }
            
            // Update UI
            isResearchInProgress = false;
            researchProgress.classList.add('hidden');
            
            // Reset buttons
            startResearchBtn.disabled = false;
            startResearchBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.3-4.3"></path>
                </svg>
                Start Comprehensive Research
            `;
            
            showNotification('Research canceled', 'info');
        });
        
        // New research button click handler
        newResearchBtn.addEventListener('click', () => {
            researchResults.classList.add('hidden');
            researchProgress.classList.add('hidden');
            startResearchBtn.disabled = false;
            startResearchBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.3-4.3"></path>
                </svg>
                Start Comprehensive Research
            `;
            
            // Don't clear the input so users can refine their prompt
            // researchTopicInput.value = '';
            isResearchInProgress = false;
        });
        
        // Copy results button click handler
        copyResultsBtn.addEventListener('click', () => {
            const content = researchContent.textContent;
            navigator.clipboard.writeText(content)
                .then(() => showNotification('Research results copied to clipboard', 'success'))
                .catch(err => showError('Failed to copy: ' + err));
        });
        
        // Download results button click handler
        downloadResultsBtn.addEventListener('click', () => {
            // This doesn't actually download a file since file downloads aren't supported.
            // Instead, we'll show the markdown source so users can manually copy it
            
            const content = researchContent.getAttribute('data-markdown') || researchContent.textContent;
            
            // Create a modal with the markdown content
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-dark-card rounded-lg shadow-xl max-w-4xl w-full max-h-[80vh] flex flex-col">
                    <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                        <h3 class="text-lg font-semibold">Markdown Source</h3>
                        <button class="close-modal text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                    <div class="p-4 flex-1 overflow-auto">
                        <p class="mb-2 text-sm text-gray-500 dark:text-gray-400">Copy this markdown and save to a .md file:</p>
                        <pre class="bg-gray-100 dark:bg-gray-800 p-4 rounded-lg text-sm font-mono overflow-auto whitespace-pre-wrap max-h-[calc(80vh-180px)]">${content}</pre>
                    </div>
                    <div class="p-4 border-t border-gray-200 dark:border-gray-700 flex justify-end">
                        <button class="copy-markdown bg-primary hover:bg-primaryDark text-white px-4 py-2 rounded-md">
                            Copy Markdown
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Handle close modal
            modal.querySelector('.close-modal').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            
            // Handle copy button
            modal.querySelector('.copy-markdown').addEventListener('click', () => {
                navigator.clipboard.writeText(content)
                    .then(() => {
                        showNotification('Markdown copied to clipboard', 'success');
                        document.body.removeChild(modal);
                    })
                    .catch(err => showError('Failed to copy: ' + err));
            });
            
            // Close when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
        });
        
        // Research with MCP Agent Army through Poe API
        async function researchWithMCPAgents(query, agent = 'all', format = 'report') {
            try {
                // Check if the query is empty
                if (!query.trim()) {
                    throw new Error("Research query cannot be empty");
                }
                
                // Get the session ID from the input field or generate a new one
                const sessionId = document.getElementById('sessionId')?.value.trim() || 
                    `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                
                // Register a handler for the MCP agent responses
                const handlerId = "mcp-agent-handler";
                
                let thinking = "";
                let finalReport = "";
                let isProcessingThinking = true;
                
                // Register handler for streaming responses
                window.Poe.registerHandler(handlerId, (result, context) => {
                    // Check for errors
                    if (result.status === "error") {
                        streamingOutput.innerHTML = `<div class="text-sm font-mono text-red-500">Error: ${result.statusText || "Unknown error occurred"}</div>`;
                        return;
                    }
                    
                    // Get the first response (we only expect one bot to respond)
                    const response = result.responses[0];
                    
                    // Update content based on current state
                    if (format === 'debug' || format === 'dual') {
                        if (isProcessingThinking) {
                            // Still collecting thinking process
                            if (response.content.includes("## Final Research Report")) {
                                // Split the content when we find the final report marker
                                const parts = response.content.split("## Final Research Report");
                                thinking = parts[0];
                                finalReport = "## Final Research Report" + parts[1];
                                isProcessingThinking = false;
                                
                                // Update the streaming output with the thinking content
                                streamingOutput.innerHTML = `<div class="text-sm font-mono markdown-content">${marked.parse(thinking)}</div>`;
                                
                                // If this is the complete response, we'll handle the final report too
                                if (response.status === "complete") {
                                    // Now ready to show the final report in the results section
                                    if (format === 'dual') {
                                        handleCompletedResearch(finalReport, thinking);
                                    } else {
                                        handleCompletedResearch(thinking);
                                    }
                                }
                            } else {
                                // Still just thinking
                                thinking = response.content;
                                streamingOutput.innerHTML = `<div class="text-sm font-mono markdown-content">${marked.parse(thinking)}</div>`;
                                
                                // If complete and we never found the marker, show what we have
                                if (response.status === "complete") {
                                    handleCompletedResearch(thinking);
                                }
                            }
                        } else {
                            // Already found the report section
                            finalReport = "## Final Research Report" + response.content.split("## Final Research Report")[1];
                            
                            // If complete, show the final report
                            if (response.status === "complete") {
                                if (format === 'dual') {
                                    handleCompletedResearch(finalReport, thinking);
                                } else {
                                    handleCompletedResearch(thinking);
                                }
                            }
                        }
                    } else {
                        // Standard report mode - we only care about the final report
                        if (response.content.includes("## Final Research Report")) {
                            // Extract just the final report
                            finalReport = "## Final Research Report" + response.content.split("## Final Research Report")[1];
                            streamingOutput.innerHTML = `<div class="text-sm font-mono markdown-content">${marked.parse(finalReport)}</div>`;
                            
                            // If complete, show final report
                            if (response.status === "complete") {
                                handleCompletedResearch(finalReport);
                            }
                        } else {
                            // Just show everything until we find the marker
                            streamingOutput.innerHTML = `<div class="text-sm font-mono markdown-content">${marked.parse(response.content)}</div>`;
                            
                            // If complete and we never found the marker, show what we have
                            if (response.status === "complete") {
                                handleCompletedResearch(response.content);
                            }
                        }
                    }
                    
                    // Always scroll to the bottom of streaming output
                    streamingOutput.scrollTop = streamingOutput.scrollHeight;
                });

                // Set up the prompt for the MCP Agent Army
                const selectedAgent = agent === 'all' ? 'Orchestration Agent' : agent.charAt(0).toUpperCase() + agent.slice(1) + ' Agent';
                const outputFormat = format === 'debug' ? 'debug' : format === 'dual' ? 'dual' : 'report';
                const chartType = document.getElementById('chartType')?.value || 'auto';
                
                // Construct the prompt
                const prompt = `@Claude-3.7-Sonnet I need you to use the MCP Agent Army to research this topic: "${query}"

Use the ${selectedAgent} with session_id: ${sessionId}.
Output format: ${outputFormat} mode (${outputFormat === 'debug' ? 'show thinking process only' : outputFormat === 'dual' ? 'include both thinking process and final report' : 'show final report only'})
Data visualization: ${chartType} (${chartType === 'auto' ? 'automatically choose charts based on data' : chartType === 'none' ? 'do not include charts' : `include ${chartType} charts where appropriate`})

Your response should be structured as follows:
1. First, show your step-by-step thinking process, exploring the topic thoroughly with research and analysis.
2. Then include a section called "## Final Research Report" which contains only the polished, professional research report.

In the final report:
- Include a clear structure with headings and subheadings
- Incorporate data visualizations where appropriate (as described by code that could be used to generate them)
- Back up claims with evidence from your research
- Highlight key insights and findings
- If including charts, describe them in detail so they could be programmatically generated

Remember to clearly separate your thinking process from the final report with the "## Final Research Report" heading.`;

                // Disable interacting with inputs during research
                startResearchBtn.disabled = true;
                
                // Send the message to Claude
                await window.Poe.sendUserMessage(prompt, {
                    handler: handlerId,
                    stream: true,
                    openChat: false
                });

                // Function to handle completed research
                function handleCompletedResearch(finalContent, thinkingContent = null) {
                    const outputFormat = document.getElementById('outputFormat')?.value || 'report';
                    
                    // Update progress UI
                    updateProgress(100, 'Research Complete');
                    updateTimelineStep(currentResearchStep + 1, 'Synthesizing Research', 'Research complete', 'complete');
                    
                    // Display research results based on output format
                    if (outputFormat === 'debug' && thinkingContent === null) {
                        // Debug mode with only thinking content available
                        researchContent.innerHTML = marked.parse(finalContent);
                        researchContent.setAttribute('data-markdown', finalContent);
                    } else if (outputFormat === 'dual' && thinkingContent !== null) {
                        // Dual mode with both thinking and final report
                        const dualContent = `# Research Process and Results\n\n## Thinking Process\n${thinkingContent}\n\n${finalContent}`;
                        researchContent.innerHTML = marked.parse(dualContent);
                        researchContent.setAttribute('data-markdown', dualContent);
                    } else {
                        // Report mode or fallback - just show the final content
                        researchContent.innerHTML = marked.parse(finalContent);
                        researchContent.setAttribute('data-markdown', finalContent);
                    }
                    
                    // Generate research stats and key insights
                    generateResearchStats();
                    generateKeyInsights(finalContent);
                    
                    // Show results section
                    researchResults.classList.remove('hidden');
                    
                    // Reset UI for next research
                    startResearchBtn.disabled = false;
                    startResearchBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.3-4.3"></path>
                        </svg>
                        Start Comprehensive Research
                    `;
                    
                    // Look for any chart descriptions and create actual charts
                    setTimeout(generateCharts, 500);
                }
                
                // Return success
                return true;
            } catch (error) {
                console.error('Error using MCP agents:', error);
                showError(`Failed to research with MCP agents: ${error.message}`);
                return false;
            }
        }
        
        // Function to generate charts from chart descriptions in the text
        function generateCharts() {
            // Find all chart description elements in the research content
            const chartDescriptions = researchContent.querySelectorAll('p, li');
            const chartType = document.getElementById('chartType')?.value || 'auto';
            
            // Skip if no charts are wanted
            if (chartType === 'none') return;
            
            // Iterate through all paragraphs looking for chart descriptions
            chartDescriptions.forEach((element, index) => {
                const text = element.textContent.toLowerCase();
                
                // Look for text that might describe a chart
                if ((text.includes('chart') || text.includes('graph') || text.includes('plot') || text.includes('diagram')) &&
                    (text.includes('showing') || text.includes('displays') || text.includes('illustrates') || 
                     text.includes('represents') || text.includes('visualizes'))) {
                    
                    // Create a chart container
                    const chartId = `chart-${index}`;
                    const chartContainer = document.createElement('div');
                    chartContainer.className = 'my-4 p-4 bg-gray-50 dark:bg-gray-800 rounded-lg';
                    chartContainer.innerHTML = `
                        <div class="mb-2 text-sm text-gray-500 dark:text-gray-400">Chart visualization:</div>
                        <canvas id="${chartId}" width="400" height="300"></canvas>
                    `;
                    
                    // Insert after the description
                    element.parentNode.insertBefore(chartContainer, element.nextSibling);
                    
                    // Try to extract data from the description
                    let chartToCreate = chartType === 'auto' ? detectChartType(text) : chartType;
                    createChart(chartId, text, chartToCreate);
                }
            });
        }
        
        // Detect what type of chart should be created based on text description
        function detectChartType(text) {
            if (text.includes('bar chart') || text.includes('column chart') || 
                text.includes('histogram') || text.includes('frequency')) {
                return 'bar';
            } else if (text.includes('line chart') || text.includes('trend') || 
                      text.includes('over time') || text.includes('growth')) {
                return 'line';
            } else if (text.includes('pie chart') || text.includes('percentage') || 
                      text.includes('proportion') || text.includes('distribution')) {
                return 'pie';
            } else if (text.includes('scatter plot') || text.includes('correlation') || 
                      text.includes('relationship between')) {
                return 'scatter';
            } else {
                // Default to bar chart if we can't determine
                return 'bar';
            }
        }
        
        // Create a chart based on text description
        function createChart(chartId, text, chartType) {
            // Extract data from text
            let labels = [];
            let values = [];
            
            // Try to find numeric data in the text
            const numberPattern = /(\d+(\.\d+)?)/g;
            const numbers = text.match(numberPattern);
            
            // Try to find potential labels
            const words = text.split(/\s+/);
            const potentialLabels = words.filter(word => 
                word.length > 3 && 
                !word.match(/^\d+$/) && 
                !['chart', 'graph', 'shows', 'displaying', 'represents', 'the', 'and', 'for', 'with'].includes(word.toLowerCase())
            );
            
            // If we found numbers, use them as values
            if (numbers && numbers.length > 1) {
                values = numbers.map(n => parseFloat(n)).slice(0, 6); // Limit to 6 data points
                
                // Try to extract labels
                if (potentialLabels.length >= values.length) {
                    labels = potentialLabels.slice(0, values.length);
                } else {
                    // Generate generic labels if we don't have enough
                    labels = Array.from({length: values.length}, (_, i) => `Category ${i+1}`);
                }
            } else {
                // Generate sample data if we couldn't extract real data
                labels = ['Category 1', 'Category 2', 'Category 3', 'Category 4', 'Category 5'];
                values = [
                    Math.floor(Math.random() * 80) + 20,
                    Math.floor(Math.random() * 80) + 20,
                    Math.floor(Math.random() * 80) + 20,
                    Math.floor(Math.random() * 80) + 20,
                    Math.floor(Math.random() * 80) + 20
                ];
            }
            
            // Generate colors
            const backgroundColors = [
                'rgba(93, 92, 222, 0.6)',
                'rgba(54, 162, 235, 0.6)',
                'rgba(255, 99, 132, 0.6)',
                'rgba(75, 192, 192, 0.6)',
                'rgba(255, 206, 86, 0.6)',
                'rgba(153, 102, 255, 0.6)'
            ];
            
            // Get chart element
            const ctx = document.getElementById(chartId);
            if (!ctx) return;
            
            // Create chart based on type
            const chart = new Chart(ctx, {
                type: chartType,
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Data',
                        data: values,
                        backgroundColor: backgroundColors,
                        borderColor: backgroundColors.map(color => color.replace('0.6', '1')),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: chartType === 'pie',
                            position: 'bottom'
                        },
                        title: {
                            display: true,
                            text: extractChartTitle(text)
                        }
                    },
                    scales: chartType !== 'pie' ? {
                        y: {
                            beginAtZero: true
                        }
                    } : {}
                }
            });
        }
        
        // Extract a title from the chart description
        function extractChartTitle(text) {
            // Try to find a concise title
            const sentences = text.split(/[.!?]/).filter(s => s.trim().length > 0);
            
            if (sentences.length > 0) {
                const firstSentence = sentences[0].trim();
                if (firstSentence.length < 60) {
                    return firstSentence;
                } else {
                    return firstSentence.substring(0, 57) + '...';
                }
            }
            
            return 'Data Visualization';
        }
        
        // Fetch with streaming support for simulation mode
        async function fetchWithStreaming(url, options, onStreamUpdate) {
            try {
                // Check if we should use the MCP agents instead
                const useRealAgents = document.getElementById('primaryAgentSelector') && 
                                    document.getElementById('outputFormat');
                
                if (useRealAgents) {
                    // Use the MCP Agent Army for research instead of simulation
                    const topic = JSON.parse(options.body).topic;
                    const agent = document.getElementById('primaryAgentSelector').value;
                    const format = document.getElementById('outputFormat').value;
                    
                    // This will start the real research process using Poe API
                    const success = await researchWithMCPAgents(topic, agent, format);
                    
                    // If it failed, throw an error
                    if (!success) {
                        throw new Error('Failed to start research with MCP agents');
                    }
                    
                    // Return a dummy response to keep the UI working
                    if (url.includes('/plan')) {
                        return {
                            title: `Analysis of ${topic} using MCP Agents`,
                            steps: [
                                {id: 1, title: "Research with MCP Agents", description: "Using advanced MCP agents to conduct comprehensive research"}
                            ]
                        };
                    } else {
                        // This isn't actually used since we're handling the research in the Poe API
                        return "Research in progress with MCP Agent Army...";
                    }
                }
                
                // Fall back to simulation mode for demo purposes
                let streamContent = '';
                
                if (streamingInterval) {
                    clearInterval(streamingInterval);
                }
                
                // This simulates streaming updates from the server
                return new Promise((resolve, reject) => {
                    try {
                        const { topic, depth } = JSON.parse(options.body);
                        
                        // Simulate different endpoints
                        if (url.includes('/plan')) {
                            simulateResearchPlan(topic, depth, onStreamUpdate, resolve, options.signal);
                        } else if (url.includes('/research')) {
                            const { step } = JSON.parse(options.body);
                            simulateResearchStep(topic, step, onStreamUpdate, resolve, options.signal);
                        } else if (url.includes('/synthesize')) {
                            simulateSynthesis(topic, currentResearchPlan, researchResponses, onStreamUpdate, resolve, options.signal);
                        }
                        
                        // Listen for abort signal
                        options.signal?.addEventListener('abort', () => {
                            if (streamingInterval) {
                                clearInterval(streamingInterval);
                                streamingInterval = null;
                            }
                            reject(new DOMException('Aborted', 'AbortError'));
                        });
                    } catch (error) {
                        if (streamingInterval) {
                            clearInterval(streamingInterval);
                            streamingInterval = null;
                        }
                        reject(error);
                    }
                });
            } catch (error) {
                throw error;
            }
        }
        
        // Simulated API responses
        function simulateResearchPlan(topic, depth, onStreamUpdate, resolve, signal) {
            let streamContent = '';
            const chunks = [
                '{"title": "',
                `Comprehensive Analysis of ${topic}`,
                '", "steps": [',
                '{"id": 1, "title": "Historical Context and Background", "description": "Research the historical development and background of the topic", "key_questions": ["What are the origins?", "How has it evolved over time?", "What were significant milestones?"]},',
                '{"id": 2, "title": "Current State Analysis", "description": "Assess the present situation and recent developments", "key_questions": ["What is the current landscape?", "What are the latest developments?", "Who are the key players?"]},',
                '{"id": 3, "title": "Key Challenges and Issues", "description": "Identify critical problems and obstacles", "key_questions": ["What major challenges exist?", "What controversies are associated?", "What are potential roadblocks?"]},',
                '{"id": 4, "title": "Technological and Scientific Aspects", "description": "Analyze scientific foundations and technological implementations", "key_questions": ["What technologies are involved?", "What scientific principles underpin this topic?", "What innovations are emerging?"]},',
                '{"id": 5, "title": "Economic and Market Implications", "description": "Evaluate economic impacts and market dynamics", "key_questions": ["What is the economic significance?", "How does it affect markets?", "What are the business opportunities?"]},',
                '{"id": 6, "title": "Social and Cultural Impact", "description": "Assess effects on society and culture", "key_questions": ["How does it affect different communities?", "What cultural shifts has it caused?", "How has public perception evolved?"]},',
                '{"id": 7, "title": "Future Trends and Predictions", "description": "Forecast upcoming developments and future directions", "key_questions": ["What are expected future trends?", "How might it evolve in coming years?", "What potential disruptions could occur?"]}'
            ];
            
            if (depth === 'quick') {
                chunks.splice(5, 2); // Remove 2 steps for quick research
            } else if (depth === 'comprehensive') {
                chunks.push(',');
                chunks.push('{"id": 8, "title": "Case Studies and Examples", "description": "Examine specific implementations and real-world examples", "key_questions": ["What successful implementations exist?", "What failures or cautionary tales are documented?", "What lessons can be learned from these cases?"]},');
                chunks.push('{"id": 9, "title": "Regulatory and Policy Framework", "description": "Analyze legal, regulatory, and policy aspects", "key_questions": ["What regulations govern this area?", "How do policies vary across regions?", "What regulatory changes are anticipated?"]}');
            }
            
            chunks.push(']}');
            
            let chunkIndex = 0;
            
            streamingInterval = setInterval(() => {
                if (signal?.aborted) {
                    clearInterval(streamingInterval);
                    return;
                }
                
                if (chunkIndex < chunks.length) {
                    streamContent += chunks[chunkIndex];
                    onStreamUpdate(streamContent);
                    chunkIndex++;
                } else {
                    clearInterval(streamingInterval);
                    
                    try {
                        // Finalize with the complete response
                        const jsonResponse = JSON.parse(streamContent);
                        resolve(jsonResponse);
                    } catch (error) {
                        console.error("Error parsing JSON:", error);
                        resolve({ error: "Failed to parse research plan" });
                    }
                }
            }, 300);
        }
        
        function simulateResearchStep(topic, step, onStreamUpdate, resolve, signal) {
            // Create simulated research content based on the step
            const researchContent = [];
            
            switch (step.title.toLowerCase().split(' ')[0]) {
                case 'historical':
                    researchContent.push(`# Historical Context and Background of ${topic}\n\n`);
                    researchContent.push(`The concept of ${topic} has evolved significantly over time. `);
                    researchContent.push(`Initially emerging in the early stages as a theoretical framework, `);
                    researchContent.push(`it has transformed through several distinct phases of development.\n\n`);
                    researchContent.push(`## Origins\n\n`);
                    researchContent.push(`The origins can be traced back to pioneering work in the field, `);
                    researchContent.push(`with early contributors establishing fundamental principles that `);
                    researchContent.push(`would later become central to understanding the topic. `);
                    researchContent.push(`These foundational elements include:\n\n`);
                    researchContent.push(`- Theoretical frameworks developed in academic settings\n`);
                    researchContent.push(`- Early practical applications that demonstrated potential\n`);
                    researchContent.push(`- Interdisciplinary approaches that enriched the concept\n\n`);
                    researchContent.push(`## Evolution Timeline\n\n`);
                    researchContent.push(`- **Early Phase (1970s-1980s)**: Conceptual development and theoretical groundwork\n`);
                    researchContent.push(`- **Growth Phase (1990s-2000s)**: Expanded applications and methodological refinement\n`);
                    researchContent.push(`- **Maturation Phase (2010s)**: Integration with other domains and practical standardization\n`);
                    researchContent.push(`- **Current Phase (2020s)**: Advanced implementations and specialized applications\n\n`);
                    researchContent.push(`## Key Milestones\n\n`);
                    researchContent.push(`Several breakthrough moments have defined the trajectory of ${topic}:\n\n`);
                    researchContent.push(`1. The publication of seminal research papers establishing core principles\n`);
                    researchContent.push(`2. Development of standardized methodologies enabling consistent application\n`);
                    researchContent.push(`3. Technological advances that expanded practical capabilities\n`);
                    researchContent.push(`4. Formation of dedicated professional organizations and research communities\n`);
                    break;
                    
                case 'current':
                    researchContent.push(`# Current State Analysis of ${topic}\n\n`);
                    researchContent.push(`The present landscape of ${topic} is characterized by rapid evolution `);
                    researchContent.push(`and increasing integration across various sectors. Recent developments `);
                    researchContent.push(`have significantly expanded both theoretical understanding and practical applications.\n\n`);
                    researchContent.push(`## Latest Developments\n\n`);
                    researchContent.push(`Recent advancements in ${topic} include:\n\n`);
                    researchContent.push(`- Introduction of improved methodologies that enhance effectiveness\n`);
                    researchContent.push(`- Integration with complementary technologies creating synergistic effects\n`);
                    researchContent.push(`- Expansion into previously unexplored domains and use cases\n`);
                    researchContent.push(`- Refinement of best practices based on accumulated experience\n\n`);
                    researchContent.push(`## Key Players\n\n`);
                    researchContent.push(`The field is shaped by contributions from several types of entities:\n\n`);
                    researchContent.push(`### Academic Institutions\n`);
                    researchContent.push(`Universities and research centers continue to drive theoretical innovation through dedicated research programs.\n\n`);
                    researchContent.push(`### Industry Leaders\n`);
                    researchContent.push(`Major companies have established specialized divisions focused on developing and implementing advanced solutions.\n\n`);
                    researchContent.push(`### Specialized Organizations\n`);
                    researchContent.push(`Dedicated entities have emerged that focus exclusively on specific aspects or applications.\n\n`);
                    researchContent.push(`### Government Agencies\n`);
                    researchContent.push(`Public sector involvement has increased, particularly in areas related to standardization and public applications.\n\n`);
                    break;
                    
                case 'key':
                    researchContent.push(`# Key Challenges and Issues in ${topic}\n\n`);
                    researchContent.push(`Despite significant progress, ${topic} faces several critical challenges `);
                    researchContent.push(`that impede further development and widespread adoption. These issues `);
                    researchContent.push(`range from technical limitations to broader societal concerns.\n\n`);
                    researchContent.push(`## Major Technical Challenges\n\n`);
                    researchContent.push(`1. **Scalability Constraints**: Difficulties in scaling solutions to handle larger volumes or more complex scenarios\n`);
                    researchContent.push(`2. **Integration Complexity**: Challenges in seamlessly integrating with existing systems and workflows\n`);
                    researchContent.push(`3. **Technical Limitations**: Fundamental constraints that currently restrict certain capabilities\n`);
                    researchContent.push(`4. **Performance Optimization**: Balancing effectiveness with efficiency in resource utilization\n\n`);
                    researchContent.push(`## Controversies and Ethical Concerns\n\n`);
                    researchContent.push(`Several contentious issues have emerged around ${topic}:\n\n`);
                    researchContent.push(`- Questions about appropriate use and potential misapplication\n`);
                    researchContent.push(`- Debates regarding ownership, control, and access rights\n`);
                    researchContent.push(`- Concerns about unintended consequences and secondary effects\n`);
                    researchContent.push(`- Disagreements about governance and oversight mechanisms\n\n`);
                    researchContent.push(`## Implementation Roadblocks\n\n`);
                    researchContent.push(`Organizations attempting to implement ${topic} frequently encounter:\n\n`);
                    researchContent.push(`- **Resource Constraints**: Limited availability of necessary expertise and infrastructure\n`);
                    researchContent.push(`- **Resistance to Change**: Organizational inertia and reluctance to adopt new approaches\n`);
                    researchContent.push(`- **Knowledge Gaps**: Insufficient understanding of requirements and implications\n`);
                    researchContent.push(`- **Regulatory Uncertainty**: Unclear or evolving regulatory frameworks\n\n`);
                    break;
                    
                // Add more cases for other research steps
                
                default:
                    // Generic research content for other steps
                    researchContent.push(`# ${step.title} for ${topic}\n\n`);
                    researchContent.push(`This section explores ${step.description.toLowerCase()}.\n\n`);
                    researchContent.push(`## Key Findings\n\n`);
                    researchContent.push(`Based on comprehensive analysis, several important aspects have been identified:\n\n`);
                    researchContent.push(`1. The ${topic} demonstrates significant relationships with related concepts\n`);
                    researchContent.push(`2. Multiple factors influence development and implementation in this area\n`);
                    researchContent.push(`3. Emerging patterns suggest important future directions\n`);
                    researchContent.push(`4. Both opportunities and challenges characterize the current landscape\n\n`);
                    researchContent.push(`## Detailed Analysis\n\n`);
                    researchContent.push(`When examining this aspect in detail, several components merit special attention:\n\n`);
                    researchContent.push(`### Component One\n`);
                    researchContent.push(`This element represents a fundamental aspect that influences overall functioning and effectiveness.\n\n`);
                    researchContent.push(`### Component Two\n`);
                    researchContent.push(`Secondary factors interact with primary elements to create complex relationships and dependencies.\n\n`);
                    researchContent.push(`### Component Three\n`);
                    researchContent.push(`Peripheral considerations nonetheless have significant implications for comprehensive understanding.\n\n`);
                    break;
            }
            
            let chunkIndex = 0;
            
            streamingInterval = setInterval(() => {
                if (signal?.aborted) {
                    clearInterval(streamingInterval);
                    return;
                }
                
                if (chunkIndex < researchContent.length) {
                    onStreamUpdate(researchContent.slice(0, chunkIndex + 1).join(''));
                    chunkIndex++;
                } else {
                    clearInterval(streamingInterval);
                    resolve(researchContent.join(''));
                }
            }, 200);
        }
        
        function simulateSynthesis(topic, plan, responses, onStreamUpdate, resolve, signal) {
            const synthesisContent = [];
            
            // Check if plan is valid and has steps
            if (!plan || !plan.steps || !Array.isArray(plan.steps)) {
                console.error("Invalid research plan for synthesis:", plan);
                plan = {
                    steps: currentResearchPlan?.steps || []
                };
                
                // If still no valid plan, create a default one
                if (!plan.steps || !Array.isArray(plan.steps) || plan.steps.length === 0) {
                    console.log("Creating default research plan structure");
                    plan = {
                        steps: [
                            {id: 1, title: "Historical Context and Background"},
                            {id: 2, title: "Current State Analysis"},
                            {id: 3, title: "Key Challenges and Issues"},
                            {id: 4, title: "Future Trends and Predictions"}
                        ]
                    };
                }
            }
            
            synthesisContent.push(`# Comprehensive Analysis: ${topic}\n\n`);
            synthesisContent.push(`## Executive Summary\n\n`);
            synthesisContent.push(`This report presents a comprehensive analysis of ${topic}, examining its historical context, current state, challenges, technological aspects, economic implications, social impact, and future trends. The research reveals that ${topic} is a multifaceted subject with significant implications across various domains. Key findings indicate both substantial opportunities and notable challenges that require careful consideration.\n\n`);
            synthesisContent.push(`## 1. Introduction\n\n`);
            synthesisContent.push(`${topic} represents an area of growing importance in contemporary contexts. This research was conducted to provide a comprehensive understanding of its various dimensions, current status, and potential future developments. The following sections present the findings organized by thematic areas.\n\n`);
            
            // Add sections based on research steps
            for (let i = 0; i < plan.steps.length; i++) {
                const step = plan.steps[i];
                // Ensure step has a title
                const stepTitle = step.title || `Research Area ${i + 1}`;
                synthesisContent.push(`## ${i + 2}. ${stepTitle}\n\n`);
                
                // Add synthesized content from responses
                if (responses && responses[i]) {
                    // Extract key points from the research response
                    // This would normally involve more sophisticated summarization
                    const lines = responses[i].split('\n');
                    let inSection = false;
                    let pointsAdded = 0;
                    
                    for (const line of lines) {
                        if (line.startsWith('###') || line.startsWith('##')) {
                            inSection = true;
                            synthesisContent.push(`${line}\n\n`);
                        } else if (inSection && (line.startsWith('- ') || line.startsWith('* ') || 
                                              (line.match(/^\d+\.\s/) && !line.includes('**')))) {
                            synthesisContent.push(`${line}\n\n`);
                            pointsAdded++;
                            
                            if (pointsAdded >= 3) {
                                inSection = false;
                                pointsAdded = 0;
                            }
                        }
                    }
                    
                    if (pointsAdded === 0) {
                        synthesisContent.push(`Analysis of this aspect reveals important insights into how ${topic} relates to ${stepTitle.toLowerCase()}. Multiple factors influence developments in this area, with significant implications for overall understanding and practical applications.\n\n`);
                    }
                } else {
                    synthesisContent.push(`This aspect of ${topic} requires further investigation to develop a comprehensive understanding. Initial analysis suggests important relationships with other dimensions examined in this research.\n\n`);
                }
            }
            
            synthesisContent.push(`## ${plan.steps.length + 2}. Key Insights and Recommendations\n\n`);
            synthesisContent.push(`Based on the comprehensive analysis conducted, several key insights and recommendations can be identified:\n\n`);
            synthesisContent.push(`### Key Insights\n\n`);
            synthesisContent.push(`1. ${topic} demonstrates complex interconnections across multiple domains, necessitating interdisciplinary approaches\n`);
            synthesisContent.push(`2. Historical development reveals patterns that continue to influence current applications and understanding\n`);
            synthesisContent.push(`3. Technical and scientific foundations are evolving rapidly, creating both opportunities and implementation challenges\n`);
            synthesisContent.push(`4. Economic and social dimensions are increasingly recognized as critical to successful outcomes\n\n`);
            synthesisContent.push(`### Recommendations\n\n`);
            synthesisContent.push(`1. **Integrated Approach**: Develop strategies that address multiple dimensions simultaneously\n`);
            synthesisContent.push(`2. **Knowledge Development**: Invest in closing identified knowledge gaps through targeted research\n`);
            synthesisContent.push(`3. **Collaborative Frameworks**: Establish mechanisms for cross-sector collaboration\n`);
            synthesisContent.push(`4. **Adaptive Planning**: Implement flexible approaches that can accommodate emerging developments\n\n`);
            synthesisContent.push(`## ${plan.steps.length + 3}. Conclusion\n\n`);
            synthesisContent.push(`This research has provided a comprehensive examination of ${topic}, revealing its multifaceted nature and significant implications. While substantial progress has been made in understanding and implementing related concepts, important challenges remain. Future developments will likely be shaped by continuing technological innovation, evolving regulatory frameworks, and shifting societal needs and expectations. Continued monitoring and analysis of these factors will be essential for effective engagement with ${topic} moving forward.\n\n`);
            
            let chunkIndex = 0;
            
            streamingInterval = setInterval(() => {
                if (signal?.aborted) {
                    clearInterval(streamingInterval);
                    return;
                }
                
                if (chunkIndex < synthesisContent.length) {
                    onStreamUpdate(synthesisContent.slice(0, chunkIndex + 1).join(''));
                    chunkIndex++;
                } else {
                    clearInterval(streamingInterval);
                    resolve(synthesisContent.join(''));
                }
            }, 150);
        }
        
        // Planning prompt creator
        function createPlanningPrompt(topic, depth) {
            const depthDetails = {
                'quick': '3-5 specific research subtasks',
                'standard': '5-7 specific research subtasks',
                'comprehensive': '7-10 specific research subtasks'
            };
            
            const selectedStyle = document.getElementById('researchStyle').value;
            let stylePrefix = '';
            
            if (selectedStyle === 'academic') {
                stylePrefix = `As an academic researcher, `;
            } else if (selectedStyle === 'journalistic') {
                stylePrefix = `As an investigative journalist, `;
            } else if (selectedStyle === 'strategic') {
                stylePrefix = `As a strategic analyst, `;
            } else if (selectedStyle === 'technical') {
                stylePrefix = `As a technical specialist, `;
            }
            
            return `${stylePrefix}You are a research planning agent. I need you to create a research plan for the topic: "${topic}".

Based on ${depthDetails[depth]}, break down this topic into a focused research plan.

Your response must strictly follow this format as valid JSON without any explanation or additional text:
{
  "title": "Research title",
  "steps": [
    {
      "id": 1,
      "title": "Step 1 title",
      "description": "What needs to be researched in this step",
      "key_questions": ["Question 1", "Question 2"]
    },
    {
      "id": 2,
      "title": "Step 2 title",
      "description": "What needs to be researched in this step",
      "key_questions": ["Question 1", "Question 2"]
    }
  ]
}

Provide ONLY raw JSON in your response with no explanations, additional text, or code block formatting (no \`\`\`).`;
        }
        
        // Streaming update handlers
        function handleStreamingPlanUpdate(content) {
            streamingOutput.innerHTML = `<p class="text-sm font-mono">${content}</p>`;
            streamingOutput.scrollTop = streamingOutput.scrollHeight;
        }
        
        function handleStreamingResearchUpdate(content) {
            streamingOutput.innerHTML = `<div class="text-sm font-mono markdown-content">${marked.parse(content)}</div>`;
            streamingOutput.scrollTop = streamingOutput.scrollHeight;
        }
        
        // Handlers for API responses
        async function handlePlanningResponse(planData) {
            // Update progress UI based on response status
            if (!planData || planData.error) {
                updateTimelineStep(0, 'Planning Research', `Error: ${planData?.error || 'Unknown error'}`, 'error');
                if (startResearchBtn) {
                    startResearchBtn.disabled = false;
                    startResearchBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.3-4.3"></path>
                        </svg>
                        Start Comprehensive Research
                    `;
                }
                isResearchInProgress = false;
                return;
            } 
            
            try {
                // Set research plan
                currentResearchPlan = planData;
                updateTimelineStep(0, 'Planning Research', 'Research plan created successfully', 'complete');
                
                // Update progress percentage
                updateProgress(5, 'Research Plan Created');
                
                // Add steps to timeline UI
                currentResearchPlan.steps.forEach((step, index) => {
                    addTimelineStep(`Step ${step.id}: ${step.title}`, 'Waiting to start...', 'waiting');
                });
                
                // Add final synthesis step
                addTimelineStep('Synthesizing Research', 'Waiting to collect all research data...', 'waiting');
                
                // Start first research step
                await startNextResearchStep();
            } catch (error) {
                updateTimelineStep(0, 'Planning Research', 'Error parsing research plan', 'error');
                console.error("Error processing research plan:", error);
                startResearchBtn.disabled = false;
                startResearchBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.3-4.3"></path>
                    </svg>
                    Start Comprehensive Research
                `;
                isResearchInProgress = false;
            }
        }
        
        async function handleResearchStepResponse(response, stepIndex) {
            if (!response) {
                if (currentResearchPlan && currentResearchPlan.steps && currentResearchPlan.steps[stepIndex]) {
                    updateTimelineStep(stepIndex + 1, 
                        `Step ${currentResearchPlan.steps[stepIndex].id}: ${currentResearchPlan.steps[stepIndex].title}`, 
                        `Error: Failed to complete research`, 'error');
                } else {
                    updateTimelineStep(stepIndex + 1, 
                        `Research Step ${stepIndex + 1}`, 
                        `Error: Failed to complete research`, 'error');
                }
                isResearchInProgress = false;
                return;
            } 
            
            // Store response and update UI
            researchResponses[stepIndex] = response;
            updateTimelineStep(stepIndex + 1, 
                `Step ${currentResearchPlan.steps[stepIndex].id}: ${currentResearchPlan.steps[stepIndex].title}`, 
                'Research complete', 'complete');
            
            // Update progress
            const progressPercent = 5 + Math.round((stepIndex + 1) * (85 / currentResearchPlan.steps.length));
            updateProgress(progressPercent, `Completed Step ${stepIndex + 1} of ${currentResearchPlan.steps.length}`);
            
            // Move to next step
            currentResearchStep++;
            if (currentResearchStep < currentResearchPlan.steps.length) {
                await startNextResearchStep();
            } else {
                // All research steps complete, start synthesis
                await startSynthesis();
            }
        }
        
        async function handleSynthesisResponse(response) {
            const synthesisStep = currentResearchPlan.steps.length + 1;
            
            if (!response) {
                updateTimelineStep(synthesisStep, 'Synthesizing Research', 
                    `Error: Failed to synthesize research`, 'error');
                isResearchInProgress = false;
                return;
            } 
            
            updateTimelineStep(synthesisStep, 'Synthesizing Research', 
                'Research synthesis complete', 'complete');
            
            // Update progress
            updateProgress(100, 'Research Complete');
            
            // Display research results
            researchContent.innerHTML = marked.parse(response);
            researchContent.setAttribute('data-markdown', response);
            
            // Generate research stats
            generateResearchStats();
            
            // Generate key insights
            generateKeyInsights(response);
            
            // Show results section
            researchResults.classList.remove('hidden');
            
            // Clear intervals
            if (elapsedTimeInterval) {
                clearInterval(elapsedTimeInterval);
                elapsedTimeInterval = null;
            }
            
            // Reset UI for next research
            startResearchBtn.disabled = false;
            startResearchBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.3-4.3"></path>
                </svg>
                Start Comprehensive Research
            `;
            isResearchInProgress = false;
        }
        
        // Helper functions
        async function startNextResearchStep() {
            if (!isResearchInProgress) return;
            
            const stepIndex = currentResearchStep;
            const step = currentResearchPlan.steps[stepIndex];
            
            // Update UI to show current step as in progress
            updateTimelineStep(stepIndex + 1, 
                `Step ${step.id}: ${step.title}`, 
                'Researching...', 'in-progress');
            
            // Update progress text
            updateProgress(5 + Math.round(stepIndex * (85 / currentResearchPlan.steps.length)), 
                `Researching: ${step.title}`);
            
            try {
                // Reset streaming output
                streamingOutput.innerHTML = '<p class="text-sm font-mono typing-animation">Initiating research for this step...</p>';
                
                // Fetch research for this step
                const response = await fetchWithStreaming('/api/research/step', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        topic: researchTopicInput.value,
                        step: step,
                        model: document.getElementById('modelSelector').value,
                        temperature: parseFloat(temperatureSlider.value),
                        maxTokens: parseInt(document.getElementById('maxTokens').value)
                    }),
                    signal: abortController.signal
                }, handleStreamingResearchUpdate);
                
                await handleResearchStepResponse(response, stepIndex);
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.log('Research step aborted');
                } else {
                    handleError(`Error researching step ${stepIndex + 1}`, error);
                }
            }
        }
        
        async function startSynthesis() {
            if (!isResearchInProgress) return;
            
            const synthesisStep = currentResearchPlan.steps.length + 1;
            
            // Update UI
            updateTimelineStep(synthesisStep, 'Synthesizing Research', 
                'Creating comprehensive research report...', 'in-progress');
            
            // Update progress
            updateProgress(90, 'Synthesizing Research Findings');
            
            try {
                // Reset streaming output
                streamingOutput.innerHTML = '<p class="text-sm font-mono typing-animation">Synthesizing comprehensive research report...</p>';
                
                const response = await fetchWithStreaming('/api/research/synthesize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        topic: researchTopicInput.value,
                        depth: researchDepthSelect.value,
                        style: document.getElementById('researchStyle').value,
                        model: document.getElementById('modelSelector').value,
                        temperature: parseFloat(temperatureSlider.value),
                        maxTokens: parseInt(document.getElementById('maxTokens').value)
                    }),
                    signal: abortController.signal
                }, handleStreamingResearchUpdate);
                
                await handleSynthesisResponse(response);
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.log('Research synthesis aborted');
                } else {
                    handleError('Error synthesizing research', error);
                }
            }
        }
        
        function generateResearchStats() {
            // Calculate statistics from research responses
            const totalWordCount = researchResponses.reduce((sum, response) => {
                return sum + (response ? response.split(/\s+/).length : 0);
            }, 0);
            
            const elapsedTimeInMinutes = startTime ? Math.round((Date.now() - startTime) / 60000) : 0;
            
            // Get research style and model safely
            const researchStyle = document.getElementById('researchStyle');
            const researchStyleValue = researchStyle ? researchStyle.value : 'standard';
            const styleCapitalized = researchStyleValue.charAt(0).toUpperCase() + researchStyleValue.slice(1);
            
            const modelSelector = document.getElementById('modelSelector');
            const modelValue = modelSelector ? modelSelector.value : 'deepseek';
            const modelName = modelValue === 'deepseek' ? 'DeepSeek v3' : 'Llama 4';
            
            // Get steps length safely
            const stepsLength = currentResearchPlan && currentResearchPlan.steps ? currentResearchPlan.steps.length : 0;
            
            // Generate stats HTML
            if (researchStats) {
                researchStats.innerHTML = `
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-gray-100 dark:bg-gray-800 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-primary">${stepsLength}</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">Research Areas</div>
                        </div>
                        <div class="bg-gray-100 dark:bg-gray-800 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-primary">${totalWordCount.toLocaleString()}</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">Total Words</div>
                        </div>
                        <div class="bg-gray-100 dark:bg-gray-800 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-primary">${elapsedTimeInMinutes}</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">Minutes to Complete</div>
                        </div>
                        <div class="bg-gray-100 dark:bg-gray-800 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-primary">${modelName}</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">AI Model Used</div>
                        </div>
                    </div>
                    <div class="mt-4 bg-gray-100 dark:bg-gray-800 rounded-lg p-4">
                        <h4 class="text-sm font-medium mb-2">Research Style</h4>
                        <div class="flex items-center">
                            <div class="w-full bg-gray-300 dark:bg-gray-700 rounded-full h-2.5">
                                <div class="bg-primary h-2.5 rounded-full" style="width: ${
                                    researchStyleValue === 'standard' ? '60%' : 
                                    researchStyleValue === 'academic' ? '95%' : 
                                    researchStyleValue === 'journalistic' ? '75%' : '85%'
                                }"></div>
                            </div>
                            <span class="ml-2 text-sm">${styleCapitalized}</span>
                        </div>
                    </div>
                `;
            }
        }
        
        function generateKeyInsights(synthesisContent) {
            // Extract insights from synthesis content
            // This is a simple extraction - in a real implementation, you would use more sophisticated NLP
            const insights = [];
            
            if (synthesisContent) {
                const lines = synthesisContent.split('\n');
                
                let insightSection = false;
                for (const line of lines) {
                    if (line.includes('Key Insights') || line.includes('key insights')) {
                        insightSection = true;
                        continue;
                    }
                    
                    if (insightSection && line.startsWith('###')) {
                        insightSection = false;
                    }
                    
                    if (insightSection && (line.startsWith('- ') || line.startsWith('* ') || line.match(/^\d+\.\s/))) {
                        insights.push(line.replace(/^[- *]\d+\.\s*/, '').replace(/^\d+\.\s*/, ''));
                    }
                }
            }
            
            // If no insights were found, add default ones
            if (insights.length === 0) {
                insights.push(
                    "The topic demonstrates complex interconnections across multiple domains",
                    "Historical development reveals patterns that influence current understanding",
                    "Technical foundations are evolving rapidly, creating new opportunities",
                    "Economic and social dimensions are increasingly recognized as critical"
                );
            }
            
            // Limit to max 5 insights
            const limitedInsights = insights.slice(0, 5);
            
            // Generate HTML
            if (keyInsights) {
                keyInsights.innerHTML = limitedInsights.map(insight => `
                    <div class="bg-gray-100 dark:bg-gray-800 rounded-lg p-3 flex items-start">
                        <div class="text-primary mr-3 flex-shrink-0 mt-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="m9 18 6-6-6-6"></path>
                            </svg>
                        </div>
                        <p class="text-sm">${insight}</p>
                    </div>
                `).join('');
            }
        }
        
        function addTimelineStep(title, description, status) {
            if (!progressSteps) return;
            
            const stepIndex = progressSteps.children.length;
            const step = document.createElement('div');
            step.classList.add('timeline-step', 'relative', 'pl-8', 'pb-6');
            
            const statusIndicator = getStatusIndicator(status);
            const stepContent = `
                <div class="timeline-line"></div>
                <div class="absolute left-0 top-0">
                    ${statusIndicator}
                </div>
                <div class="mb-1 text-sm font-medium">${title}</div>
                <p class="text-xs text-gray-500 dark:text-gray-400 step-description">${description}</p>
            `;
            
            step.innerHTML = stepContent;
            progressSteps.appendChild(step);
        }
        
        function updateTimelineStep(index, title, description, status) {
            const steps = progressSteps.children;
            if (!steps[index]) return;
            
            const step = steps[index];
            
            // Update status indicator
            const statusIndicatorContainer = step.querySelector('.absolute');
            if (statusIndicatorContainer) {
                statusIndicatorContainer.innerHTML = getStatusIndicator(status);
            }
            
            // Update description
            const descriptionElement = step.querySelector('.step-description');
            if (descriptionElement) {
                descriptionElement.textContent = description;
            }
            
            // Update title if needed
            const titleElement = step.querySelector('.text-sm.font-medium');
            if (titleElement && title) {
                titleElement.textContent = title;
            }
        }
        
        function getStatusIndicator(status) {
            switch(status) {
                case 'waiting':
                    return `<div class="w-6 h-6 rounded-full flex items-center justify-center bg-gray-200 dark:bg-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-gray-500 dark:text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <path d="M12 6v6l4 2"></path>
                        </svg>
                    </div>`;
                case 'in-progress':
                    return `<div class="w-6 h-6 rounded-full flex items-center justify-center bg-primary bg-opacity-20">
                        <svg class="animate-spin h-3 w-3 text-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </div>`;
                case 'complete':
                    return `<div class="w-6 h-6 rounded-full flex items-center justify-center bg-green-100 dark:bg-green-900">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-green-600 dark:text-green-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M20 6 9 17l-5-5"></path>
                        </svg>
                    </div>`;
                case 'error':
                    return `<div class="w-6 h-6 rounded-full flex items-center justify-center bg-red-100 dark:bg-red-900">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-red-600 dark:text-red-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M18 6 6 18"></path>
                            <path d="m6 6 12 12"></path>
                        </svg>
                    </div>`;
                default:
                    return `<div class="w-6 h-6 rounded-full flex items-center justify-center bg-gray-200 dark:bg-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-gray-500 dark:text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <path d="M12 16v.01"></path>
                            <path d="M12 8v4"></path>
                        </svg>
                    </div>`;
            }
        }
        
        function updateProgress(percent, statusText) {
            if (progressBar) progressBar.style.width = `${percent}%`;
            if (progressPercentage) progressPercentage.textContent = `${percent}%`;
            if (currentStepLabel) currentStepLabel.textContent = statusText;
        }
        
        function updateElapsedTime() {
            if (!startTime) return;
            
            const elapsed = Date.now() - startTime;
            const minutes = Math.floor(elapsed / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            
            elapsedTime.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        function handleError(message, error) {
            console.error(`${message}:`, error);
            showError(`${message}: ${error.message || 'Unknown error'}`);
            
            // Reset UI
            startResearchBtn.disabled = false;
            startResearchBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.3-4.3"></path>
                </svg>
                Start Comprehensive Research
            `;
            isResearchInProgress = false;
            
            // Clear intervals
            if (elapsedTimeInterval) {
                clearInterval(elapsedTimeInterval);
                elapsedTimeInterval = null;
            }
            
            if (streamingInterval) {
                clearInterval(streamingInterval);
                streamingInterval = null;
            }
        }
        
        function showError(message) {
            showNotification(message, 'error');
        }
        
        function showNotification(message, type = 'info') {
            const notificationDiv = document.createElement('div');
            notificationDiv.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 animate-fade-in transition-opacity duration-500 ${
                type === 'error' ? 'bg-red-500 text-white' : 
                type === 'success' ? 'bg-green-500 text-white' : 
                'bg-blue-500 text-white'
            }`;
            
            const icon = type === 'error' ? `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="m15 9-6 6"></path>
                    <path d="m9 9 6 6"></path>
                </svg>
            ` : type === 'success' ? `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20 6 9 17l-5-5"></path>
                </svg>
            ` : `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="M12 16v.01"></path>
                    <path d="M12 8v4"></path>
                </svg>
            `;
            
            notificationDiv.innerHTML = `<div class="flex items-center">${icon}<span>${message}</span></div>`;
            
            document.body.appendChild(notificationDiv);
            
            setTimeout(() => {
                notificationDiv.classList.add('opacity-0');
                setTimeout(() => {
                    document.body.removeChild(notificationDiv);
                }, 500);
            }, 4000);
        }
    </script>

</body></html>
